/*! test 2014-05-20 17:54:21 */
function toFixed(number,fractionDigits){with(Math)return round(number*pow(10,fractionDigits))/pow(10,fractionDigits)}function addCommentTotal(a){var b=INTERFACE.isHost,a=a||0;if(b){var c=$(".ctd_data .ctd_georgia.color_05"),d=c.text();d=a,d>1e5&&(d=toFixed(d/1e5,0)+"<em>万+</em>"),c.text(d),c.attr("title",a)}else{var e=$(".ctd_controls .link_comment"),c=e.find("span");c.text(a)}$(".ctd_comments .ctd_comments_title span").html("("+a+")")}function addCommentNum(){var a=INTERFACE.isHost,b=0;if(a){var c=$(".ctd_data .ctd_georgia.color_05"),d=c.text();b=parseInt(c.attr("title"),10),b=isNaN(b)?0:b,b++,d=b,d>1e5&&(d=toFixed(d/1e5,0)+"<em>万+</em>"),c.text(d),c.attr("title",b)}else{var e=$(".ctd_controls .link_comment"),c=e.find("span");b=parseInt(c.text(),10),b=isNaN(b)?0:b,b++,c.text(b)}$(".ctd_comments .ctd_comments_title span").html("("+b+")")}function con_focus(a){var b=$(a),c=b.val(),d=c.length;if(b.focus(),document.selection)if(b[0].createTextRange){var e=b[0].createTextRange();e.moveStart("character",d),e.collapse(),e.select()}else b.focus();else"number"==typeof a.selectionStart&&"number"==typeof a.selectionEnd&&(a.selectionStart=a.selectionEnd=d)}function getreallen(a){return a.replace(/&nbsp;|\s|\t|\n|<(?!img).*?>/gi,"").length}function imgReadyObj(a,b,c,d){this.arrfn=[],this.intervalId=null,this.url=a,this.ready=b,this.load=c,this.error=d,this.inte()}function delImg(a){var b=($(".photo_progress ul li").length,$(".state_proccessing").find("span:first").text());$(".state_proccessing").find("span:first").text(b-1),INTERFACE.del_img($.toJSON({TravelId:INTERFACE.TravelId,ImageId:a})),setTimeout(function(){$(".photo_progress ul li[data-imgId="+a+"]").animate({opacity:.15,height:0},600,function(){$(this).remove(),toggleDet(swfu)})},300)}function toggleDet(a,b){var c=$(".photo_progress ul li").length;a.setButtonTextStyle(".redText { color: #666666; font-weight: bold; font-size: 14px; }"),0===c?(a.setButtonText("<span class='redText'>上传照片</span>"),$(".upload_btn").addClass("abs_btn"),$(".btn_center").hide().find(".state_proccessing").html(""),$(".upload_det").show(),b?$(".limit").css("color","red").html(b):$(".limit").css("color","#999").html("一次性传完照片，你的丰富行程将立即展现！")):(a.setButtonText("<span class='redText'>继续上传</span>"),$(".upload_btn").removeClass("abs_btn"),$(".btn_center").show(),$(".upload_det").hide(),b?$(".state_proccessing").css("color","red").html(b):$(".state_proccessing").css("color","#666"))}function format_data(a){var b=new Function("return "+a.replace(/(<script)+[^<>]*>[^\0]*(<\/script>)+/gm,""))();if("undefined"!=typeof b.error&&""==b.error)var c=b.data[0];return c}function checkResponse(a){var b=a.replace(/<script.*?script>/gi,"");b=$.parseJSON(b);var c=b.data[0],d=c.data;if("0"==d)return window.console&&console.log("图片服务端无数据返回！请确认服务器端口是否正确！"),0;if(0==imgIdArr.length)imgIdArr.push(d);else for(var e=0;e<imgIdArr.length;e++){if(imgIdArr[e]==d)return d;noRep=!0}return noRep&&(imgIdArr.push(d),noRep=!1),$.imgTotal=$.imgTotal-1,swfobject.getObjectById("photo_upload").setLimitTotal(500-$.imgTotal,$.imgTotal),INTERFACE.upload_success({TravelId:INTERFACE.TravelId,ImageId:d,ImageName:encodeURIComponent(c.fileName),ImageDate:c.shootTime,TravelDate:INTERFACE.TravelDate,POIId:c.poiId,POIType:c.poiType,DistrictId:c.districtId,POIContentId:INTERFACE.POIContentId}),d}function delete_img(a){if(0!=a){for(var b=0;b<imgIdArr.length;b++)imgIdArr[b]==a&&delete imgIdArr[b];$.imgTotal=$.imgTotal+1,swfobject.getObjectById("photo_upload").setLimitTotal(500-$.imgTotal,$.imgTotal),INTERFACE.del_img($.toJSON({TravelId:INTERFACE.TravelId,ImageId:a}))}}function webNext(a,b){var c=$("#step2_button");"0"==a?c.parent(".btn_center").hide():(c.parent(".btn_center").show(),"1"==b?c.removeClass("disable").removeAttr("disabled"):c.addClass("disable").attr("disabled","disabled"))}function mouseScroll(a){if(0==a){var b=function(){return $("#rightLine")[0]?null:$('<div id="rightLine"></div>')};$("html").css({overflow:"hidden","padding-right":16}).find("body").prepend(b()),$(".t_step_2").on("mouseover","#photo_upload",function(){$("html").css({overflow:"hidden","padding-right":16}).find("body").prepend(b())}).on("mouseout","#photo_upload",function(){$("html").css({overflow:"auto","padding-right":0}).find("#rightLine").remove()})}1==a&&($("html").css({overflow:"auto","padding-right":0}).find("#rightLine").remove(),$(".t_step_2").off("mouseover mouseout","#photo_upload"))}function filterBaiduEdit(a){return a=a.replace(/<script[^>]*?>[\s\S]*?<\/script>|<link.*?>|<style[^>]*?>[\s\S]*?<\/style>|<iframe.*?>[\s\S]*?<\/iframe>/gi,""),a=a.replace(/<pre.*?>|<\/pre>/gim,""),a=a.replace(/<\/(?!p|strong)[^>]*?>|<(?!img|p|strong|hr|br|\/)[^>]*?>/gi,""),a=a.replace(/<((?:img)|(?:p)|(?:strong)|(?:hr)|(?:br))[^>]*?>/gi,function(a){if(void 0==a)return"";var b=a;b=b.replace(/\s{1,}/g," "),b=b.replace(/[<'">]/g,"");var c=b.split(" "),d="",e=c[0].toLowerCase();switch(e){case"img":var f="";for(var g=1 in c){var h=c[g];if(-1!=h.indexOf("=")){var i=h.split("=");if("src"==i[0]){var j=[];for(g=1;g<i.length;g++)j.push(i[g]);f+=' src="'+j.join("=")+'"'}"phsid"==i[0]&&(f+=' phsid="'+i[1]+'"'),"cover"==i[0]&&(f+=' cover="selected" class="cover"'),"data-id"==i[0]&&(f+=' data-id="'+i[1]+'"'),d=e+f+" /"}}break;default:d=e}return d?d="<"+d+">":void 0})}$(function(){var a,b,c,d,e=function(a){return a.parents(".edit_trip").attr("id")};window.sortable_opt={tolerance:"pointer",items:"> .sort_ui",cursor:"move",delay:100,opacity:.7,placeholder:"poi_highlight",helper:function(a,b){var c=$(b).hasClass("on")?"on":"",d=$(b).find("i").attr("class"),e=$(b).find("p").text(),f=$(b).find("b").text();return $('<div id="drag-poi" class="'+c+'"><i class="'+d+'"></i><p>'+e+"</p><b>"+f+'</b><div class="arr_r"></div><div class="arr_t"></div></div>')},start:function(a,c){b=$(c.item).attr("id"),d=$(c.item).index()},stop:function(a,e){d!=$("#"+b).index()&&(c=void 0==$(e.item).next(".sort_ui").attr("id")?0:$(e.item).next(".sort_ui").attr("id"),INTERFACE.poi_sort_api($.toJSON({CurrentPoiContentId:$("#"+b).attr("data-travelcontentid"),PrePoiContentId:$("#"+c).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId})))}},$(".poi_box").sortable(window.sortable_opt).disableSelection(),window.sortable_p_opt={tolerance:"pointer",items:"> .t_photos",cursor:"move",placeholder:"img_highlight",helper:function(a,b){var c=$(b).siblings(".t_photos:hidden").removeClass("ui-selected").end().siblings(".ui-selected").add($(b));return $('<div id="drag-img"><div class="num">'+c.length+' 张</div><div class="mask"></div><img src="'+$(b).find("img").attr("src")+'" /></div>')},start:function(b,c){a=e($(c.item).addClass("ui-selected").data("one","one"));for(var d=$("#"+a).find(".ui-selected").attr("data-poi"),f=$("#"+a).find(".t_photos[data-poi="+d+"]"),g=[],h=0;h<f.length;h++)g.push(f.eq(h).attr("data-travelcontentid"));$("#"+a).data("imgAtt",d),$("#"+a).data("temp",g),$("#"+a).find(".ui-selected").each(function(){$(c.item).index()<$(this).index()?$(this).data("index",$(this).index()-1):$(this).data("index",$(this).index())}).find(".t_p_border").addClass("border_ccc")},sort:function(a,b){"one"==$(b.item).data("one")&&$(b.item).removeData("one").siblings(".ui-selected").each(function(){var a=$(this).find("img").hide().clone().addClass("clone_img").show().appendTo("#drag-img");a.css({top:$(this).offset().top-b.offset.top,left:$(this).offset().left-b.offset.left})}),$("#drag-img").find(".clone_img").each(function(){$(this).animate({top:0,left:0},300)})},stop:function(b,c){var d=$("#"+a);if(d.find(".t_photos img").show().end().find(".t_p_border").removeClass("border_ccc"),f)$(c.item).hide(),$.poi_state(f),f=!1;else{var e=$(c.item);$(c.item).siblings(".ui-selected").each(function(){var a=$(c.item).data("index"),b=$(this).data("index"),d=$(this).clone(!0).fadeIn(300);a>b?$(c.item).before(d):(e.after(d),e=e.next()),$(this).remove()}),d.find(".ui-selected").removeClass("ui-selected");for(var g=[],h=0,i=d.data("imgAtt"),j=d.find(".t_photos[data-poi="+i+"]"),k=d.data("temp"),l=0;l<j.length;l++){var m=j.eq(l).attr("data-travelcontentid");g.push(m),m!=k[l]&&(h=1)}h&&INTERFACE.img_addto_poi($.toJSON({ImageContentId:g,POIContentId:$("#"+i).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId}))}}},$(".photo_content").sortable(window.sortable_p_opt).disableSelection(),window.selectable_opt={filter:".t_photos",cancel:".breadbar, .gs-header, .cui_nav_single, .cui_hd, .footblue, .t_edit, .t_delete, .poi_dot, .photo_null, .add_photo, .t_process, .side_fixed, #add_day, #step3_button, #base_ft, #d_prompt, #poi_popup, .step_tips, .step_tips_box, #gs_operate_right_fix"},$("body").selectable(window.selectable_opt);var f;window.imgDrop=function(b,c){{var d=[],g=$(c.draggable),h=$(c.draggable).siblings(".ui-selected"),i=$(this).attr("id"),j=e($(this));$("#"+j).find(".poi_dot.on").attr("id")}if(f=g.attr("data-poi"),f==i)return f=!1,!1;var k=g.index();if(0==h.length)d.push(g);else for(var l=0;l<h.length;l++){var m=h.eq(l).index();m>k&&k>=0&&(d.push(g),k=-1),d.push(h.eq(l)),l==h.length-1&&g.index()>h.eq(h.length-1).index()&&d.push(g)}for(var n=[],l=0;l<d.length;l++){1==$(this).attr("data-unknown")?d[l].attr("data-unknown",1):d[l].removeAttr("data-unknown"),d[l].attr("data-poi",i).removeClass("ui-selected").hide().find(".t_p_show").hide();var o=d[l].attr("data-travelcontentid");n.push(o)}INTERFACE.img_addto_poi($.toJSON({ImageContentId:n,POIContentId:$("#"+i).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId})),$("#"+i).attr("data-text","+"+n.length).gspoptext({top:20,time:1500,css:{font:"bold 16px Arial",color:"red"}});var p=$("#"+f).find("b");p.text(parseInt(p.text())-d.length);var q=$("#"+i).find("b");if(q.text(parseInt(q.text())+d.length),0==q.text()&&$.poi_state(i),a!=j){for(var l=0;l<d.length;l++)$("#"+a).find(".t_photos img").show().end().find(".t_p_border").removeClass("border_ccc"),$("#"+j).find(".photo_null").before(d[l].clone(!0).fadeIn(300));$("#"+i).hasClass("on")?$("#"+j).find(".photo_null").hide():$("#"+i).trigger("click")}$.unknown_photo_num($(".t_step_3"))},window.droppable_opt={accept:".t_photos",hoverClass:"over",drop:window.imgDrop},$(".sort_ui").droppable(droppable_opt),$("img").lazyload({threshold:300}),$(".step_tips").click(function(){$(".step_tips_box").toggle().find(".step_tips_cont:first").show().siblings(".step_tips_cont").hide(),$.post(INTERFACE.CloseTravelTips,{},function(){})}),$(".step_tips_cont").find("input").click(function(){var a=$(this).parent();0==a.nextUntil().length?a.hide().siblings(".step_tips_cont:first").show():a.hide().next(".step_tips_cont").show()})});var doReply=function(){$(".ctd_comments_box").hover(function(){$(this).find(".ctd_comments_contrl .contrl_01").css("color","#999")},function(){$(this).find(".ctd_comments_contrl .contrl_01").css("color","#f2f2f2")}),$("[data-onsubmit]").each(function(){$(this).data("isOne",0)});var a=1e3;$(".ctd_comments .link_reply").click(function(){if(!$(this).hasClass("a_popup_login")){var a=$(this).parent().siblings(".ctd_comments_reply");if(a.is(":visible"))a.slideUp(200);else{a.slideDown(200),a.find("textarea").val("");var b=$(this).parents(".ctd_comments_box").find(".ctd_comments_username").text();b="@"+$.trim(b)+"\n",a.find("textarea").val(b),a.find("textarea").data("name",b),con_focus(a.find("textarea")[0])}}}),$(".ctd_comments .ctd_comments_reply .contrl_01").click(function(){return $(this).parent().slideUp(200),!1}),$(".ctd_comments_reply textarea").each(function(){var b=$(this);b.gsInputLen(function(c){var d=b.parents(".ctd_comments_reply"),e=d.find(".word_length"),f=a-c;if(-1>=f){var g=b.val(),h=$.gsSubstring(g,a,1);b.val(h)}else e.html(f);d.find(".error_tip").hide()})}),$(".ctd_comments_reply .gs_btn_v2").click(function(){var a=$(this).siblings(".textarea").find("textarea"),b=$(this).siblings(".error_tip");areaVal=$.trim(a.val());var c=$.trim(a.data("name")),d=areaVal.replace(c,""),e=a.attr("data-referenceCategory")||"",f=a.attr("data-referenceids")||"";d?$(this).gsdisable({callback:function(){INTERFACE.add_comment({TravelId:INTERFACE.TravelId,ReferenceIds:f,ReferenceCategory:e,RemarkContent:encodeURIComponent(areaVal)},function(){addCommentNum()})}}):b.show()})};$(function(){function a(){"0"==privateObject.CurrentUserId&&$.cookiedb({name:"gs_link_like",value:INTERFACE.TravelId})}function b(){if("0"==privateObject.CurrentUserId){var a=$.cookiedb({name:"gs_link_like",value:INTERFACE.TravelId,isfind:1});"repeat"==a&&($(".float_div .btn_like").addClass("click_like"),$(".ctd_controls .link_like").addClass("click_like"))}}function c(a){var b=$(a),c=$(".ctd_data .color_03"),d=c.text(),e=parseInt(c.attr("title"),10);e=isNaN(e)?0:e,e++,d=e,d>1e5&&(d=toFixed(d/1e5,0)),c.text(d),c.attr("title",e),b.html("<i></i>已自恋"),b.attr("title","已自恋")}var d=INTERFACE.isHost;$(".ctd_controls .link_collect").gsbasecollect({requestFn:function(a){$(".float_div .btn_collect").addClass("click_collect"),INTERFACE.collectRequestFn($(a))}}),$(".float_div .btn_collect").gsbasecollect({requestFn:function(a){var b=$(".ctd_controls .link_collect"),c=b.find("span"),d=parseInt(c.text(),10),d=isNaN(d)?0:d;d++,c.text(d),b.addClass("click_collect"),INTERFACE.collectRequestFn($(a))}}),b(),$(".ctd_controls .link_like").gsbaselike({requestFn:INTERFACE.likeRequestFn,callback:function(b){d?(c(b),$(".float_div .btn_like").addClass("click_like_host")):($(".float_div .btn_like").addClass("click_like"),a())}}),$(".float_div .btn_like").gsbaselike({requestFn:INTERFACE.likeRequestFn,callback:function(){var b=$(".ctd_controls .link_like");if(d)c(b),$(".float_div .btn_like").addClass("click_like_host");else{var e=b.find("span"),f=parseInt(e.text(),10);f=isNaN(f)?0:f,f++,b.html("<i></i>已喜欢<span>"+f+"</span>"),$(".float_div .btn_like").addClass("click_like"),a()}b.addClass("click_like")}}),$(".img_controls .link_like").gsbaselike({requestFn:INTERFACE.likeRequestFn,callback:function(a){var b=$(a);if(d){var c=b.find("span"),e=(c.text(),parseInt(c.attr("title"),10));e=isNaN(e)?0:e,e++,b.html("<i></i>已自恋<span>"+e+"</span>"),b.attr("title","已自恋")}}}),$(".ctd_controls .link_share").gsbaseshare({api:INTERFACE.ShareUrl,hasCount:!0,callback:function(){if(d){var a=$(".ctd_data .color_04"),b=a.text(),c=parseInt(a.attr("title"),10);c=isNaN(c)?0:c,c++,b=c,b>1e5&&(b=toFixed(b/1e5,0)),a.text(b),a.attr("title",c)}}}),$(".float_div .btn_share").gsbaseshare({api:INTERFACE.ShareUrl,fixed:!0,top:50,hasCount:!1,callback:function(){if(d){var a=$(".ctd_data .color_04"),b=a.text(),c=parseInt(a.attr("title"),10);c=isNaN(c)?0:c,c++,b=c,b>1e5&&(b=toFixed(b/1e5,0)),a.text(b),a.attr("title",c)}else{var e=$(".ctd_controls .link_share span"),c=parseInt(e.text(),10);c=isNaN(c)?0:c,c++,e.text(c)}}}),$(".img_controls .link_share").gsbaseshare({api:INTERFACE.ShareUrl});var e=null;$(".ctd_main").on("mouseenter",".img",function(){var a=$(this).data("isOver",1),b=a.find(".img_controls"),c=(a.outerWidth()-a.find("img").outerWidth())/2;c>267?b.css("visibility","hidden"):b.css("visibility","visible").fadeIn("fast"),b.fadeIn("fast"),$("#bdshare").hover(function(){a.data("isOver",0)},function(){a.data("isOver",1)})}),$(".ctd_main").on("mouseleave",".img",function(){function a(){1==b.data("isOver")&&b.children(".img_controls").fadeOut("fast")}clearTimeout(e);var b=$(this);e=setTimeout(a,50)})}),$(function(){!function(){var a=$("#report_area"),b=a.parents(".textarea_box").find(".error_tip");total=1e3,a.val(""),a.placeholder(),a.focus(function(){b.hide()});var c=a.next(".ctd_comments_tip").find("em.word_length");a.gsInputLen(function(b){var d=total-b;if(-1>=d){var e=a.val(),f=$.gsSubstring(e,total,1);a.val(f),c.text(total)}else c.text(b);$(".reportmain").find(".gsn-tiptext").show(),$(".reportmain").find(".journal-comment-tip").hide()}),$(".float_div .btn_comment").add(".ctd_controls .link_comment").click(function(){var b=$(".ctd_comments").offset().top-55;$("body,html").animate({scrollTop:b},500,function(){con_focus(a[0])})}),$(".ctd_comments_box .btn_publish").click(function(){if(!$(this).hasClass("a_popup_login")){var d=a.val();if(d=$.trim(d),d=d.replace("Hi，楼主等你的回复呢~","")){var e=a.attr("data-referencecategory")||"",f=a.attr("data-referenceids")||"";$(this).gsdisable({disable:"gs_btn_v2_gray",text:'<img class="btn_ajax" src="http://youresource.c-ctrip.com/img/load.gif" />提交中...',callback:function(){INTERFACE.add_comment({TravelId:INTERFACE.TravelId,ReferenceIds:f,ReferenceCategory:e,RemarkContent:encodeURIComponent(d)},function(){addCommentNum(),a.val(""),c.text("0")})}})}else b.show()}})}(),function(){var a=$("#picComment"),b=$("#pic_content"),c="",d="",e=a.find(".count"),f=parseInt(e.text(),10);$(".img_controls .link_comment").click(function(){if(a.find(".gsn-tiptext").show(),a.find(".journal-comment-tip").hide(),b.click(),!$(this).hasClass("a_popup_login")){$.popupbox.show({id:"picComment"}),c=$(this).attr("data-referenceCategory")||"",d=$(this).attr("data-referenceids")||"";var e=$("#authorDisplayName").html();e=$.trim(e);var f="引用 @"+e+" 的照片\n";b.val(f)}con_focus(b[0])}),b.gsInputLen(function(c){var d=f-c;if(-1>=d){var g=b.val(),h=$.gsSubstring(g,f,1);b.val(h)}else e.html(d);a.find(".gsn-tiptext").show(),a.find(".journal-comment-tip").hide()}),a.on("click",".close, .gsn-btn-6",function(){e.text(f),b.val(""),$.popupbox.close()}),a.on("click",".gsn-btn-2",function(){var g=b.val();g=$.trim(g),g?(a.find(".gsn-tiptext").show(),a.find(".journal-comment-tip").hide(),$(this).gsdisable({callback:function(){INTERFACE.add_comment({TravelId:INTERFACE.TravelId,ReferenceIds:d,ReferenceCategory:c,RemarkContent:encodeURIComponent(g)},function(){addCommentNum(),e.text(f),b.val(""),$.popupbox.close()})}})):(a.find(".gsn-tiptext").hide(),a.find(".journal-comment-tip").show())})}()}),function($){function getjson(a){var a=GS.xssFilter(a);$.getJSON(searchAPI,{para:escape($.trim(a))},function(b){if(0==b.success){var c=b.list,d=[];for(i in c){var e=null==c[i].districtname?"":" ,"+c[i].districtname,f=null==c[i].Address?"":c[i].Address;d.push('<a href="javascript:;" data-id="'+c[i].id+'" poi-type="'+c[i].type+'" data-name="'+c[i].name+'" data-districtid="'+c[i].districtid+'" data-districtname="'+c[i].districtname+'">'+c[i].name.replace(a,"<b>"+a+"</b>")+e+'<span class="addr">'+f+"</span></a>")}$(".select_address_inner").html("").append($(d.join(""))),$(".select_address_inner").find("a:first").addClass("on"),$(".select_address_inner").on("mouseover","a",function(){return $(this).addClass("on").siblings("a").removeClass("on"),!1}),selectPOI(),selectPOI_nodata(a)}poi_popup.find(".select_address").css($(".select_address_inner").height()>120?{"overflow-y":"scroll","overflow-x":"hidden"}:{"overflow-y":"hidden","overflow-x":"hidden"})})}function selectPOI_nodata(a){poi_popup.find(".c_address").show();var b='<a class="c_address" href="javascript:;">+ 没有可选的地点，点击创建“<span>'+a+"</span>”</a>",c=poi_popup.find(".select_address");"one"!=c.data("one")?c.append($(b)).data("one","one"):c.find(".c_address").show().find("span").html(a)}function selectPOI(){poi_popup.find(".select_address_inner a[data-id]").on("click",function(){var a=$.trim($(this).attr("data-name")),b=$(this).attr("data-districtid"),c="null"==$(this).attr("data-districtname")?null:$(this).attr("data-districtname"),d=$(this).attr("poi-type");if("1"!=d&&"2"!=d&&"3"!=d&&"5"!=d&&"4"!=d)$.ajax({url:INTERFACE.custom_tags_url,type:"POST",async:!1,dataType:"json",data:$.toJSON({TravelId:INTERFACE.TravelId,POIName:encodeURIComponent(a),POIType:poiType(),POITypeId:99}),success:function(d){var e=d.Data;setPOI(e,poiType(),a,!0,b,c)}});else{var e=$(this).attr("data-id"),f="4"==d?"destination":poiType();setPOI(e,f,a,!1,b,c)}$(this).remove(),poi_popup.find(".select_address").hide().siblings(".guess_address").show()})}function poiType(a){var b=a?a.attr("class"):poi_popup.find(".over i").attr("class");return poi_popup.data("type",searchType[b]),poi_popup.data("type")}function setPOI(a,b,c,d,e,f){if(poi_popup.find(".fr span").hide(),$("#poi_popup").data("poi_id"))$("#btnAddPoi").val(c).data("data",{dataId:a,dataType:b,dataName:c,customDefinition:d,districtid:e,districtname:f});else{var g=$('<div class="poi" poi-id="'+a+'" poi-type="'+b+'" poi-name="'+c+'" poi-custom="'+d+'" data-districtid="'+e+'" data-districtname="'+f+'"><a href="javascript:void(0);"></a>'+c+"</div>\r\n");$(".btnAddPoi").before(g.fadeIn(600)),$("#btnAddPoi").val("").focus().siblings("span").show()}}var poi_popup=$("#poi_popup"),searchAPI=$("#gs_search").val(),searchType={jingdian:"sight",gouwu:"shopping",zhusu:"hotel",canyin:"restuarant"};poi_popup.on("click","a.close",function(){$.popupbox.close(),searchAPI=searchAPI.replace(/sight|shopping|hotel|restuarant$/,"sight"),poi_popup.find(".poi").remove(),poi_popup.find(".select_address_inner").html(""),poi_popup.find(".fr span").hide(),$("#btnAddPoi").val("")}),poi_popup.on("click",".tab a",function(){searchAPI=searchAPI.replace(/sight|shopping|hotel|restuarant$/,poiType($(this).find("i"))),$(this).addClass("over").siblings().removeClass("over"),poi_popup.find(".guess_address_inner a").hide();var a=poi_popup.find(".guess_address_inner a."+$(this).find("i").attr("class"));0==a.length?poi_popup.find("h4").hide():(poi_popup.find("h4").show(),a.show()),poi_popup.find(".tab_arr").animate({left:125*$(this).index()},600),poi_popup.find(".select_address").hide().siblings(".guess_address").show(),poi_popup.find(".c_address").hide(),poi_popup.find(".btnAddPoi span").show(),$("#btnAddPoi").removeData("data").val("").focus()}),poi_popup.on("click",".guess_address a",function(){for(var a=poi_popup.find(".poi_address .poi"),b=0;b<a.length;b++)if(a.eq(b).attr("poi-id")==$(this).attr("data-id"))return $("#btnAddPoi").focus(),!1;var c=$(this).attr("data-id"),d=poiType($(this)),e=$.trim($(this).attr("data-name")),f=$(this).attr("data-districtid"),g="null"==$(this).attr("data-districtname")?null:$(this).attr("data-districtname");setPOI(c,d,e,!1,f,g),$(this).addClass("on")}),poi_popup.on("keyup paste","#btnAddPoi",function(a){var b=function(){var a=$("#btnAddPoi").removeData("data").val();""!=a?(getjson(a),$("#btnAddPoi").siblings("span").hide(),poi_popup.find(".select_address").show().siblings(".guess_address").hide()):($("#btnAddPoi").siblings("span").show(),poi_popup.find(".select_address").hide().siblings(".guess_address").show())};"keyup"==a.type?b():setTimeout(b,100)}),poi_popup.on("click",".c_address",function(){var a=$(this).hide().find("span").text();INTERFACE.custom_tags($.toJSON({TravelId:INTERFACE.TravelId,POIName:encodeURIComponent(a),POIType:poiType()}),function(a){var b=$(".c_address").find("span").text().replace(/"/g,"&quot;");setPOI(a.Data,poiType(),b,!0,null,null)}),poi_popup.find(".select_address").hide().siblings(".guess_address").show()}),poi_popup.on("click",".poi a",function(){for(var a=$(this).parent().attr("poi-id"),b=poi_popup.find(".guess_address_inner a"),c=0;c<b.length;c++)b.eq(c).attr("data-id")==a&&b.eq(c).removeClass("on");$(this).parent().remove(),$("#btnAddPoi").focus()}),poi_popup.on("click",".gsn-btn-2",function(){var edit_day_id=$("#poi_popup").data("edit_day_id"),poi_id=$("#poi_popup").data("poi_id");if(poi_id){if(""!=$("#btnAddPoi").val()){var poiData=$("#btnAddPoi").data("data");if(void 0==poiData)return poi_popup.find(".fr span").html("请从下拉提示中选中拍摄地点").show(),$("#btnAddPoi").focus(),!1;$.popupbox.close();var POIInfo={POIId:poiData.dataId,POIType:poiData.dataType,POIName:encodeURIComponent(poiData.dataName),IsCustomDefinition:poiData.customDefinition,DistrictId:poiData.districtid,DistrictName:encodeURIComponent(poiData.districtname)};INTERFACE.editor_poi($.toJSON({POIInfo:POIInfo,ContentId:$("#"+poi_id).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId}));var title=poiData.dataName+(null==poiData.districtname?"":" ,"+poiData.districtname),type="";switch(poiData.dataType){case"sight":type="jingdian";break;case"destination":type="jingdian";break;case"shopping":type="gouwu";break;case"hotel":type="zhusu";break;case"restuarant":type="canyin"}poi_popup.find(".fr span").hide(),$("#"+poi_id).removeAttr("data-unknown").attr("title",title).find("p").text(poiData.dataName).siblings("i").attr("class",type);var poi_img=$("#"+edit_day_id).find('.t_photos[data-poi="'+poi_id+'"][data-unknown="1"]'),inputVal=$("#"+edit_day_id).find(".day_date input").val(),poicontentid=$("#"+poi_id).attr("data-travelcontentid");0!=poi_img.length?(poi_img.removeAttr("data-unknown"),$.unknown_photo_num($(".t_step_3"))):($("#"+edit_day_id).find(".photo_null").html(0!=$("#"+edit_day_id).find(".t_photos").length?'<i></i><span>请拖动照片进行关联，或</span><a href="#">添加照片</a>':'<i></i><span>这一天没有照片，请</span><a href="#">添加照片</a>'),$("#"+edit_day_id).find(".photo_null a").attr("href",writetravelajax.AddPotoUrl+inputVal+"&poicontentid="+poicontentid+"&poiid="+poi_id+"&dayid="+edit_day_id))}else poi_popup.find(".fr span").html("拍摄地点不能为空").show(),$("#btnAddPoi").focus();return $("#btnAddPoi").removeData("data")}var PoiList=[];poi_popup.find(".poi").each(function(){var a={POIId:$(this).attr("poi-id"),POIType:$(this).attr("poi-type"),POIName:encodeURIComponent($(this).attr("poi-name")),IsCustomDefinition:$(this).attr("poi-custom"),DistrictId:$(this).attr("data-districtid"),DistrictName:encodeURIComponent($(this).attr("data-districtname"))};PoiList.push(a)}),PoiList[0]?($.popupbox.close(),searchAPI=searchAPI.replace(/sight|shopping|hotel|restuarant$/,"sight"),INTERFACE.add_new_poi($.toJSON({PoiList:PoiList,ScheduleId:edit_day_id.replace("day",""),TravelId:INTERFACE.TravelId}),function(data){var data=eval(data),dom=[];if(data){for(var i=0;i<data.length;i++){var typeName="";switch(data[i].PoiInfo.POIType){case 3:typeName="jingdian";break;case 4:typeName="jingdian";break;case 5:typeName="gouwu";break;case 1:typeName="zhusu";break;case 2:typeName="canyin"}dom.push('<div id="'+data[i].PoiInfo.TravelPOIId+'" class="poi_dot sort_ui" data-text="+1" data-travelcontentid="'+data[i].TravelContentId+'" title="'+data[i].PoiInfo.POIName+(null==data[i].PoiInfo.DistrictName?"":" ,"+data[i].PoiInfo.DistrictName)+'">'),dom.push('<i class="'+typeName+'"></i>'),dom.push("<p>"+data[i].PoiInfo.POIName+"</p>"),dom.push("<b>0</b>"),dom.push('<a class="t_edit" title="修改拍摄地点" href="javascript:void(0);"></a>'),dom.push('<a class="t_delete" title="删除" href="javascript:void(0);"></a>'),dom.push('<div class="arr_r"></div>'),dom.push("</div>")}var edit_day_id=$("#poi_popup").data("edit_day_id"),dayFrame=$("#"+edit_day_id);dayFrame.find(".add_poi").before($(dom.join("")).fadeIn(600)),dayFrame.find(".sort_ui").droppable(window.droppable_opt),dayFrame.find(".poi_box").sortable(window.sortable_opt).disableSelection()}else alert("错误异常")})):poi_popup.find(".fr span").html(""!=$("#btnAddPoi").focus().val()?"请从下拉提示中选中拍摄地点":"请先添加拍摄地点").show()}),$.reset_poi_popup=function(){poi_popup.find(".select_address").hide().siblings(".guess_address").show().find("h4").show(),poi_popup.find(".tab a").eq(0).addClass("over").siblings().removeClass("over"),poi_popup.find(".select_address_inner,.guess_address_inner").html(""),poi_popup.find(".tab_arr").css("left",0),poi_popup.find(".c_address").hide(),poi_popup.find(".poi").remove(),$("#btnAddPoi").removeData("data").val("").siblings("span").text("可添加多个拍摄地点").show()}}(jQuery),function(a){function b(){e.find("input").focus().val("");var b=f.find(".over");if(b.length>0){for(var g=b.find(".search_city").text()+"，"+b.find(".search_country").text(),h=b.attr("data-id"),i=c.find(".dest"),j=0;j<i.length;j++)if(h==i.eq(j).attr("data-id"))return f.html("<em>您已添加过该城市</em>").show(),!1;d.find(".add_dest").before(a('<a class="dest selected" data-id="'+h+'" href="javascript:;"><i></i>'+g+"</a>").fadeIn()),f.html("").hide();var k=c.outerHeight();c.css("margin-top",0-k/2),d.find(".dest").length>=12&&(d.find(".add_dest, .search_dest").hide(),d.find(".error_tip").text("您已经添加了足够的目的地").show())}}var c=a("#publish_popup"),d=c.find(".ttd");a(".submit_pop").click(function(){var b=this;1!=c.data("hasClick")&&(c.data("hasClick",1),INTERFACE.classified_info(function(c){var e="";if("1"==a(b).attr("data-release")){d.data("rel",1);for(var f=0;f<c.DistrictList.length;f++){var g=c.DistrictList[f].IsSelected?' selected"><i></i>':'">';e+='<a href="javascript:;" data-id="'+c.DistrictList[f].DistrictId+'" class="dest'+g+c.DistrictList[f].DistrictName+"</a>"}}else{d.data("rel",0);for(var f=0;f<c.TagList.length;f++){var g=c.TagList[f].IsSelected?' selected"><i></i>':'">';e+='<a href="javascript:;" class="dest'+g+c.TagList[f].TagName+"</a>"}}d.prepend(e);var h=0==c.PracticalInfo.TravelDays?"":c.PracticalInfo.TravelDays,i=a("#tpi_who_select").find("a[data-id="+c.PracticalInfo.CompanionType+"]").text(),j=0==c.PracticalInfo.Consume?"":c.PracticalInfo.Consume,k=c.PracticalInfo.DepartureDate;a("#tpi_day").val(h).data("val",h),a("#tpi_who").val(i).data("val",c.PracticalInfo.CompanionType),a("#tpi_cost").val(j).data("val",j),a("#tpi_time").val(k).data("val",k),"1"==a(b).attr("data-release")?d.find(".dest").length>=12?(d.find(".add_dest, .search_dest").hide(),d.find(".error_tip").text("您已经添加了足够的目的地").show()):(d.find(".add_dest").show(),d.find(".search_dest, .error_tip").hide()):d.find(".selected").length>=10?d.find(".error_tip").text("最多可以添加10个分类标签").show():d.find(".error_tip").hide()})),a.popupbox.show({id:"publish_popup",callback:function(){a(".search_dest").find("input").add("#tpi_who, #tpi_time").placeholder(),1==c.data("hasClick")&&d.find(".search_dest, .error_tip").hide()}})}),c.on("click",".close, .cancel",function(){a.popupbox.close()}),c.on("click",".dest",function(){a(this).hasClass("selected")?a(this).removeClass("selected").find("i").remove():a(this).addClass("selected").prepend("<i></i>")});var e=a(".search_dest"),f=a("#search_select"),g=a("#gs_search").val();d.find(".add_dest").click(function(){d.find(".error_tip").hide(),a(this).add(f).hide(),e.show().find("input").focus().val("")}),d.find(".cancel_dest").click(function(){d.find(".add_dest").show(),e.hide()}),f.on("mouseover","a",function(){a(this).addClass("over").siblings().removeClass("over")}).on("click","a",function(){return b(),!1}),e.find("input").blur(function(){1!=f.data("isHover")&&f.html("").hide()}),f.hover(function(){f.data("isHover",1)},function(){f.data("isHover",0)}),e.on("keyup beforepaste ","input",function(b){if(40==b.keyCode||38==b.keyCode||13==b.keyCode)return!1;var c=GS.xssFilter(e.find("input").val());return/\S/g.test(c)?void a.getJSON(g,{para:escape(a.trim(c))},function(a){if(0==a.success){var b=a.destinations,c=[];if(0==a.destinations.length)return f.html("<em>请输入正确的城市名</em>").show(),!1;for(i in b){var d=b[i].name.split("，")[0],e=b[i].name.split("，")[1];c.push('<a data-id="'+b[i].id+'" href="javascript:;"><span class="search_city" title="'+d+'">'+d+'</span>，<span class="search_country" title="'+e+'">'+e+"</span></a>")}f.html(c.join("")).show().find("a:first").addClass("over")}else window.console&&console.log("搜索接口无数据返回，请检查接口配置！")}):(f.html("").hide(),!1)}),e.on("keydown","input",function(a){if(40==a.keyCode||38==a.keyCode){var c=f.find("a");if(0==c.length)return!1;if(c.hasClass("over")){var d=f.find(".over");d.prev("a").is(":first")&&38==a.keyCode?c.last().addClass("over"):d.next("a").is(":last")&&40==a.keyCode?c.first().addClass("over"):38==a.keyCode?d.prev("a").addClass("over"):d.next("a").addClass("over"),d.removeClass("over")}else 38==a.keyCode?c.last().addClass("over"):c.first().addClass("over");return!1}return 13==a.keyCode?(b(),!1):void 0}),a("#tpi_day, #tpi_cost").keyup(function(){/\D|^0+/g.test(a(this).val())&&a(this).val(""),a(this).data("val",a(this).val())});var h=a("#tpi_who"),j=a("#tpi_who_select");h.focus(function(){j.show()}).blur(function(){1!=j.data("isHover")&&j.hide()}),j.find("a").click(function(){h.val(a(this).text()).css("color","#666").data("val",a(this).attr("data-id")),j.hide()}),j.hover(function(){j.data("isHover",1)},function(){j.data("isHover",0)});var k=a("#tpi_time");k.click(function(){k.calendar({foretime:"no",callback:function(){var a=k.val(),b=a.match(/-[\d]{1}\b/g);if(null!=b)for(var c=0;c<b.length;c++){var d=b[c].replace("-","-0");a=a.replace(/-[\d]{1}\b/,d)
}k.val(a).css("color","#666").data("val",a)}}).focus()}),a("#publish_submit").click(function(){var b=0==d.find(".selected").length&&1==d.data("rel"),e=new Date(k.val().replace(/-/g,"/"))>new Date;if(b||e)return b?d.find(".error_tip").text("请至少选择1个目的地").show():d.find(".error_tip").hide(),e?a(".tpi_time").find(".error_tip").text("不能选择当天之后日期").show():a(".tpi_time").find(".error_tip").hide(),!1;c.find(".error_tip").hide();var f=a(this),g=[],h=[];if(1==d.data("rel"))d.find(".selected").each(function(){g.push({DistrictId:a(this).attr("data-id"),DistrictName:a(this).text(),IsSelected:!0})});else{var i=d.find(".selected").length;if(i>10)return d.find(".error_tip").text("最多可以添加10个分类标签").show(),!1;d.find(".selected").each(function(){h.push({TagName:a(this).text(),IsSelected:!0})})}var j=""==a("#tpi_day").data("val")?0:a("#tpi_day").data("val"),l=a("#tpi_who").data("val"),m=""==a("#tpi_cost").data("val")?0:a("#tpi_cost").data("val"),n=a("#tpi_time").data("val"),o={TravelDays:j,CompanionType:l,Consume:m,DepartureDate:n};INTERFACE.UpdateTravelExtraInfo({DistrictList:g,TagList:h,PracticalInfo:o},function(){1==d.data("rel")&&a.post(INTERFACE.ReleaseTravel,{travelId:INTERFACE.TravelId,stepNo:100},function(b){b&&b.RetCode&&1==b.RetCode?window.location.href=INTERFACE.GoToNextStep+"&score="+b.Html:a.gs_alert({text:"发表游记失败，请重试！"})}),f.gsdisable({disable:"gs_btn_v4 gsn-btn-20-load",time:2e4,text:'<img class="btn_ajax" src="http://youresource.c-ctrip.com/img/load.gif" alt="...">正在提交',callback:function(){}})})})}(jQuery),function($){function coverAdaptive(){$(".ctd_head_mask").width(document.documentElement.clientWidth);var a=$(".ctd_cover").css("width","100%"),b=new Image;b.src=a.attr("src"),$.browser.msie?b.onreadystatechange=function(){("complete"==b.readyState||"loaded"==b.readyState)&&coverAdaptiveCall(a)}:b.onload=function(){1==b.complete&&coverAdaptiveCall(a)}}function coverAdaptiveCall(a){var b=a.height(),c=parseInt(a.attr("data-CoverLocationY"))/1e4*b;b+c>450&&a.css({width:"100%",height:"auto",top:c})}function coverTurn(a){var b=a?ttdObjUl.find("li:visible").prev():ttdObjUl.find("li:visible").next();1==ttdObj.data("moveAble")&&(ttdObj.data("moveAble",0),$.browser.msie&&"6.0"==$.browser.version?(b.siblings("li").hide(),b.show(0,judgeDisable)):(b.siblings("li").fadeOut(300),b.fadeIn(300,judgeDisable)))}function judgeDisable(){var a=ttdObjUl.find("li:visible"),b=a.index(".ctd_ttd li")+1;ttdObj.find(".ctd_ttd_ctrl a").removeClass("disable"),ttdObj.find(".ctd_ttd_ctrl span").html(b+"/"+ttdObj.find(".ctd_ttd li").length),a.is(".ctd_ttd li:last")&&ttdObj.find(".ctd_ttd_ctrl .next").addClass("disable"),a.is(".ctd_ttd li:first")&&ttdObj.find(".ctd_ttd_ctrl .prev").addClass("disable"),ttdObj.data("moveAble",1)}function scrollEvents(){var a=$(window).scrollTop();clearTimeout(timer),timer=setTimeout(function(){pDotResize($(".progress_bar").data("imgShow"))},500),floatDivPosition(a),ttdObjFixed(a)}1!=INTERFACE.isHost&&INTERFACE.accessState(function(data1,data2){var visitCount=data2.VisitCount,zeroNull=function(a){return 0==a&&(a=""),a},toFixed=function(number,fractionDigits){with(Math)return round(number*pow(10,fractionDigits))/pow(10,fractionDigits)};if(visitCount>1e5&&(visitCount=toFixed(visitCount/1e4,0)+"万+"),$(".link_browse").find("span").text(zeroNull(visitCount)),$(".link_comment").find("span").text(zeroNull(data2.CommentCount)),$(".ctd_comments_title").find("span").text("("+data2.CommentCount+")"),$(".link_share").find("span").text(zeroNull(data2.ShareCount)),$(".link_like").find("span").text(zeroNull(data2.LikeCount)),$(".link_collect").find("span").text(zeroNull(data2.FavouriteCount)),1==data2.CanDownLoadPDF&&$(".link_pdf").attr("href",data2.DownLoadPDFUrl),$.ifPdfVisible(),0==data1.RetCode)return!1;var userName=data1.UserInfo.DisplayName,userUrl=data1.UserInfo.HomePageUrl,userSrc=data1.UserInfo.HeadPhotoUrl,userState='<a class="img" title="'+userName+'" target="_blank" href="'+userUrl+'"><img src="'+userSrc+'"></a>';(1==data1.RetCode||2==data1.RetCode)&&($(".a_popup_login").removeClass("a_popup_login"),$(".ctd_comments_box:first").append(userState),2==data1.RetCode&&$(".ctd_bread").prepend('<a class="ctd_head_a" href="'+data1.TravelMasterUrl+'"><i class="edit"></i>编辑游记</a>'))}),coverAdaptive(),$.browser.msie&&$.browser.version<9&&$(".badge_box").addClass("hack_ie8"),$(".ctd_head_right").on("mouseover",".info_badge a",function(){var a=$(this).attr("class"),b=$(this).offset(),c=$(".badge_box."+a),d=c.outerWidth(),e=c.outerHeight(),f=($(this).parent(".info_badge").offset(),$(this).parents(".ctd_head_right").offset());c.css({top:b.top-f.top-e-16,left:b.left-f.left-d/2+11}).show();var g=document.documentElement.clientWidth,h=c.offset().left,i=h+d,j=b.left-f.left-d/2+11+g-i;i>g?$(".badge_box."+a).css("left",j).find(".badge_box_arr").css("margin-left",i-g-67):$(".badge_box."+a).find(".badge_box_arr").css("margin-left","-67px")}).on("mouseout",".info_badge a",function(){var a=$(this).attr("class");$(".badge_box."+a).hide()}),$(".ctd_head_right").on("mouseover",".badge_box",function(){$(this).show()}).on("mouseout",".badge_box",function(){$(this).hide()});var floatDiv=$(".float_div"),ttdObj=$("#ctd_ttd_tab"),sideObj=$(".ctd_side"),toObj=$(".ctd_main_body"),toTop=toObj.offset().top,titileWidth=1==$(".ttd_title").length?$(".ttd_title").outerWidth():0,offsetLeft=$(".btn_index").outerWidth()+titileWidth,offsetRight=$(".item_div:first").outerWidth()*$(".item_div").length,ttdObjFixed=function(a){if(0==ttdObj.length)return!1;var b=ttdObj.outerHeight(),c=sideObj.outerHeight(),d=$("#ctd_ttd_stop").offset().top;a>sideObj.offset().top+c&&d-80-b>=a?ttdObj[0].style.cssText="position:fixed;top:70px;left:"+sideObj.offset().left+";":a<sideObj.offset().top+c?ttdObj[0].style.cssText="":a>d-80-b&&(ttdObj[0].style.cssText="position:absolute;top:"+(d-sideObj.offset().top-b-70)+"px;right:0;")},floatDivPosition=function(a){var b=toObj.outerHeight()-50,c=(a-toTop)/b*100;floatDiv.width(document.documentElement.clientWidth<=980?980:"100%"),$(".progress_line").find(".line").width(c+"%").siblings(".point").css("left",c-.85+"%"),a>toTop+b&&$(".progress_line").find(".line").css("width","100%"),a>=toTop?floatDiv.show():floatDiv.hide()},pDotResize=function(){$(".ctd_content").each(function(){var a=this,b=$(a).index(".ctd_content"),c=($(a).offset().top-toObj.offset().top)/toObj.outerHeight()*100-.7+"%";if(1!=$(a).data("hadP")&&b>0){$(a).data("hadP",1);var d=$(a).find("h3").text().replace("编辑","");$(".progress_line").append('<p class="p_content_'+b+'" style="left:'+c+';"><i></i><span>'+d+"<em></em></span></p>")}else b>0&&$(".p_content_"+b).css("left",c)})};if(1==ttdObj.length){ttdObj.on("mouseover",".fl",function(){$(this).css("background-color","#fff")}).on("mouseout",".fl",function(){$(this).css("background-color","transparent")}),$.phBackground=function(){var a=$(".ctd_ttd_box"),b=0,c=0;a.each(function(){$(this).find(".fl").length>c&&(c=$(this).find(".fl").length,b=$(this).attr("data-districtId")),$(this).find(".fl").length>0&&$(this).parent("li").css("background","none")}),b>0&&a.each(function(){if($(this).attr("data-districtId")==b){$(this).parent("li").show();var c=a.index(this);$(".ctd_ttd_ctrl span").text(c+1+"/"+a.length),0==c?$(".ctd_ttd_ctrl .prev").addClass("disable"):$(".ctd_ttd_ctrl .prev").removeClass("disable"),c==a.length-1?$(".ctd_ttd_ctrl .next").addClass("disable"):$(".ctd_ttd_ctrl .next").removeClass("disable")}else $(this).parent("li").hide()})};var ttdObjUl=ttdObj.find(".ctd_ttd");ttdObjUl.find("li").length>1&&ttdObj.find(".ctd_ttd_ctrl").show(),ttdObj.data("moveAble",1).find(".ctd_ttd_ctrl a").click(function(){return $(this).hasClass("disable")||($(this).hasClass("prev")&&coverTurn(1),$(this).hasClass("next")&&coverTurn(0)),!1})}$(".progress_bar").css({"margin-left":offsetLeft,"margin-right":offsetRight}).data("imgShow",1);var clickTime=null;if(floatDiv.on("mouseover",".progress_line p",function(){$(this).find("span").show()}).on("mouseout",".progress_line p",function(){$(this).find("span").hide()}).on("click",".progress_line p",function(){if(0!=$(".progress_line").data("isClick")){$(".progress_line").data("isClick",0);var a=parseInt($(this).attr("class").replace("p_content_","")),b=$(".ctd_content").eq(a).offset().top-50;$("html, body").animate({scrollTop:b},500),clearTimeout(clickTime),clickTime=setTimeout(function(){$(".progress_line").data("isClick",1)},600)}}),$.browser.msie&&"6.0"==$.browser.version)$(window).resize(function(){coverAdaptive()});else{var timer=null;$(function(){setTimeout(function(){pDotResize($(".progress_bar").data("imgShow")),floatDivPosition($(window).scrollTop())},500)}),$(window).scroll(function(){scrollEvents()}),$(window).resize(function(){coverAdaptive(),scrollEvents()})}$(".ctd_controls .fl, .text_pic").on("click",function(){var a=$(".ctd_content").find(".img, img"),b=$(this).is(".text_pic");a.is(":visible")?(b?$(".ctd_controls .fl").html("<i></i>图文模式"):$(this).html("<i></i>图文模式"),$(".ctd_controls .fl, .text_pic").addClass("clicked").attr("title","图文模式"),a.hide(),$(".progress_bar").data("imgShow",0)):(b?$(".ctd_controls .fl").html("<i></i>只看文字"):$(this).html("<i></i>只看文字"),$(".ctd_controls .fl, .text_pic").removeClass("clicked").attr("title","只看文字"),a.show(),$(".progress_bar").data("imgShow",1)),$.browser.msie&&"6.0"==$.browser.version||(pDotResize($(".progress_bar").data("imgShow")),floatDivPosition($(window).scrollTop()))});var popObj=$("#del_comment");$(".ctd_comments").on("click",".link_delete",function(){var a=$(this).attr("data-replyId"),b=$(this).offset();return"none"==popObj.css("display")?popObj.show().offset({top:b.top-popObj.outerHeight()-3,left:b.left-popObj.outerWidth()+28}).data("replyId",a):popObj.hide(),!1}),popObj.hover(function(){popObj.data("isHover",1)},function(){popObj.data("isHover",0)}).find(".confirm, .color_white").click(function(){$(this).hasClass("confirm")&&INTERFACE.del_reply({replyId:popObj.data("replyId")}),popObj.hide()}),$(document).click(function(){0==popObj.data("isHover")&&popObj.hide()}),$(".ctd_travels").on("mouseover",".img",function(){$(this).find(".text").show()}).on("mouseout",".img",function(){$(this).find(".text").hide()}),$.pageLinkJump=function(a){INTERFACE.page_link({pageNum:a})},$(".ctd_comments").on("click",".pager_v1 a:not(.gopage)",function(){var a=$(this).attr("data-page");"0"!=a&&INTERFACE.page_link({pageNum:a})})}(jQuery),$(function(){function a(){"0"==privateObject.CurrentUserId&&$.cookiedb({name:"gs_link_like",value:INTERFACE.TravelId})}function b(){if("0"==privateObject.CurrentUserId){var a=$.cookiedb({name:"gs_link_like",value:INTERFACE.TravelId,isfind:1});if("repeat"==a){$(".top_inbox .btn_like").addClass("click_like").text("已喜欢").attr("title","已喜欢");var b=$(".titlebox .titleright .link_like");b.addClass("click_like").attr("title","已喜欢")}}}function c(a){var b=$(".top_article .des-area");if(b.find("a.first").length||b.append('<a href="/" target="_blank" class="first">攻略社区</a>'),a){var c=a.des,d=a.desLink,e=a.poi,f=a.poiLink,g="";b.find(".first").nextAll().remove(),c&&(g+="<i>/</i>",g+=d?'<a target="_blank" href="'+d+'">'+c+"</a>":"<span>"+c+"</span>"),e&&(g+="<i>/</i>",g+=f?'<a target="_blank" href="'+f+'">'+e+"</a>":"<span>"+e+"</span>"),b.find(".first").after(g)}else 1!==b.find("a").length&&b.find(".first").nextAll().remove()}function d(){function a(a){return p>=a}function b(){o=$(window).scrollTop(),0==s&&(j.each(function(){r.push($(this).offset().top)}),u=r.length-1,maxLastPos=r[u]+j.eq(u).height()-n,s++),o>maxLastPos?GS.throttle(f(),500):GS.throttle(g(o),500)}function d(b){var c=b.index(),d=poiList[c].title,e=poiList[c].name,f=poiList[c].top,g=poiList[c].len,h=0;if(g){l.find(".name-area").empty();for(var i='<div class="mask"></div>';g>h;h++){var j=e[h],k=d[h];i+='<a href="javascript:;" title="'+k+'">'+j+"</a>",h!=g-1&&(i+='<i class="arrow">&gt;</i>')}l.find(".name-area").append(i);var o=m+b.offset().top-t.offset().top,p=b.width(),q=b.offset().left+p;if(l.css({top:o,left:q}),l.show(),l.data("show",1),l.data("dayNum",c),b.hasClass("current")){var r=f.filter(a),s=r.length;if(s>0){var u=f.indexOf(r[s-1]);l.find("a").removeClass("current"),l.find("a").eq(u).addClass("current")}}else l.find("a").removeClass("current");l.find("a").unbind().bind("click",function(){var a=l.find("a").index($(this)),b=f[a]-n+50;$("body,html").animate({scrollTop:b},800)})}}function e(){l.data("show")?clearTimeout(v):l.hide()}function f(){t.hide(),l.data("show",0),l.hide();var a={};c(a)}function g(b){t.show(),p=b+n;var d=r.filter(a),e=d.length;if(e>0){var f=r.indexOf(d[e-1]),g=j.length,o=showNum-1;if(f>-1){if(o>=f?-f>=h&&(h=-f):f>o&&g-o>f?-f>h?h=-f:h>o-f&&(h=o-f):f>=g-o&&h>o-f&&(h=o-f),0>=h){var s=h*i;k.css({top:s})}var u=showNum-g,v=q.eq(f);v.addClass("current").siblings().removeClass("current"),g>showNum&&(0===h?($upbtn.fadeOut(200),"none"==$downbtn.css("display")&&$downbtn.fadeIn(200)):h===u?($downbtn.fadeOut(200),"none"==$upbtn.css("display")&&$upbtn.fadeIn(200)):("none"==$downbtn.css("display")&&$downbtn.fadeIn(200),"none"==$upbtn.css("display")&&$upbtn.fadeIn(200)));var w=poiList[f],x=w.len,y=l.data("show"),z=l.data("dayNum"),A=w.top,B=A.filter(a),e=B.length,C=A.indexOf(B[e-1]),D={};if(C>=0&&(D.des=w.destination[C],D.desLink=w.desLink[C],D.poi=w.name[C],D.poiLink=w.link[C]),c(D),x&&y&&f===z&&e){l.find("a").removeClass("current"),l.find("a").eq(C).addClass("current");var E=m+v.offset().top-t.offset().top,F=parseInt(l.css("top"),10);E!==F&&l.css({top:E})}else l.find("a").removeClass("current")}}}var h=0,i=0,j=$(".daybox .dayframe"),k=$(".daylinkbox ul");showNum=5,$upbtn=$(".daylink .upbtn"),$downbtn=$(".daylink .downbtn"),poiList=[];var l=$("#showPoi"),m=$(".titlebox ").offset().top+$(".titlebox ").outerHeight()+10;$(".daylink").css({top:m,display:"block"});var n=m+50;!function(){function a(){$(".daylink li.current").index();b>showNum&&0!==h&&$upbtn.show(),b>showNum&&h!==u&&$downbtn.show()}var b=j.length,c=null,d=0;for($upbtn.hide(),$downbtn.hide();b>d;d++){var e=j.eq(d),f=e.attr("id");f=f.substring(1,f.length),id=parseInt(f,10);var g="";g=d>0?'<li><a href="javascript:;" data-id="#d'+id+'">'+id+"</a></li>":'<li class="current"><a href="javascript:;" data-id="#d'+id+'">'+id+"</a></li>";var m=$(g);f.length>3?m.find("a").css({"font-size":"16px"}):f.length>2&&m.find("a").css({"font-size":"20px"}),k.append(m);var n=e.find(".singledes"),o=[],p=[],q=[],r=[],s=[],t=[];n.each(function(){var a=$(this),b=$.trim(a.find("h3").text()),c=a.offset().top-40,d=a.find("h3").attr("data-destination")||"",e=$.trim(a.find("h3").attr("data-destination-href")),f=$.trim(a.find("h3 a").attr("href"));d=$.trim(d),b=b.replace(/\'|\"/g,""),o.push(b);var g=b.replace(/\s/gi,"x").replace(/[^x00-xff]/g,"xx");g.length>50&&(b=$.gsSubstring(b,25,1)+"..."),p.push(b),q.push(c),r.push(d),s.push(e),t.push(f)}),poiList.push({name:p,top:q,len:n.length,destination:r,link:t,desLink:s,title:o})}i=k.find("li").outerHeight();var u=showNum-b;0===l.length&&(l=$('<div id="showPoi" class="show-poi"><div class="join-side"></div><div class="name-area"></div></div>'),l.appendTo(document.body)),$upbtn.click(function(){if(clearTimeout(c),b>showNum&&0>h){h+=1;var a=h*i;k.animate({top:a},150)}0===h&&$upbtn.fadeOut(200),"none"==$downbtn.css("display")&&$downbtn.fadeIn(200)}),$downbtn.click(function(){if(clearTimeout(c),b>showNum&&h>u){h-=1;var a=h*i;k.animate({top:a},150)}h===u&&$downbtn.fadeOut(200),"none"==$upbtn.css("display")&&$upbtn.fadeIn(200)}),c=setTimeout(a,10)}();var o,p=0,q=$(".daylink li"),r=[],s=0,t=$(".daylink"),u=maxLastPos=0;"filter"in Array.prototype||(Array.prototype.filter=function(a,b){for(var c,d=[],e=0,f=this.length;f>e;e++)e in this&&a.call(b,c=this[e],e,this)&&d.push(c);return d}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(a,b){void 0===b&&(b=0),0>b&&(b+=this.length),0>b&&(b=0);for(var c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1}),b(),q.click(function(){var a=$(this).index(),b=parseInt(t.css("top"),10),c=r[a]-b+55;$("body,html").animate({scrollTop:c},800)});var v=null;$(".daylink li").hover(function(){d($(this))},function(){var a=$(this).index();poiList[a].len&&($("#showPoi").data("show",0),v=setTimeout(e,50))}),l.hover(function(){l.data("show",1)},function(){l.data("show",0),v=setTimeout(e,50)}),$(window).scroll(function(){b()})}b(),$(".link_like").gsbaselike({api:INTERFACE.likeUrl,callback:function(b){if($(b).parents(".titleright").length>0){var c=$(".top_inbox .btn_like");c.addClass("click_like"),c.text("已喜欢"),c.attr("title","已喜欢")}a()}}),$(".top_inbox .btn_like").gsbaselike({api:INTERFACE.likeUrl,callback:function(b){$(b).text("已喜欢");var c=$(".titlebox .titleright .link_like"),d=c.find("span"),e=parseInt(d.text(),10);e=isNaN(e)?0:e,e++,c.addClass("click_like"),c.attr("title","已喜欢"),d.text(e),a()}}),$(".btn_share").gsbaseshare({api:INTERFACE.shareUrl,fixed:!0,top:35,hasCount:!0,callback:function(){var a=$(".titlebox .link_share span"),b=parseInt(a.text(),10);b=isNaN(b)?0:b,b++,a.text(b)}}),$(".singleimg .link_share").gsbaseshare({api:INTERFACE.shareUrl}),$(".titlebox .link_share").gsbaseshare({api:INTERFACE.shareUrl,hasCount:!0}),$(".img_box .link_share").gsbaseshare({api:INTERFACE.shareUrl}),$(".img_block").hover(function(){$(this).addClass("over").find(".img_text div").css({height:$(this).find(".img_text").height()+"px"}).end().siblings(".img_block.over").removeClass("over");var a=$(this).find("img").width();290>a?$(this).find(".describe").hide():$(this).find(".describe").show()},function(){function a(){"none"!=$("#bdshare").css("display")?b.find(".img_text div").css({height:b.find(".img_text").height()+"px"}):b.removeClass("over").find(".img_text div").css({height:"30px"})}var b=$(this);setTimeout(a,50)}),$(".link_collect").add(".top_inbox .btn_collect").gsbasecollect({api:INTERFACE.collectUrl,callback:function(a){var b=$(a);if($(a).hasClass("btn_collect")){b.text("已收藏");var c=$(".link_collect");c.addClass("click_collect"),c.attr("title","已收藏");var d=c.find("span"),e=parseInt(d.text(),10);e=isNaN(e)?0:e,e++,d.text(e)}else $(".top_inbox .btn_collect").addClass("click_collect"),$(".top_inbox .btn_collect").attr("title","已收藏"),$(".top_inbox .btn_collect").text("已收藏")}}),d();var e=$.browser.msie&&"6.0"==$.browser.version;if(!e){var f=$(".titleright ul").offset().top,g=$(".top_article");$(window).scroll(function(){st=$(window).scrollTop(),st>f?g.show():g.hide()})}$(".imglink img").lazyload({threshold:500,failurelimit:5}),$("#strategy_info").gsnoderoll()}),function(a){function b(b){var c=a(b),d=c.val(),e=d.length;if(c.focus(),document.selection)if(c[0].createTextRange){var f=c[0].createTextRange();f.moveStart("character",e),f.collapse(),f.select()}else c.focus();else"number"==typeof b.selectionStart&&"number"==typeof b.selectionEnd&&(b.selectionStart=b.selectionEnd=e)}a.cookie.raw=!0,a(".link_delete,.btn_delete").click(function(){a.popupbox.show({id:"delJournal"})}),a("#delJournal").on("click",".close, .gsn-btn-6",function(){a.popupbox.close(),a("#pic_content").val("")}),a("#delJournal").on("click",".gsn-btn-2",function(){a(this).gsdisable({callback:function(){INTERFACE.del_journal({TravelId:INTERFACE.TravelId}),a.popupbox.close()}})}),a(".link_comment, .btn_comment").click(function(){a("#picComment").find(".gsn-tiptext").show(),a("#picComment").find(".journal-comment-tip").hide(),a("#pic_content").click();var c=a(this).attr("data-referenceCategory"),d=a("#pic_content"),e=d[0];if(!a(this).hasClass("a_popup_login")){a.popupbox.show({id:"picComment"});var f=a(this).parents(".img_block").attr("id");if(a("#picComment").data("quote",f),a("#picComment").data("type",c),void 0!=f){var g=a("#authorDisplayName").html(),h="引用 @"+g+" 的照片\n";a("#picComment").data("text",h),d.val(h)}}b(e)});var c=a("#picComment .count"),d=c.text();a("#picComment").on("click",".close, .gsn-btn-6",function(){a("#picComment").find(".count").text("1000"),a("#pic_content").val(""),a.popupbox.close()}),a("#picComment").on("click",".gsn-btn-2",function(){var b=a(this).parents("#picComment").find("#pic_content").val(),c=a("#picComment").data("text"),e=b.replace(c,""),f=/\S/g.test(e);if(f){var g=a("#picComment").data("quote"),h=a("#picComment").data("type");a("#picComment").find(".gsn-tiptext").show(),a("#picComment").find(".journal-comment-tip").hide(),a(this).gsdisable({callback:function(){var b=void 0!=g?g:"";INTERFACE.add_comment(a.toJSON({TravelId:INTERFACE.TravelId,ReferenceIds:b,ReferenceCategory:h,RemarkContent:encodeURIComponent(a("#pic_content").val())})),a("#picComment .count").val(d)}})}else a("#picComment").find(".gsn-tiptext").hide(),a("#picComment").find(".journal-comment-tip").show()}),a("#pic_content").gsInputLen(function(b){var e=d-b;if(-1>=e){var f=a("#pic_content"),g=f.val(),h=a.gsSubstring(g,d,1);f.val(h)}else c.html(e);a("#picComment").find(".gsn-tiptext").show(),a("#picComment").find(".journal-comment-tip").hide()});var e=a(".reportmain .count"),f=e.text();a("#report_area").placeholder(),a(".reportmain").on("click","#btnJournalCommment",function(){var b=a(this).attr("data-referenceCategory"),c=a.trim(a("#report_area").val());a(this).hasClass("a_popup_login")||(""==c||c==a("#report_area").attr("placeholder")?(a(".reportmain").find(".gsn-tiptext").hide(),a("#journal-comment-tip").show()):(a(".reportmain").find(".gsn-tiptext").show(),a("#journal-comment-tip").hide(),a("#btnJournalCommment").gsdisable({callback:function(){var c=a("#report_area").attr("data-referenceids");INTERFACE.add_comment(a.toJSON({TravelId:INTERFACE.TravelId,ReferenceIds:c,ReferenceCategory:b,RemarkContent:encodeURIComponent(a("#report_area").val())})),a("#report_area").val(),a(".reportmain .count").val(f)}})))}),a("#report_area").gsInputLen(function(b){var c=f-b;if(-1>=c){var d=a("#report_area"),g=d.val(),h=a.gsSubstring(g,f,1);d.val(h)}else e.html(c);a(".reportmain").find(".gsn-tiptext").show(),a(".reportmain").find(".journal-comment-tip").hide()}),a.con_focus=function(a){b(a)},1!=INTERFACE.isHost&&INTERFACE.accessState(function(b,c){var d=function(a){return 0==a&&(a=""),a};if(a(".link_browse").text(d(c.VisitCount)),a(".graylink").text(d(c.CommentCount)),a(".link_share").find("span").text(d(c.ShareCount)),a(".link_like").find("span").text(d(c.LikeCount)),a(".link_collect").find("span").text(d(c.FavouriteCount)),1==c.CanDownLoadPDF&&a(".link_pdf").attr("href",c.DownLoadPDFUrl),a.ifPdfVisible(),0==b.RetCode)return!1;var e=b.UserInfo.DisplayName,f=b.UserInfo.HomePageUrl,g=b.UserInfo.HeadPhotoUrl,h='<a title="'+e+'" rel="nofollow" href="'+f+'" target="_blank" rel="nofollow"><img width="60" height="60" src="'+g+'"></a><a title="'+e+'" rel="nofollow" href="'+f+'" target="_blank" rel="nofollow">'+e+"</a>";(1==b.RetCode||2==b.RetCode)&&(a(".a_popup_login").removeClass("a_popup_login"),a(".headside").append(h),2==b.RetCode&&(a(".titler_div").children("div").addClass("titler_div_right"),a(".titler_div").prepend('<a id="master_link" class="titler_a" href="'+b.TravelMasterUrl+'"><i class="edit"></i>编辑游记</a>')))})}(jQuery),function(){var a;a=window.UEDITOR_HOME_URL||tmp.substr(0,tmp.lastIndexOf("/")+1).replace("_examples/","").replace("website/",""),window.UEURL&&(a=window.UEURL),window.UEDITOR_CONFIG={UEDITOR_HOME_URL:a,imageUrl:a+"net/imageUp.ashx",imagePath:a+"net/",scrawlUrl:a+"net/scrawlUp.ashx",scrawlPath:a+"net/",fileUrl:a+"net/fileUp.ashx",filePath:a+"net/",catcherUrl:a+"net/getRemoteImage.ashx",catcherPath:a+"net/",imageManagerUrl:a+"net/imageManager.ashx",imageManagerPath:a+"net/",snapscreenHost:"127.0.0.1",snapscreenServerUrl:a+"net/imageUp.ashx",snapscreenPath:a+"net/",wordImageUrl:a+"net/imageUp.ashx",wordImagePath:a+"net/",getMovieUrl:a+"net/getMovie.ashx",toolbars:[["bold","horizontal","link"]],labelMap:{anchor:"",undo:""},webAppKey:""}}(),String.prototype.strLength=function(){if(this.charCodeAt){for(var a=0,b=0;b<this.length;b++)this.charCodeAt(b)>255||this.charCodeAt(b)<0?a+=2:a++;return a}},String.prototype.strToChars=function(){for(var a=new Array,b=0;b<this.length;b++)a[b]=[this.substr(b,1),this.isCHS(b)];return String.prototype.charsArray=a,a},String.prototype.isCHS=function(a){return this.charCodeAt?this.charCodeAt(a)>255||this.charCodeAt(a)<0?!0:!1:void 0},String.prototype.subCHString=function(a,b){var c=0,d="";this.strToChars();for(var e=0;e<this.length;e++){if(this.charsArray[e][1]?c+=2:c++,c>b)return d;c>a&&(d+=this.charsArray[e][0])}return d},String.prototype.subCHStr=function(a,b){return this.subCHString(a,a+b)},String.prototype.lastsubCHStr=function(a){return this.strLength?!a||a>=this.strLength()?this.toString():"..."+this.subCHStr(this.strLength()-a+1,a):void 0},function(){this.JournalAction={editor:null,travel:{OperateCategory:"2",TravelId:"1728238",AppendId:"0",TravelTitle:"厦门",TravelContent:"",TagList:"",DistrictList:[],ImageList:[],CoverImageId:"11733758",OperateUserId:"4880792"},init:function(a){var b=this;this.draftTimeoutID=setTimeout(function(){b.draft(!1),b.draftTimeoutID=setTimeout(arguments.callee,1e4)},1e4),$("#draft").bind("click",function(){return b.beforeSubmit()?void b.draft(!0):(b.closePopup(),!1)}),$("#btn_submit").bind("click",function(){var a=b.travel.OperateCategory;("1"==a||"2"==a)&&b.submit(),("3"==a||"4"==a)&&b.append()}),$("#btnSubmit").bind("click",function(){b.save()}),$("#btnSkip").bind("click",function(){b.skip()}),this.addEventListener(window,"beforeunload",function(a){var a=a?a:event,c=window.google||window.chrome;if(!b.leavePage()){if(c)return"您的游记未正式发表，确定要离开此页吗？";a.returnValue="您的游记未正式发表，确定要离开此页吗？"}}),this.editor=UE.getEditor(a),this.GetTravel()},leavePage:function(){return this.editor.getContent()&&this.travel.TravelContent!=this.editor.getContent()?!1:$("#title").val().trim()&&this.travel.TravelTitle!=$("#title").val().trim()?!1:$.editTagArr()&&this.travel.TagList!=$.editTagArr()?!1:!0},addTags:function(a,b){var c=b.val();-1==$.inArray($(a).html(),c.split(/\s*[,|，]\s*/))&&(c+=""!=c&&","!=c.split("").pop()?",":"",b.val(c+$(a).html()))},warn:function(a,b){var c=document.getElementById(a);b?(c.innerHTML=b,c.style.display=""):(c.innerHTML="",c.style.display="none")},addEventListener:function(a,b,c){a&&(a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener?a.addEventListener(b,c,!1):a[b]=c)},closePopup:function(){$("#popup_win_bg").remove(),$("#popup_win").remove()},submit:function(){if(!this.beforeSubmit())return this.closePopup(),!1;var a=this;$.popupbox.show({id:"gsn_frame_nocontent",zIndex:1001}),a.draft(!1),this.GetDistrictList()},append:function(){if(!this.beforeSubmit())return this.closePopup(),!1;if($("#submitsec").hide(),$.popupbox.show({id:"gsn_frame_submiting",zIndex:1001}),this.webPhoto.length)return $.popupbox.close(),$.popupbox.show({id:"gsn_frame_uploadimg",zIndex:10001}),this.uploadWebPhoto(),!1;var a=this;return a.draft(!1),0!=this.draftTimeoutID&&clearTimeout(this.draftTimeoutID),a.doPost(),!0},save:function(){if(0!=this.draftTimeoutID&&clearTimeout(this.draftTimeoutID),this.destCombine(),$.popupbox.close(),this.webPhoto.length)return $.popupbox.show({id:"gsn_frame_uploadimg",zIndex:10001}),this.uploadWebPhoto(),!1;var a=this;return $.popupbox.show({id:"gsn_frame_submiting",zIndex:1001}),a.doPost(),!0},skip:function(){if(0!=this.draftTimeoutID&&clearTimeout(this.draftTimeoutID),$.popupbox.close(),$.popupbox.show({id:"gsn_frame_submiting",zIndex:1001}),$(".gsn-form .deslist").html(""),this.webPhoto.length)return $.popupbox.show({id:"gsn_frame_uploadimg",zIndex:10001}),this.uploadWebPhoto(),!1;var a=this;return a.doPost(),!0},doPost:function(){var a=this.GetTravel();$.ajax({type:"post",url:"/TravelSite/Member/OperateClassicTravel",dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",data:$.toJSON(a),success:function(a){a.RetCode>0?location.href="/TravelSite/Member/ClassicTravelMessage?"+a.Html:alert(a.ErrorMessage)}})},uploadWebPhoto:function(){if(this.webPhoto.length){for(var a=this,b=[],c=[],d=[],e=0;this.webPhoto[e];e++)b[b.length]=this.webPhoto[e].src,c[c.length]=this.webPhoto[e],(e==this.webPhoto.length-1||0==(e+1)%3)&&(d[d.length]={urls:b,ps:c,uploaded:!1},b=[],c=[]);!function f(b){$.ajax({type:"Post",url:"/TravelSite/Member/AjaxUploadWebPhoto",dateType:"text",contentType:"application/x-www-form-urlencoded; charset=utf-8",data:{urls:d[b].urls.join(",")},async:!0,success:function(c){if(c)for(var e=c,g=0;d[b].ps[g];g++)e[g]&&/^[1-9]\d*|0$/.test(e[g].RetCode)?(d[b].ps[g].setAttribute("phsid",e[g].RetCode),"selected"==$(d[b].ps[g]).attr("cover")&&(a.travel.CoverImageId=e[g].RetCode)):d[b].ps[g].setAttribute("phsid",0);d[b].uploaded=!0,b<d.length-1?f(b+1):(a.draft(!1),0!=this.draftTimeoutID&&clearTimeout(this.draftTimeoutID),a.doPost())}})}(0)}},beforeSubmit:function(){var a,b=this.GetTravel(),c=b.TagList,d=!0;return 0==getreallen(this.editor.getContent())?(this.warn("contentwarn","请填写正文"),a="#wcontent",d=!1):this.warn("contentwarn"),(1==b.OperateCategory||2==b.OperateCategory)&&(c&&c.length>0&&(10<c.length?($(".mainCon .gsn-inputbox").show(),$(".mainCon .gsn-tiptext").text("最多可以添加10个分类标签"),a="#wtag",d=!1):$(".mainCon .gsn-inputbox").hide()),this.travel.TravelTitle.isNullOrEmpty()?(this.warn("titlewarn","请填写标题"),a="#wtitle",d=!1):this.travel.TravelTitle.length>50?(this.warn("titlewarn","标题不能大于50个字"),a="#wtitle",d=!1):this.warn("titlewarn")),d||(location.href=a),d},destCombine:function(){var a=this,b=[];$(".deslist span").each(function(c,d){if("tag-btn-selected"==d.className){var e=!1;for(c in a.travel.DistrictList)a.travel.DistrictList[c]==$(d).attr("data")&&(e=!0);if(!e){var f={RetCode:$(d).attr("data"),Html:$(d).html()};b[b.length]=f}}}),this.travel.DistrictList=b},highLine:function(a,b){var c=0;clearTimeout(c),a.addClass(b),c=setTimeout(function(){a.removeClass(b)},2e3)},htmlEncode:function(a){var b=document.createElement("div"),c=document.createTextNode(a);b.appendChild(c);var d=b.innerHTML;return d},draftTimeoutID:0,draft:function(a){var b=this,c=this.editor.getContent().replace(/&[a-z0-9]+;/gim," ").replace(/\r?\n/gm,"").replace(/\s+/gm," ").replace(/<[^>]*>/gim,function(){return/img/gim.test(arguments[0])?arguments[0]:""});if(""!=c){$(".savedCon").html("正在保存...");var d=this.GetTravel();d.OperateCategory=parseInt(d.OperateCategory)+4,$.ajax({type:"POST",url:"/TravelSite/Member/SaveClassicTravelDraft",dateType:"json",data:$.toJSON(d),contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(){1==a&&($.popupbox.show({id:"gsn_frame_draft",zIndex:10001}),setTimeout(function(){$.popupbox.close()},3e3));var c=new Date;$(".savedCon").html("已保存，"+c.toLocaleDateString()+" "+c.toLocaleTimeString()),$(".savedCon").show(),b.highLine($(".savedCon"),"highline")}})}},setImageInfo:function(){var a=this.getImagesFromContent();this.travel.ImageList=a},webPhoto:[],getImagesFromContent:function(){var a=this.editor.document.getElementsByTagName("img"),b=[];if(this.webPhoto=[],a&&a.length)for(var c=0;c<a.length;c++){var d=a[c].getAttribute("phsid");"selected"==$(a[c]).attr("cover")&&/^[1-9]\d*|0$/.test(d)&&(this.travel.CoverImageId=d),d&&"0"!=d?d&&/^[1-9]\d*|0$/.test(d)&&(b[b.length]={RetCode:d,Html:a[c].src}):(this.webPhoto[this.webPhoto.length]=a[c],b[b.length]={RetCode:0,Html:a[c].src})}return b},GetTravel:function(){var a=$("#title").val();void 0!=a&&(this.travel.TravelTitle=a.trim());var b=$.editTagArr();void 0!=b&&(this.travel.TagList=b.trim()),this.travel.TravelContent=this.editor.getContent(),this.destCombine(),this.setImageInfo();var c={OperateCategory:this.travel.OperateCategory,TravelId:this.travel.TravelId,AppendId:this.travel.AppendId,TravelTitle:encodeURIComponent(this.travel.TravelTitle),TravelContent:encodeURIComponent(this.htmlEncode(filterBaiduEdit(this.travel.TravelContent))),TagList:[],DistrictList:this.travel.DistrictList,ImageList:this.travel.ImageList,CoverImageId:this.travel.CoverImageId,OperateUserId:this.travel.OperateUserId},d=[];if(""!=this.travel.TagList.trim()){var e=this.travel.TagList.split(",");if(e&&e.length>0)for(var f=0;e[f];f++)d[f]=e[f]}return c.TagList=d,c},GetDistrictList:function(){window.setUserDesValue();var a="",b=this.GetTravel();if(b.DistrictList&&b.DistrictList.length>0)for(var c=b.DistrictList,d=0;c[d];d++)"10000"!=c[d].RetCode&&(a+='<span data="'+c[d].RetCode+'" class="tag-btn-selected" style="cursor:pointer" onclick="javascript:void(0); return false;">'+c[d].Html+"</span>");
var e=b;return $.ajax({type:"Post",url:"/TravelSite/Member/GetDistrictByContent",dateType:"text",contentType:"application/x-www-form-urlencoded; charset=utf-8",data:{title:e.TravelTitle,content:e.TravelContent},async:!0,success:function(c){var d="";if(c.length>0)for(var e=0;c[e];e++)if(-1==a.indexOf('data="'+c[e].RetCode+'"'))d+=0==e&&""==a?'<span data="'+c[e].RetCode+'" class="tag-btn-selected" style="cursor:pointer" onclick="javascript:void(0); return false;">'+c[e].Html+"</span>":'<span data="'+c[e].RetCode+'" class="tag-btn-normal" style="cursor:pointer" onclick="javascript:void(0); return false;">'+c[e].Html+"</span>";else{for(var f="",g=0;b.DistrictList[g];g++)if(b.DistrictList[g].RetCode==c[e].RetCode){f=b.DistrictList[g].Html;break}if(""!=f){var f='<span data="'+c[e].RetCode+'" class="tag-btn-selected" style="cursor:pointer" onclick="javascript:void(0); return false;">'+f+"</span>",h='<span data="'+c[e].RetCode+'" class="tag-btn-selected" style="cursor:pointer" onclick="javascript:void(0); return false;">'+c[e].Html+"</span>";a=a.replace(f,h)}}$(".gsn-form .deslist").html(a+d),$.popupbox.close(),$.popupbox.show({id:"gsn_frame_selectdes",layerContainer:"gs_pop_01",zIndex:"500",callback:null})}}),!1}}}(),String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")},String.prototype.isNullOrEmpty=function(){return null==this||""==this},function(a){a.fn.imgloaded=function(b){return b=a.extend({srcAttr:"",errorSrc:"http://you.ctrip.com/newimg/nophoto.jpg",width:"",height:""},b),this.each(function(){var c=a(this).attr(b.srcAttr||"realSrc")||"",d=this;c&&new imgReadyObj(c,function(){var a=this.width/this.height;a>=b.width/b.height?(d.height=b.height,d.width=b.height*a):(d.width=b.width,d.height=b.width/a),"function"==typeof b.readyCallback&&setTimeout(function(){b.readyCallback.call(d)},10)},function(){d.src=c,"function"==typeof b.loadCallback&&setTimeout(function(){b.loadCallback.call(d)},10)},function(){d.src=b.errorSrc,"function"==typeof b.errorCallback&&b.errorCallback.call(d)})})}}(jQuery),imgReadyObj.prototype={exec:function(){this.arrfn[0].end?this.arrfn.length=0:this.arrfn[0](),!this.arrfn.length&&this.stop()},stop:function(){clearInterval(this.intervalId),this.intervalId=null},inte:function(){var a,b,c,d,e,f=new Image,g=this;return f.src=this.url,f.complete?(this.ready.call(f),void(this.load&&this.load.call(f))):(b=f.width,c=f.height,f.onerror=function(){g.error&&g.error.call(f),a.end=!0,f=f.onload=f.onerror=null},a=function(){d=f.width,e=f.height,(d!==b||e!==c||d*e>1024)&&(g.ready.call(f),a.end=!0)},f.onload=function(){!a.end&&a(),g.load&&g.load.call(f),f=f.onload=f.onerror=null},f.src=this.url,void(a.end||(g.arrfn.push(a),null===this.intervalId&&(this.intervalId=setInterval(function(){g.exec.apply(g)},40)))))}},function(a){a.fn.gsBottomRegister=function(b){function c(){var a=[];a.push('<div class="gs_bottom_pop_blk" id="regGuide">'),a.push('    <div class="gs_bottom_pop_inforout">'),a.push('        <a class="gs_bottom_pop_close" href="javascript:void(0);"></a>'),a.push('        <div class="gs_bottom_pop_inforin cf">'),a.push('            <div class="gs_bottom_pop_left">'),a.push('                <div class="gs_pop_animation_show">'),a.push('                    <span class="gs_bpop_wd"></span><span class="gs_bpop_jd"></span><span class="gs_bpop_yj"></span><span class="gs_bpop_gl"></span><span class="gs_bpop_mdd"></span><span class="gs_bpop_ms"></span><span class="gs_bpop_yl"></span><span class="gs_bpop_qt"></span>'),a.push("                </div>"),a.push("            </div>"),a.push('            <div class="gs_bottom_pop_mid">'),a.push('                <a href="'+b.reg_url+'" class="regbutton" target="_blank">注册</a><a href="'+b.login_url+'" class="loginbutton" target="_blank">登录</a>'),a.push("            </div>"),a.push('            <div class="gs_bottom_pop_right">'),a.push('                <span class="gs_micromes"></span><a href="http://weibo.com/ctripyou" title="关注我们" target="_blank" class="gs_focus_us"></a>'),a.push("            </div>"),a.push("        </div>"),a.push("    </div>"),a.push("</div>"),f.append(a.join(""))}function d(){var c=a("#regGuide");c.find(".gs_bottom_pop_close").on("click",function(){c.hide(),a.cookie(b.cookieName,1,{expires:b.cookieDay,path:"/"})});var d=window.setTimeout(function(){var b=a("#float_level").css("display");(void 0==b||"none"==b)&&c.show(),d=null},b.time)}b=a.extend({reg_url:"https://accounts.ctrip.com/member/emailregist.aspx",login_url:"https://accounts.ctrip.com/member/login.aspx?BackURL="+escape(window.location.href),time:1e4,cookieName:"is_open_bottom_reg",cookieDay:1},b);var e=6==a.browser.version&&a.browser.msie;if(e)return!1;var f=a(this);return a.cookie.raw=!0,a.cookie(b.cookieName)||a.cookie("CtripUserInfo")||(c(b),d()),this}}(jQuery),$(function(){$("body").gsBottomRegister(),$(".despop_nav .first").hasClass("f_current")&&$(".despop_nav .first").data("f_cur",1),$(".despop_nav li").hover(function(){$(this).hasClass("first")?($(this).data("cur",!0),$(this).addClass("f_current")):($(this).data("cur",!1),$(this).addClass("current"),$(".despop_box div").eq($(this).index()-1).show())},function(){$(this).data("cur")?1!=$(".despop_nav .first").data("f_cur")&&$(this).removeClass("f_current"):($(this).removeClass("current"),$(".despop_box div").eq($(this).index()-1).hide())}),$(".despop_box div").hover(function(){$(this).show(),$(".despop_nav li").eq($(this).index()+1).addClass("current")},function(){$(this).hide(),$(".despop_nav li").eq($(this).index()+1).removeClass("current")})}),$(function(a){a.fn.lpMasonry=function(b){return b=a.extend({cellspace:15,cols:4,cellwidth:226,cellele:"div.item",url:"",ajaxpage:1,loading:"#fall-loading",pagesize:16},b),this.each(function(){var c=[],d=0,e=b.cellwidth+b.cellspace,f=a(this),g=this,h=b.loading,i=b.ajaxpage,j=!1,k=a.browser.msie;this.position=function(a){for(var g=a.outerHeight(!0),h=Math.min.apply(Math,c),i=0,j=b.cols;j>i;i++)if(c[i]===h){a.css({position:"absolute",left:i*e,top:c[i],opacity:!k&&0}).attr({"data-index":d,col:i}),c[i]+=g;break}!k&&this.animate({opacity:1},300),f.height(Math.max.apply(Math,c)),d++},this.add=function(){var c=b.pagesize,d=b.data||{};a.ajax({type:"GET",url:b.url,data:a.extend({p:i},d),success:function(b){var d=a(b).appendTo(f).css({opacity:!a.browser.msie&&0}),e=1;return a(h).hide(),d.each(function(){g.position.call(d,a(this)),e++}),c>e?void(j=!0):(i++,void(j=!1))}})},a(window).scroll(function(){j||f.offset().top+f.height()-600<a(document).scrollTop()+a(window).height()&&(a(h).show(),g.add(),j=!0)}),this.init=function(){var d=f.find(b.cellele);f.css({position:"relative"});for(var e=0,h=b.cols;h>e;e++)c[e]=0;d.length>0?d.each(function(){g.position.call(d,a(this))}):g.add()}()})}}),$(function(){function a(){var d=$("#generatPDF"),e=setInterval(function(){$.get(INTERFACE.pdfCheckUrl+"?travelId="+INTERFACE.TravelId+"&rnd="+new Date,function(f){switch(f.Status){case 2:clearInterval(e);var g=f.Title,h=parseInt(10*f.FileSize/1024)/10,i="<h2>让你久等了，游记已制作成PDF</h2><div><i></i><h4>"+g+"</h4><p>PDF大小："+h+'MB</p><p>下载你喜爱的游记一起去旅行吧！</p><a class="generat_btn" href="javascript:;">点击下载PDF</a></div>';b.attr("class","generat_success").html(i),d.find(".generat_btn").add(".btn_pdf, .link_pdf").attr({href:INTERFACE.pdfDownUrl+"?travelId="+INTERFACE.TravelId,target:"_blank"});break;case 4:clearInterval(e);var i='<div></div><p>服务器好像出了点问题，PDF生成失败…</p><a class="generat_btn" href="javascript:;">重新制作PDF</a>';b.attr("class","generat_failure").html(i),d.find(".generat_btn").click(function(){return d.find(".generat_failure").attr("class","generat_loading").html(c),a(),!1});break;default:return}})},5e3);d.find(".close").click(function(){$.popupbox.close(),clearInterval(e)})}$(window).resize(function(){$.ifPdfVisible()});var b=$("#generatPDF").find(".generat_loading"),c=b.html();$(".btn_pdf, .link_pdf").click(function(){$(this).hasClass("a_popup_login")||"javascript:;"!=$(this).attr("href")||$.get(INTERFACE.pdfCheckUrl+"?travelId="+INTERFACE.TravelId+"&rnd="+new Date,function(d){if(5==d.Status){var e="<div></div><p>游记PDF下载异常火爆，请耐心等待一下，稍后再试！</p>";b.attr("class","generat_failure").html(e),$.popupbox.show({id:"generatPDF"}),$("#generatPDF").find(".close").click(function(){$.popupbox.close()})}else 2!=d.Status&&($("#generatPDF > div").attr("class","generat_loading").html(c),$.popupbox.show({id:"generatPDF",callback:a}))})})});var swfu={};$(function(){function a(a){return"<li id="+a.id+" data-imgId=\"\"><div><a class='btnCancel' href='javascript:void(0);'>×</a><span></span><p title=\""+a.name+'">'+a.name+"</p></div><i></i></li>"}function b(a){return"<li id="+a.id+' class="errorMsg"><div><span>大于10M，请重新选择</span><p title="'+a.name+'">'+a.name+"</p></div></li>"}function c(a){return re=/(.*\/)/gi,r=a.match(re),r[0]+"images/swfupload_fp9.swf"}function d(a,b){$("#"+a).find(".btnCancel").click(function(){b.cancelUpload(a,!1);var c=$("#"+a).attr("data-imgId");""!=c&&INTERFACE.del_img($.toJSON({TravelId:INTERFACE.TravelId,ImageId:c})),setTimeout(function(){$("#"+a).animate({opacity:.15,height:0},600,function(){var a=b.getStats();""!=c&&(--a.successful_uploads,b.setStats(a),e(a)),$(this).remove(),b.getStats().files_queued?$("#step2_button").disableButton(!1):toggleDet(b)})},300)})}function e(a){var b=0==a.successful_uploads?"。":"照片已保存。",c=a.upload_errors>0?'上传失败 <span class="red">'+a.upload_errors+"</span> 张"+("。"==b?"":"，"):"",d=c+b=="。"?"":"，";$(".state_proccessing").html('已成功上传 <span class="green">'+a.successful_uploads+"</span> 张"+d+c+b),$("#step2_button").disableButton(0==a.successful_uploads?!1:!0)}if(!gs_ua.pv[0])return $(".upload_btn").html('请安装或启用<a href="http://www.adobe.com/go/getflashplayer/" target="_blank">Flash组件</a>'),!1;{var f=$("#gs_uploadurl").val();$("#imgRootPath").val()}swfu=new SWFUpload({upload_url:f,flash_url:c(f),file_types:"*.jpg;*.jpeg;*.png;*.bmp;*.gif",file_size_limit:"10MB",file_queue_limit:0,debug:!1,prevent_swf_caching:!1,preserve_relative_urls:!1,button_placeholder_id:"flashLink",button_image_url:INTERFACE.button_image,button_width:128,button_height:36,button_text:"<span class='redText'>上传照片</span>",button_text_style:".redText { color: #666666; font-weight: bold; font-size: 14px; }",button_text_left_padding:45,button_text_top_padding:8,button_action:SWFUpload.BUTTON_ACTION.SELECT_FILES,button_cursor:SWFUpload.CURSOR.HAND,button_disabled:!1,post_params:{"new":1,source:1,type:"journals",token:"78A566F2-AA8A-4C4C-8EE8-F99FB3D4A1D8",randomKey:(new Date).getTime(),typeid:INTERFACE.typeid,title:INTERFACE.title,userid:INTERFACE.userid,journalid:INTERFACE.TravelId},file_queue_error_handler:function(a,c){try{var d="";switch(c){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:$("#file_list").append(b(a)),$("#"+a.id).find("p").width(355),toggleDet(swfu);var f=swfu.getStats();++f.upload_errors,swfu.setStats(f),e(f);break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:d="您选择的文件含有其他格式文件",toggleDet(d)}}catch(g){this.debug(g)}},file_queued_handler:function(b){try{$("#step2_button").disableButton(!1),$("#file_list").append(a(b)),toggleDet(swfu),d(b.id,this)}catch(c){this.debug(c)}},file_dialog_complete_handler:function(a,b){try{if(b>0){this.startUpload();var c=this.getStats(),d=c.files_queued+c.successful_uploads+c.upload_errors+c.upload_cancelled;$(".state_proccessing").html('已上传 <span class="green">'+c.successful_uploads+"</span> / "+d+"张...").css("color","#666")}}catch(e){this.debug(e)}},upload_progress_handler:function(a,b,c){try{var d=Math.ceil(b/c*100),e=$("#"+a.id);e.find("i").width(d+"%"),e.find("span").html(100==d?"100% 处理中":d+"%")}catch(f){this.debug(f)}},upload_complete_handler:function(){try{var a=this.getStats(),b=a.files_queued+a.successful_uploads+a.upload_errors+a.upload_cancelled;a.files_queued?$(".state_proccessing").html('已上传 <span class="green">'+a.successful_uploads+"</span> / "+b+" 张..."):e(a)}catch(c){this.debug(c)}},upload_success_handler:function(a,b){try{var c=format_data(b),d=this.getStats();if("0"==c.data)return--d.successful_uploads,this.setStats(d),e(d),void(window.console&&console.log("图片服务端无数据返回！请确认服务器端口是否正确！"));0==this.getStats().successful_uploads||this.getStats().files_queued||$("#step2_button").disableButton(!0);var f=""==c.server_data?0:c.data;if($("#"+a.id).find("span").html("完成"),$("#"+a.id).attr("data-imgId",f),c.width>=600)INTERFACE.upload_success({TravelId:INTERFACE.TravelId,ImageId:c.data,ImageName:encodeURIComponent(c.fileName),ImageDate:c.shootTime,TravelDate:INTERFACE.TravelDate});else{$("#"+a.id).addClass("errorMsg").find("p").width(310).end().find("a,i").remove().end().find("span").html("宽度小于600像素，请重新选择");{var g=this.getStats();$("#file_list").find("li").not(".errorMsg").length}--g.successful_uploads,++g.upload_errors,this.setStats(g)}}catch(h){this.debug(h)}}})}),$.fn.disableButton=function(a){{var b=$(this);b.attr("disabled")}a?(b.removeAttr("disabled"),b.removeClass("disable")):(b.attr("disabled","true"),b.addClass("disable"))},$(function(){$.browser.msie&&"6.0"==$.browser.version&&!$.support.style&&$("body").width($("html").width()-21),$.imgTotal=500-parseInt(imgCount);var a={appWidth:956,appHeight:401,limitW:600,limitH:0,limitMaxW:1e4,limitMaxH:1e4,limitSize:10,limitTotal:$.imgTotal,hasUploadNum:500-$.imgTotal,defaultMsg:"（单张图片上限10M，可旋转图片，拖拽图片能更改顺序！）",uploadLabel:"一次性传完照片,你的丰富行程将立即展现!\n\n照片宽度需大于600像素，单张照片最大可10M",filterDesc:"请选择图片(*.jpg;*.jpeg;*.png)",filterType:"*.jpg;*.jpeg;*.png",waterLabel:"使用水印",parsingImgLabel:"正在加载第<font face='Arial' color='#339900'> {0} </font>张照片，请稍等",finishLabel:"已成功上传<font face='Arial' color='#339900'> {0} </font>张，照片可旋转或删除",progressLabel:"正在上传<font face='Arial' color='#339900'> {0} </font>/<font face='Arial' color='#339900'> {1} </font>张，上传完成后可旋转或删除",finishErrorLabel:"已成功保存<font face='Arial' color='#339900'> {0} </font>张，失败<font color='#FF6606'> {1} </font>张，照片可旋转或删除",finishErrorLabel2:"上传失败<font face='Arial' color='#FF6606'> {1} </font>张",errorMsg1:"上传图片地址出错",errorMsg2:"有 {0} 张图片不符合上传规则",errorLabel1:"大于10M\n请重新选择",errorLabel2:"宽小于600像素\n请重新选择",errorLabel3:"网络错误\n<u>重传</u>",errorLabel6:"您已经上传过 {0} 张图片，只能再上传 {1} 张图片",checkResponse:"checkResponse",webNext:"webNext",deleteCall:"delete_img",scrollCall:"mouseScroll",canDrag:0,server:$("#gs_uploadurl").val(),postData:"new=1|source=1|type=journals|typeID=13|token=78A566F2-AA8A-4C4C-8EE8-F99FB3D4A1D8|randomKey="+Math.random()+"|typeid="+INTERFACE.typeid+"|title="+INTERFACE.title+"|userid="+INTERFACE.userid+"|journalid="+INTERFACE.TravelId,history:escape(INTERFACE.JsonTravelImageList)},b={wmode:"window",quality:"high",menu:"false",scale:"noScale",allowFullscreen:"true",allowScriptAccess:"always"},c={id:"photo_upload",name:"photo_upload"};swfobject.embedSWF($("#flashUrl").val()+"?r="+Math.random(),"photo_upload","956","401","10.2.0","expressInstall.swf",a,b,c)});var imgIdArr=[],noRep=!1,selectdes_frame_close=null;$(function(){function a(){var a=[];$(".deslist .tag-btn-selected").each(function(){a.push($(this).html())}),$("#selected-des").val(a.join("|"))}function b(){function b(){if($("#deshKword")){var a=$("#deshKword").offset();if(a){var b=$("#deshKword").outerHeight();$("#deshKwordCon").css({top:a.top+b,left:a.left})}}}c=!0;var d=new lvping.ui.Suggest("#deshKword",{dataUrl:"/ajaxnew/SearchTipJson.ashx?rank=1",queryName:"para"});d.sugContainer=function(a){var c="";if(a.destinations){for(var d=[],e=a.destinations.length,f=0;e>f;f++)d.push('<a fhref="'+a.destinations[f].id+'">'+a.destinations[f].name+"</a>");c='<div class="sgt-kq"><em class="fast-sgt-des">目的地</em>'+d.join("")+"</div>"}return b(),c},d.setValues=function(b){if($("#deshKword").val(""),b.text().indexOf("搜索")>-1)return!1;if(""==b.text())return!1;var c;c=b.text().indexOf("，")>-1?b.text().split("，")[0]:b.text().split(",")[0];var e=sid=b.attr("fhref"),f=$('<span class="tag-btn-selected" data="'+e+'" sid="'+sid+'">'+c+"</span>"),g=!1;return $(".deslist span").each(function(){$(this).html()==c&&(g=!0)}),g?!1:($(".deslist").append(f),a(),void d.hide())},$(window).scroll(function(){b()})}window.setUserDesValue=function(){$("#gsn_frame_selectdes .second-tip").hide(),$(".deslist").css({"margin-top":"4.5em"}),$("#searchTip").show(),c||b()},selectdes_frame_close=function(){$.popupbox.close(),$(".deslist a").removeClass("tag-btn-selected").addClass("tag-btn-normal")},$(".showinputbox").live("click",function(){return"block"==$("#searchTip").css("display")?!1:($(this).css({cursor:"default"}),$(".deslist").css({"margin-top":"4.5em"}),$("#searchTip").show(),void(c||b()))}),$(".deslist span").live("click",function(){$(this).hasClass("tag-btn-normal")?$(this).removeClass("tag-btn-normal").addClass("tag-btn-selected"):$(this).removeClass("tag-btn-selected").addClass("tag-btn-normal"),a()}),$("#gsn_frame_selectdes #btn_cancle").live("click",function(){selectdes_frame_close()});var c=!1}),$(function(){function a(a){if($.browser.msie)return a=a.replace(/&/gim,"&amp;"),a=a.replace(/\</gim,"&lt;"),a=a.replace(/\>/gim,"&gt;");var b=document.createElement("div"),c=document.createTextNode(a);return b.appendChild(c),b.innerHTML}function b(a){if($.browser.msie)return a=a.replace(/&lt;/gim,"<"),a=a.replace(/&gt;/gim,">"),a=a.replace(/&amp;/gim,"&");var b=document.createElement("div");b.innerHTML=a;var c=b.innerText||b.textContent;return b=null,c}function c(a){$.popupbox.show({id:"poi_pingjia",callback:function(){}});var c=$("#poi_pingjia"),d=c.find("#reviewContent"),e=c.find(".input_tips .tips span"),g=c.find(".input_tips .warning"),h=1e3,i=c.find(".fr .gsn-btn-2"),j=c.find(".fr .gsn-btn-6");a=$.extend({isViewpoint:!0,zongtiPoint:0,kouweiPoint:0,fengweiPoint:0,fuwuPoint:0,xiaofei:"",pinglun:"",callback:function(){}},a),c.find(".fr span").hide();var k=function(){c.find(".fr span").fadeOut(200)},l=null;$("#zongtiPointVerify").hide(),$("#kouweiPointVerify").hide(),$("#fengweiPointVerify").hide(),$("#fuwuPointVerify").hide(),$("#fraction-avgVerify").hide(),g.hide(),e.text(1e3),a.isViewpoint?(c.find("h3").text("景点点评"),$(".restaurant").hide()):(c.find("h3").text("餐馆点评"),$(".restaurant").show(),c.find(".for-piont").each(function(b,c){var d=$(c),e=d.find(".cls-set"),f=0,g=d.find(".fraction-num");switch(b){case 0:f=parseInt(a.kouweiPoint,10);break;case 1:f=parseInt(a.fengweiPoint,10);break;case 2:f=parseInt(a.fuwuPoint,10)}e.val(f),g.find("i").removeClass("selected"),g.find("i:lt("+f+")").addClass("selected"),g.find("i").unbind(),g.find("i").bind("click",function(){g.find("i").removeClass("selected");var a=$(this).index()+1;g.find("i:lt("+a+")").addClass("selected"),e.val(a),g.siblings("em").hide()})})),c.find(".fraction-star").find("i").removeClass("selected"),$("#zongtiPoint").val(parseInt(a.zongtiPoint,10)),c.find(".fraction-star").find("i:lt("+parseInt(a.zongtiPoint,10)+")").addClass("selected"),$("#xiaofei").val(""==a.xiaofei||isNaN(a.xiaofei)?"":a.xiaofei);var m=["差","一般","好","很好","推荐"];c.find(".fraction-star i").unbind();var n=c.find(".star-hover-tip");c.find(".fraction-star i").bind("mousedown",function(){$(this).parent().find("i").removeClass("selected");var a=$(this).index()+1;$(this).parent().find("i:lt("+a+")").addClass("selected"),$(this).parent().parent().find(".cls-set").val(a),$("#zongtiPointVerify").hide()}).hover(function(){$("#zongtiPointVerify").hide();var a=$(this);a.addClass("hovered"),a.prevAll().addClass("hovered"),n.show(),n.text(m[a.index()])},function(){var a=$(this);a.removeClass("hovered"),a.siblings().removeClass("hovered"),n.hide()}),d.unbind(),d.gsInputLen(function(a){a>=10&&g.hide();var b=h-a;if(-1>=b){var c=d.val(),f=$.gsSubstring(c,h,1);d.val(f),e.html(0)}else e.html(b)});var o=f(a.pinglun,1);o?(d.focus(),o=b(o),d.val(o),d.trigger("focus")):(d.val(""),d.placeholder()),j.unbind("click"),i.unbind("click"),j.bind("click",function(){$.popupbox.close(),a=null}),i.bind("click",function(){var b=1;0==c.find("#zongtiPoint").val()&&($("#zongtiPointVerify").show(),b=0),a.isViewpoint||(0==c.find("#kouweiPoint").val()&&($("#kouweiPointVerify").show(),b=0),0==c.find("#fengweiPoint").val()&&($("#fengweiPointVerify").show(),b=0),0==c.find("#fuwuPoint").val()&&($("#fuwuPointVerify").show(),b=0),""==c.find("#xiaofei").val()&&($("#fraction-avgVerify").show(),b=0));var e=d.val();if((""==e||"你的点评会帮助到千万网友哦～"==e||e.length<10)&&(g.show(),b=0),b){obj={},obj.zongtiPoint=c.find("#zongtiPoint").val()||0,obj.kouweiPoint=c.find("#kouweiPoint").val()||0,obj.fuwuPoint=c.find("#fuwuPoint").val()||0,obj.fengweiPoint=c.find("#fengweiPoint").val()||0,obj.xiaofei=c.find("#xiaofei").val()||0,obj.pinglun=d.val()||0,$.popupbox.close();var f=encodeURIComponent(obj.pinglun);$.post(INTERFACE.POICommentAddOrEdit,{travelId:INTERFACE.TravelId,contentId:a.contentId,commentId:a.commentId,travelPOIId:a.travelPOIId,businessType:a.businessType,isCustom:a.isCustom,allRating:obj.zongtiPoint,foodRating:obj.kouweiPoint,serviceRating:obj.fuwuPoint,atmosphereRating:obj.fengweiPoint,avgPrice:obj.xiaofei,data:f},function(b){b&&b.RetCode&&1==b.RetCode?(obj.commentId=b.Html,a.callback(obj),clearTimeout(l),a=null):(c.find(".fr span").fadeIn(200),l=setTimeout(k,3e3))})}})}function d(){var a=$(".edit_botfixed"),b=$(".t_step_4"),c=parseInt(b.offset().top,10),d=c+b.height();botfixedHiehgt=a.height(),st=$(window).scrollTop(),maxLastPos=d-($(window).height()-botfixedHiehgt),a.css(st>maxLastPos?{position:"absolute",bottom:"auto",top:d}:{position:"fixed",bottom:"0",top:"auto"})}var e=function(a,b,c){return a.replace(new RegExp(b,"igm"),c)},f=function(a,b){var c=["<BR>","\r\n"],d=["<BR>","\n"],f=["&nbsp;"," "],g=0===b?1:0,h=e(a,c[g],c[b]),i=e(h,d[g],d[b]),j=e(i,f[g],f[b]);return j},g=function(){{var a=$(".edit_botfixed p span.time"),b=new Date,c=(b.getMonth()+1,b.getDate()+""),d=b.getHours()+"",e=b.getMinutes()+"";b.getSeconds()+""}c=1==c.length?"0"+c:c,d=1==d.length?"0"+d:d,e=1==e.length?"0"+e:e;var f="自动保存于&nbsp;"+d+":"+e;a.html(f)};$(".edit_botfixed .save_drafts").click(function(){$(this);g();var a=$(".edit_botfixed").find(".time").text();_str=a.replace(/^自动保存于/g,"保存于"),$(".edit_botfixed").find(".time").text(_str),$.gs_alert({text:'草稿保存成功，可到<a href="'+INTERFACE.MemberUrl+'" target="_blank">个人主页</a>中查看。',time:3e3,hasCloseBtn:!0,hasDetermineBtn:!1,width:"auto"})}),$(".edit_botfixed dl").width(1==$(".submit_go").length?470:600);var h=null;$(".edit_botfixed .submit_go").click(function(){function a(){for(var a=f.length,b=0;a>b;b++){var c=f[b],e=c.parent();if(c.removeClass("red-border"),c.parents(".addtagbox").length){var g=c.parents(".addtagbox").siblings(".tag-tip");g.hide(),d(),g.text("标签请控制在10个字以内")}else e.find("div[data-id='save-tip']").hide(),e.find(".msg").show()}}clearTimeout(j),clearTimeout(h);var b=!0,c=$(".daybox.editbox").find(".textarea"),e=null,f=[];if(c.each(function(){var a=$(this);if(a.is(":visible"))if(b=!1,f.push(a),e=e?e:a,a.addClass("red-border"),a.parents(".addtagbox").length){var c=a.parents(".addtagbox").siblings(".tag-tip");c.text("请保存内容"),c.show(),d()}else{var g=$('<div data-id="save-tip" style="margin-left:20px;line-height:30px;color:#B94A48;float:right;font-size: 12px;">请保存内容</div>'),h=a.parent();h.find(".msg").hide();var i=h.find("div[data-id='save-tip']");0===i.length?g.appendTo(h):(i.show(),g=i)}}),e){var g=e.offset().top;$("body,html").animate({scrollTop:g-60},800)}if(h=setTimeout(a,3e3),b){var i=$(this);$.post(INTERFACE.ReleaseTravel,{travelId:INTERFACE.TravelId,stepNo:100},function(a){a&&a.RetCode&&1==a.RetCode?window.location.href=INTERFACE.GoToNextStep+"&score="+a.Html:$.gs_alert({text:"发表游记失败，请重试！"})}),i.gsdisable({disable:"submit_go gsn-btn-20-load",time:2e4,text:'<img class="btn_ajax" src="http://youresource.c-ctrip.com/img/load.gif" alt="...">正在提交',callback:function(){}})}}),$('.singledes[data-id="chanGuanAssess"] a').on("click",function(){var b={},d=$(this).parent(),e=d.siblings("ul").find("li"),h=$(this).parents(".singledes").attr("data-contentId")||0,i=$(this).parents(".singledes").attr("data-commentId")||0;travelPOIId=$(this).parents(".singledes").attr("data-travelPOIId")||0,businessType=$(this).parents(".singledes").attr("data-businessType")||0,isCustom=$(this).parents(".singledes").attr("data-isCustom")||0,b.isViewpoint=!1,b.contentId=h,b.commentId=i,b.travelPOIId=travelPOIId,b.businessType=businessType,b.isCustom=isCustom,$(this).hasClass("edit_comment")&&(b.zongtiPoint=parseInt(e.find("span[data-name='gs_zongtiPoint']").css("width"),10)/14,b.kouweiPoint=e.find("span[data-name='gs_kouweiPoint']").text(),b.fengweiPoint=e.find("span[data-name='gs_fengweiPoint']").text(),b.fuwuPoint=e.find("span[data-name='gs_fuwuPoint']").text(),b.xiaofei=e.find("span[data-name='gs_xiaofei']").text(),b.pinglun=d.siblings("p[data-name='gs_pinglun']").html()),b.callback=function(b){e.find("span[data-name='gs_zongtiPoint']").css({width:14*b.zongtiPoint}),e.find("span[data-name='gs_kouweiPoint']").text(b.kouweiPoint),e.find("span[data-name='gs_fengweiPoint']").text(b.fengweiPoint),e.find("span[data-name='gs_fuwuPoint']").text(b.fuwuPoint),e.find("span[data-name='gs_xiaofei']").text(b.xiaofei);var c=b.pinglun.replace(/[\s\n\r\t]*$/,"");c=a(c),c=f(c,0),d.siblings("p[data-name='gs_pinglun']").html(c),d.parents(".singledes").attr("data-commentId",b.commentId),d.siblings("ul").show(),d.parent().find("h3 a").hide(),d.parent().find("p").show(),g()},c(b)}),$('.singledes[data-id="jingDianAssess"] a').click(function(){var b={},d=$(this).parent(),e=d.siblings("ul").find("li");contentId=$(this).parents(".singledes").attr("data-contentId")||0,commentId=$(this).parents(".singledes").attr("data-commentId")||0,travelPOIId=$(this).parents(".singledes").attr("data-travelPOIId")||0,businessType=$(this).parents(".singledes").attr("data-businessType")||0,isCustom=$(this).parents(".singledes").attr("data-isCustom")||0,b.contentId=contentId,b.commentId=commentId,b.travelPOIId=travelPOIId,b.businessType=businessType,b.isCustom=isCustom,$(this).hasClass("edit_comment")&&(b.zongtiPoint=parseInt(e.find("span[data-name='gs_zongtiPoint']").css("width"),10)/14,b.kouweiPoint=0,b.fengweiPoint=0,b.fuwuPoint=0,b.xiaofei=0,b.pinglun=d.siblings("p[data-name='gs_pinglun']").html()),b.callback=function(b){d.siblings("ul").show(),d.parent().find("h3 a").hide(),d.parent().find("p").show(),e.find("span[data-name='gs_zongtiPoint']").css({width:14*b.zongtiPoint});var c=b.pinglun.replace(/[\s\n\r\t]*$/,"");c=a(c),c=f(c,0),d.siblings("p[data-name='gs_pinglun']").html(c),d.parents(".singledes").attr("data-commentId",b.commentId),g()},c(b)});var i=null;$("#xiaofei").unbind(),$("#xiaofei").change(function(){clearTimeout(i),$("#fraction-avgVerify").hide()}),$("#xiaofei").bind("paste",function(){var a=$(this);i=setTimeout(function(){var b=a.val();b=b.replace(/^0+|[^\d]/g,""),a.val(b)},100)});var j=null;$('.addtagbox[data-id="addTagBox"]').inlineEdit({maxlen:0,type:"input",btnYes:{text:"保存",classname:"gsn-btn-2"},btnNo:{text:"取消",classname:"editcancel"},beginFN:function(a){$(a).find(".textundis").text(""),$(a).find(".textarea").val(""),d();var b=$(a).find(".textarea");b.bind("keyup change mousedown blur focus",function(){function c(){$(a).siblings(".tag-tip").hide(),d()}var e=b.val(),f=e.replace(/\s/gi,"x").replace(/[^x00-xff]/g,"xx"),g=Math.ceil(f.length/2);if(g>10){clearTimeout(j),$(a).siblings(".tag-tip").text("标签请控制在10个字以内"),$(a).siblings(".tag-tip").show(),d();var h=$.gsSubstring(e,10,1);b.val(h),j=setTimeout(c,3e3)}})},endFN:function(a){clearTimeout(j);var b=$(a),c=!0,e=null;$(a).siblings(".tag-tip").hide(),d(),b.find(".textundis").css("display","none");var f=$(a).find(" .textundis").text();f=$.trim(f);var h=$(a).siblings("ul");if(h.find("li").each(function(){var a=$(this).find("a").text();f==a&&($(this).hasClass("current")?c=!1:($(this).addClass("current"),e=$(this)))}),""!==f&&c){var i=null;e?i=e:(i=$('<li class="current"><a href="javascript:;" data-tagqouteid="0" data-tagid="0">'+f+"</a></li>"),$(".edit_tag ul").append(i));var k=encodeURIComponent(f),l=i.find("a").attr("data-tagId")||0;$.post(INTERFACE.AddTravelTag,{travelId:INTERFACE.TravelId,tagId:l,data:k},function(a){if(a&&a.RetCode&&1==a.RetCode){var b=a.Html;i.find("a").attr("data-tagQuoteId",b),g()}else e?e.removeClass("current"):i.remove(),$.gs_alert({text:"添加标签失败！"})})}d()}}),$(".addpictext").inlineEdit({maxlen:140,btnYes:{text:"保存",classname:"gsn-btn-2"},btnNo:{text:"取消",classname:"editcancel"},beginFN:function(a){d();var c=$.trim($(a).find("div[data-text]").html()),e=f(c,1);e=b(e),$(a).find(".textarea").val(e)},endFN:function(b,c,e,h){d();var i=$(b);if(""!=c?$(b).find(" .link_addpictxt span").hide():i.find(" .link_addpictxt span").show(),"yes"==h){var j=i.attr("data-nextId")||0,k=i.attr("data-contentId")||0,l=i.attr("data-scheduleId")||0,m=encodeURIComponent(c);$.post(INTERFACE.EditImageDesc,{travelId:INTERFACE.TravelId,nextId:j,contentId:k,scheduleId:l,data:m},function(a){if(a&&a.RetCode&&1==a.RetCode)g(),$(b).find("a[data-edit]").attr("title","编辑照片描述");else{var c=i.find("div[data-text]"),d=i.find(".textareaframe .textarea");c.html(e),d.val(e),""!=e?$(b).find(" .link_addpictxt span").hide():i.find(" .link_addpictxt span").show(),$.gs_alert({text:"文字保存失败！"})}});var n=c.replace(/[\s\n\r\t]*$/,"");n=a(n),n=f(n,0),$(b).find("div[data-text]").html(n)}else $(b).find("div[data-text]").html(e)}}),$('.edittitle[data-id="journalTitle"]').inlineEdit({maxlen:50,type:"input",btnYes:{text:"保存",classname:"gsn-btn-2"},btnNo:{text:"取消",classname:"editcancel"},beginFN:function(a){var c=$.trim($(a).find("div[data-text]").html()),e=f(c,1);e=b(e);var g=$(a).find(".textarea");g.val(e),d()},endFN:function(b,c,e,h){d();var i=$(b);if("yes"==h){var j=i.attr("data-nextId")||0,k=i.attr("data-contentId")||0,l=i.attr("data-scheduleId")||0;if(c=$.trim(c),""==c)return $.gs_alert({text:"标题不能为空！"}),void $(b).find("div[data-text]").html(e);var m=encodeURIComponent(c);$.post(INTERFACE.UpdateTravelTitleAPI,{travelId:INTERFACE.TravelId,nextId:j,contentId:k,scheduleId:l,data:m},function(a){if(a&&a.RetCode&&1==a.RetCode){var c=a.Html;i.attr("data-contentId",c),g(),$(b).find("a[data-edit]").attr("title","编辑游记标题")}else{var d=i.find("div[data-text]"),f=i.find(".textareaframe .textarea");d.html(e),f.val(e),$.gs_alert({text:"标题保存失败！"})}}),htmlData=a(c),htmlData=f(htmlData,0),$(b).find("div[data-text]").html(htmlData)}else $(b).find("div[data-text]").html(e)}}),$(".addtxtline").add(".daytext").inlineEdit({maxlen:1e3,beginFN:function(a){$(a).removeClass().addClass("addtext"),d();var c=$.trim($(a).find("div[data-text]").html()),e=f(c,1);e=b(e);var g=$(a).find(".textarea");g.val(e),g.attr("placeholder")||g.attr("placeholder","记录旅途中的点点滴滴…"),g.placeholder()},endFN:function(b,c,e,h){var i=$(b);if(""==c||"记录旅途中的点点滴滴…"==c?(i.removeClass().addClass("addtxtline"),i.find("a.normaltext").removeClass("edit_title").html("<strong></strong>添加游记正文")):i.removeClass().addClass("daytext").find(" .normaltext").addClass("edit_title").text(""),d(),"yes"==h){var j=i.attr("data-nextId")||0,k=i.attr("data-contentId")||0,l=i.attr("data-scheduleId")||0;"记录旅途中的点点滴滴…"==c&&(c="");var m=c,n=encodeURIComponent(c);$.post(INTERFACE.TextAddOrEdit,{travelId:INTERFACE.TravelId,nextId:j,contentId:k,scheduleId:l,data:n},function(a){if(a&&a.RetCode&&1==a.RetCode){var c=a.Html;if(i.attr("data-contentId",c),g(),$(b).find("a[data-edit]").attr("title","编辑游记正文"),""==m){var d=i.prev(),f=i.next();(d.hasClass("daytext")||d.hasClass("addtxtline")||f.hasClass("daytext")||f.hasClass("addtxtline"))&&i.remove()}}else{var h=i.find("div[data-text]"),j=i.find(".textareaframe .textarea");h.html(e),j.val(e),""!=e?i.removeClass().addClass("daytext").find(" .normaltext").addClass("edit_title").text(""):(i.removeClass().addClass("addtxtline"),i.find("a.normaltext").removeClass("edit_title").html("<strong></strong>添加游记正文")),$.gs_alert({text:"文字保存失败！"})}});var o=c.replace(/[\s\n\r\t]*$/,"");o=a(o),o=f(o,0),$(b).find("div[data-text]").html(o)}else $(b).find("div[data-text]").html(e)},btnYes:{text:"保存",classname:"gsn-btn-2"},btnNo:{text:"取消",classname:"editcancel"}}),$(".singleimg .toggleimgbox").toggle(function(){$(this).find(".bottomline").children("span").addClass("packup").html("收起"),$(this).css({height:"auto"}),d()},function(){$(this).find(".bottomline").children("span").removeClass("packup").addClass("develop").html("展开"),$(this).css({height:"200px"}),d()
}),$(".singleimg .edit_optips .close").click(function(){$(this).parent().fadeOut(300),$.post(INTERFACE.CloseTravelTips,{type:1})}),$(".singleimg .edit_optips").click(function(a){a&&a.stopPropagation?a.stopPropagation():window.event.cancelBubble=!0}),function(){var a=$(window).scrollTop(),b=$(".t_step_4"),c=$(".edit_botfixed"),d=parseInt(b.offset().top,10),e=c.height(),f=d+b.height(),g=f-($(window).height()-e),h=function(){c.css({position:"fixed",bottom:"0",top:"auto"})},i=function(a){c.css({position:"absolute",bottom:"auto",top:a})};a>g&&i(f),$(window).scroll(function(){a=$(window).scrollTop(),f=d+b.height(),g=f-($(window).height()-e),a>g?GS.throttle(i(f),500):GS.throttle(h(),500)})}(),$(document).on("click",".edit_tag li",function(){function a(){b.data("stop",!1)}var b=$(this),c=null;if(!b.data("stop")){var d=b.find("a");if(b.hasClass("current")){var e=d.attr("data-tagQuoteId")||0;$.post(INTERFACE.RemoveTravelTag,{travelId:INTERFACE.TravelId,tagQuoteId:e},function(a){a&&a.RetCode&&1==a.RetCode?(g(),b.removeClass("current")):$.gs_alert({text:"标签设置失败！"})})}else{var f=$("#editTag").find(".current").length;if(f>=10)return $("#editTag").find(".gsn-formerr").show(),!1;var h=encodeURIComponent(d.text()),i=d.attr("data-tagId")||0;$.post(INTERFACE.AddTravelTag,{travelId:INTERFACE.TravelId,tagId:i,data:h},function(a){if(a&&a.RetCode&&1==a.RetCode){var c=a.Html;d.attr("data-tagQuoteId",c),g(),b.addClass("current")}else $.gs_alert({text:"标签设置失败！"})})}b.data("stop",!0),clearTimeout(c),c=setTimeout(a,2e3)}}),function(){for(var a=$(".edit_botfixed dl"),b=$(".dayframe").length,c=0,d=1;b>c;c++){d=c+1;var e=$(".dayframe").eq(c).attr("id");if(e=parseInt(e.substring(3,e.length),10),0!=e){var f='<dd><a data-id="day'+e+'" href="javascript:;">第'+e+"天</a>";f+=c!=b-1?"&gt;</dd>":"</dd>",a.append(f)}}a.find("dd a").click(function(){var a=$(this),b=a.attr("data-id"),c=$("#"+b),d=c.offset().top;$("body,html").animate({scrollTop:d},800)})}(),$(".singleimg .setcover").click(function(){var a=$(this),b=a.parents(".singleimg").attr("data-contentId")||"";b=""==b?0:b,$.post(INTERFACE.SetTravelCoverImageId,{travelId:INTERFACE.TravelId,contentId:b,isOn:!0},function(b){b&&b.RetCode&&1==b.RetCode&&($(".singleimg .coverpic").hide(),a.siblings(".coverpic").show(),a.hide(),g())})}),$(".singleimg").hover(function(){var a=$(this);"none"==a.find(".coverpic").css("display")&&a.find(".setcover").show()},function(){var a=$(this);a.find(".setcover").hide()}),$(".imglink img").lazyload()}),$(function(){var a=$("#travel_name"),b=($("#len_span span").html(),$(".travel_template"));a.gsInputLen(function(c){var d=c;if(d>=51){var e=$.gsSubstring(a.val(),50,1);a.val(e)}else $("#len_span span").html(d);/\S/g.test(a.val())&&"好名字会让你的游记脱颖而出引人注目"!==a.val()?(b.removeClass("disable"),b.find("a").each(function(){var a=$(this).attr("data-href");$(this).attr("href",a)})):(b.addClass("disable"),b.find("a").removeAttr("href"))}),a.placeholder()}),function($){function deleteObj(a,b){a.animate({opacity:0,width:0},600,function(){INTERFACE.del_img_poi_api($.toJSON({TravelContentId:a.attr("data-travelcontentid")})),b(a),$.unknown_photo_num(el)})}function poiChange(a){var b=a.attr("data-poi"),c=$("#imagesCount").text();$("#imagesCount").text(c-1),a.remove(),$.poi_state(b)}function imgChange(a){var b=a.attr("id"),c=parentObj(a),d=c.find(".t_photos[data-poi="+b+"]"),e=$("#imagesCount").text(),f=c.find(".day_date input").val();if($("#imagesCount").text(e-d.length),a.add(d).remove(),c.find(".sort_ui:first").trigger("click"),0==c.find(".t_photos").length&&c.find(".photo_null").html(_alert.phot_02).show(),c.find(".photo_null").children().is("a"))if(0==c.find(".sort_ui").length)c.find(".photo_null a").attr("href",writetravelajax.AddPotoUrl+f+"&dayid="+c.attr("id"));else{var g=c.find(".sort_ui:first").attr("id"),h=c.find(".sort_ui:first").attr("data-travelcontentid");c.find(".photo_null a").attr("href",writetravelajax.AddPotoUrl+f+"&poicontentid="+h+"&poiid="+g+"&dayid="+c.attr("id"))}}function btnReset(){$("#alert_popup").find(".gsn-btn-2").unbind("click").val("删除"),$("#alert_popup").find("p").show().end().find(".gsn-btn-6").show().add("#alert_popup .close").on("click",function(){$.popupbox.close()})}var _alert={a:"是否删除这一天？",at:"删除行程的同时，这一天内的照片也会被删除。",b:"是否删除该地点？",bt:"删除后，该地点内的照片也会被删除。",c:"是否删除该照片？",d:"对不起，无法删除",dt:"游记至少需要保留一天行程哦。",phot_01:'<i></i><span>请拖动照片进行关联，或</span><a href="#">添加照片</a>',phot_02:'<i></i><span>这一天没有照片，请</span><a href="#">添加照片</a>',phot_03:"<b>太棒了，照片已全部关联，请点击拍摄地点查看照片</b>",data_change_01:'<i class="t_prompt_arrow"></i><a class="close" href="javascript:void(0);">×</a>这个日期已经存在啦！',data_change_02:'<i class="t_prompt_arrow"></i><a class="close" href="javascript:void(0);">×</a>如日期排序被打乱，可<a class="refresh" href="#">刷新</a>页面，系统<br />将自动排序。（内容不会遗失）',data_change_03:'<i class="t_prompt_arrow"></i><a class="close" href="javascript:void(0);">×</a>日期穿越啦！'},el=$(".t_step_3"),parentObj=function(a){return a.parents(".edit_trip")};el.on("mouseover",".poi_dot",function(){$(this).removeClass("new").addClass("over"),$(this).find(".t_edit, .t_delete").show().siblings("b").hide()}).on("mouseout",".poi_dot",function(){$(this).removeClass("over"),$(this).find(".t_edit, .t_delete").hide().siblings("b").show()}).on("click",".poi_dot:not(.add_poi)",function(){if(!$(this).hasClass("on")){parentObj($(this)).find(".poi_dot").removeClass("on").find(".arr_t").remove(),$(this).addClass("on").append('<div class="arr_t"></div>');var a=$(this).attr("id"),b=parentObj($(this)).find(".t_photos[data-poi="+a+"]");parentObj($(this)).find(".t_photos").hide().end().find(b).fadeIn(300),$(".ui-draggable").not(".ui-draggable[data-poi="+a+"]").removeClass("on"),$.poi_state(a)}return $.unknown_photo_num(el),!1}),el.on("mouseover",".t_photos",function(){$(this).find(".t_p_show").show()}).on("mouseout",".t_photos",function(){$(this).find(".t_p_show").hide()}).on("click",".t_photos",function(){$(this).toggleClass("ui-selected")}),el.on("click",".t_day .t_edit",function(){$("body").selectable("destroy");var a=parentObj($(this)),b=a.find(".day_date input"),c=b.index(".day_date input"),d=b.val();return b.calendar({foretime:"no",callback:function(){for(var e=b.val(),f=$(".day_date input"),g=b.parent().siblings(".day_num").offset(),h=new Date(e.replace(/-/g,"/")),i=0,j=0;j<f.length;j++){var k=new Date($(f[j]).val().replace(/-/g,"/"));c==j||h.toString()!==k.toString()||(i=1)}if(i)b.val(d),$("#d_prompt").css({width:120,top:g.top-43,left:g.left-14}).html(_alert.data_change_01).fadeIn(300),setTimeout(function(){$("#d_prompt").fadeOut(300)},3e3);else if(h>new Date)$("#d_prompt").css({width:75,top:g.top-43,left:g.left-14}).html(_alert.data_change_03).fadeIn(300),b.val(d),setTimeout(function(){$("#d_prompt").fadeOut(300)},3e3);else{INTERFACE.edit_day($.toJSON({ArgType:"1",ScheduleId:b.parents(".edit_trip").attr("id").replace("day",""),TravelId:INTERFACE.TravelId,ScheduleDate:b.val()}));var l=a.find(".poi_dot.on").attr("id"),m=void 0==l?"":"&poiid="+l,n=$("#"+l).attr("data-travelcontentid"),o=b.val(),p=o.match(/-[\d]{1}\b/g);if(null!=p)for(var j=0;j<p.length;j++){var q=p[j].replace("-","-0");o=o.replace(/-[\d]{1}\b/,q)}b.val(o),a.find(".photo_null a").attr("href",writetravelajax.AddPotoUrl+o+"&poicontentid="+n+m+"&dayid="+a.attr("id"));var r=["星期天","星期一","星期二","星期三","星期四","星期五","星期六"],s=new Date(o.replace(/-/g,"/"));b.attr("title",r[s.getDay()]),"0"==INTERFACE.IsCloseDateUpdateTips&&$("#d_prompt").css({width:210,top:g.top-60,left:g.left-14}).html(_alert.data_change_02).fadeIn(300).find(".refresh").attr("href",writetravelajax.LocUrl)}}}).focus(),b.off("focus"),!1}),el.on("blur",".day_date input",function(){$("body").selectable(window.selectable_opt)}),$("#d_prompt").on("click",".close",function(){$(this).parent().fadeOut(300)}),el.on("click",".t_day .t_delete",function(){btnReset(),$("#d_prompt").hide();var a=parentObj($(this));$(".edit_trip").length>1?($("#alert_popup").find("h3").html(_alert.a).end().find("p").html(_alert.at),$("#alert_popup").find(".gsn-btn-2").on("click",function(){INTERFACE.edit_day($.toJSON({ArgType:"2",ScheduleId:a.attr("id").replace("day",""),TravelId:INTERFACE.TravelId})),a.fadeOut(600,function(){a.remove();var b=el.find(".t_photos").length;$("#imagesCount").text(b),$.unknown_photo_num(el)}),$.popupbox.close()})):($("#alert_popup").find("h3").html(_alert.d).end().find("p").html(_alert.dt),$("#alert_popup").find(".gsn-btn-2").val("确定").on("click",function(){$.popupbox.close()}),$("#alert_popup").find(".gsn-btn-6").hide()),$.popupbox.show({id:"alert_popup"})}),el.find(".t_photos .t_delete").on("click",function(){btnReset();var a=$(this).parents(".t_photos");return $("#alert_popup").find("h3").html(_alert.c).end().find("p").hide(),$("#alert_popup").find(".gsn-btn-2").on("click",function(){deleteObj(a,poiChange),$.popupbox.close()}),$.popupbox.show({id:"alert_popup"}),!1}),el.on("click",".poi_dot .t_delete",function(){btnReset();var a=$(this).parent(".poi_dot");return $("#alert_popup").find("h3").html(_alert.b).end().find("p").html(_alert.bt),$("#alert_popup").find(".gsn-btn-2").on("click",function(){deleteObj(a,imgChange),$.popupbox.close()}),$.popupbox.show({id:"alert_popup"}),!1}),el.on("click",".poi_dot .t_edit",function(){return $("#poi_popup").data("edit_day_id",parentObj($(this)).attr("id")),$("#poi_popup").data("poi_id",$(this).parent(".poi_dot").attr("id")).find("h3").html("修改拍摄地点"),$.reset_poi_popup(),$.popupbox.show({id:"poi_popup"}),$("#btnAddPoi").width(450).focus().siblings("span").text($(this).siblings("p").text()).show(),$(".guess_address").find("h4").hide(),!1}),el.on("click",".add_poi",function(){var dayId=parentObj($(this)).attr("id");INTERFACE.guess_new_poi({TravelId:INTERFACE.TravelId,ScheduleId:dayId.replace("day","")},function(data){var dom=[],data=eval(data.Html);if(data){for(var i=0;i<data.length;i++){var title=data[i].name+(null==data[i].districtname?"":" ,"+data[i].districtname),typeName="";switch(data[i].type){case 3:typeName="jingdian";break;case 5:typeName="gouwu";break;case 1:typeName="zhusu";break;case 2:typeName="canyin";break;default:continue}dom.push('<a href="javascript:;" class="'+typeName+'" title="'+title+'" data-id="'+data[i].id+'" data-name="'+data[i].name+'" data-districtid="'+data[i].districtid+'" data-districtname="'+data[i].districtname+'">'+data[i].shortname+"</a>")}$("#poi_popup").find(".guess_address_inner").css("overflow","hidden").append($(dom.join("")))}0==$(".guess_address").find(".jingdian").length&&$(".guess_address").find("h4").hide(),$("#poi_popup").find(".guess_address").css($(".guess_address_inner").height()>120?{"overflow-y":"scroll","overflow-x":"hidden"}:{"overflow-y":"hidden","overflow-x":"hidden"})}),$("#poi_popup").data("edit_day_id",dayId),$("#poi_popup").data("poi_id",!1).find("h3").html("添加拍摄地点"),$.reset_poi_popup(),$.popupbox.show({id:"poi_popup"}),$("#btnAddPoi").width(130).focus()}),$("#add_day").on("click",function(){for(var a=$("#add_day").offset(),b=el.find(".day_date input"),c=0,d=0;d<b.length;d++){var e=new Date($(b[d]).val().replace(/-/g,"/"));e.getFullYear()!=(new Date).getFullYear()||e.getMonth()!=(new Date).getMonth()||e.getDate()!=(new Date).getDate()||(c=1)}return c?($("#d_prompt").css({width:75,top:a.top-48,left:a.left-10}).html(_alert.data_change_03).fadeIn(300),setTimeout(function(){$("#d_prompt").fadeOut(300)},3e3),!1):"0"==$(this).attr("data-submit")?!1:($(this).attr("data-submit","0"),void INTERFACE.date_api($.toJSON({ArgType:"0",TravelId:INTERFACE.TravelId}),function(a){if(null!=a){var b=$(".edit_trip").last().clone();$(".btn_center").before(b.fadeIn(600)),b.attr("id","day"+a.ScheduleId),b.find(".day_num span").html(a.Day),b.find(".day_date input").val(a.DateString).attr("title",a.Week),b.find(".t_photos,.sort_ui").remove(),b.find(".photo_null").html(_alert.phot_02).show(),b.find(".photo_null a").attr("href",writetravelajax.AddPotoUrl+b.find(".day_date input").val()+"&dayid=day"+a.ScheduleId),$("#add_day").attr("data-submit","1")}}))}),$.poi_state=function(a){var b=$("#"+a),c=b.attr("data-travelcontentid"),d=parentObj(b),e=d.find(".photo_null"),f=d.find(".t_photos[data-poi="+a+"]"),g=d.find(".day_date input").val();b.find("b").text(f.length),"1"==b.attr("data-unknown")&&0==f.length&&deleteObj(b,imgChange),0==d.find(".t_photos").length?e.html(_alert.phot_02).show():0==f.length?e.html("1"==b.attr("data-unknown")?_alert.phot_03:_alert.phot_01).show():e.hide(),e.children().is("a")&&e.find("a").attr("href",writetravelajax.AddPotoUrl+g+"&poicontentid="+c+"&poiid="+a+"&dayid="+d.attr("id"))},$.unknown_photo_num=function(a){var b=a.find('.t_photos[data-unknown="1"]').length;$("#unknown_photo").text(b),0==b?$(".det_alert").hide():$(".det_alert").show()};var _poiid=window.location.href.match(/(poiid=){1}\w+/g),poiid=null==_poiid?"":_poiid[0].replace("poiid=","");poiid&&$("#"+poiid).trigger("click")}(jQuery),function(a){function b(b){INTERFACE.custom_img({imgId:b},function(b){k.css("left",0).find(".select").removeClass("select"),k.prepend('<li><img data-id="'+b.Id+'" data-src="'+b.DataSrc+'" src="'+b.Src+'" /><div class="select"></div></li>'),g.removeClass("gs_btn_v3").text("上传图片").parent(f).siblings(".upLoad_box").hide(),l.find("img").attr("src",b.DataSrc).end().find("p").addClass("move").html("上下拖动可调整封面图位置").siblings("div").show().parents(".set_cover_box").show(),k.find("li").length>7&&j.removeClass("disable"),a("#set_cover").css("margin-top","-258px")})}function c(a){if(1==k.data("moveAble")){var b=parseInt(k.css("left")),c=a?b+490:b-490;k.data("moveAble",0).animate({left:c},300,d)}}function d(){var a=parseInt(k.css("left"))+70;if(a>0?i.addClass("disable"):i.removeClass("disable"),k.find("li").length>7){var b=0-70*(k.find("li").length-9);b>a?j.addClass("disable"):j.removeClass("disable")}k.data("moveAble",1)}document.domain=a("#domainUrl").val();var e=a("#upLoadUrl").val(),f=a(".upLoad_data"),g=a("#upLoadBtn"),h=a("#set_cover_popup"),i=a(".cover_pic_l"),j=a(".cover_pic_r"),k=a(".cover_pic_cont ul").data("moveAble",1),l=a(".cover_show");new AjaxUpload(g[0],{action:e,data:{journalid:INTERFACE.TravelId,typeid:INTERFACE.TypeId,title:INTERFACE.Title,userid:INTERFACE.UserId,"new":1,source:1,type:"journals",token:"78A566F2-AA8A-4C4C-8EE8-F99FB3D4A1D8",randomKey:+new Date},onSubmit:function(a,b){return b&&/^(jpg|jpeg|png)$/.test(b)?(f.find("span").html("图片上传中，请耐心等待 ...").css("color","#999").siblings("img").show(),g.text("重新上传"),g[0].disabled="disabled",void 0):(f.find("span").html("不支持非图片格式！且图片格式必须为jpg，jpeg，png。").css("color","red").siblings("img").hide(),!1)},onComplete:function(a,c){g[0].disabled="";var d=new Function("return "+c.replace(/(<script)+[^<>]*>[^\0]*(<\/script>)+/gm,""))();if("undefined"!=typeof d.error&&""==d.error){var e=d.data[0];if("0"==e.data)return f.find("span").html("Oops, 服务器好像出了点问题 ...").css("color","#cc4200").siblings("img").hide(),g.text("重新上传"),window.console&&console.log("图片服务端无数据返回！请确认服务器端口是否正确！"),!1;var h=e.data;e.width<600?(f.find("span").html("请上传宽度1000px以上的图片来设置封面。").css("color","#cc4200").siblings("img").hide(),g.removeClass("gs_btn_v3").text("重新上传")):e.width>=600&&e.width<1e3?(f.find("span").html("上传宽度1000px以上的图片，封面效果为佳。").css("color","#333").siblings("img").hide(),b(h)):(f.find("span").html("图片上传成功！您也可以重选一张图片。").css("color","#333").siblings("img").hide(),b(h))}else window.console&&console.log("无效的数据")}}),h.on("click",function(){1!=h.data("hasClick")?(h.data("hasClick",1),INTERFACE.img_list(function(b){if(!b.HasImage)return a.popupbox.show({id:"set_cover"}),!1;for(var c="",d="",e=0;e<b.List.length;e++)c+='<li><img data-id="'+b.List[e].Id+'" data-src="'+b.List[e].DataSrc+'" src="'+b.List[e].Src+'" /><div></div></li>';if(a(".set_cover_box").show().find(k).html("").append(c),f.find("span").html("建议封面上传1000px宽度以上的图片。"),g.removeClass("gs_btn_v3").text("上传图片").parent(f).siblings(".upLoad_box").hide(),b.SelectId>0){var h=k.find("img[data-id="+b.SelectId+"]"),m=h.parent("li").index(),n=k.find("li").length%7!=0?parseInt(k.find("li").length/7)+1:k.find("li").length/7;_index=(m+1)%7!=0?parseInt((m+1)/7)+1:(m+1)/7,h.siblings("div").addClass("select"),_index>1&&n>_index&&i.add(j).removeClass("disable"),_index>1&&_index==n&&i.removeClass("disable"),1==_index&&n>1&&j.removeClass("disable"),k.css("left",490*(1-_index)),d=h.attr("data-src")}else k.find("li").length>7&&j.removeClass("disable"),k.find("li:first div").addClass("select"),d=k.find("li:first img").attr("data-src");l.find("img").attr("src",d),l.find("p").addClass("move").html("上下拖动可调整封面图位置").siblings("div").show(),a.popupbox.show({id:"set_cover",callback:function(){a("#set_cover").css("margin-top","-258px")}})})):a.popupbox.show({id:"set_cover"})}),a("#set_cover").on("click",".close, .confirm, .color_white",function(){if(a(this).hasClass("confirm")){var b=k.find(".select").siblings("img").attr("data-id"),c=a(".cover_show").find("img"),d=c.height(),e=parseInt(c.css("top").replace("px",""));INTERFACE.set_cover({imageId:b,coverLocationY:parseInt(e/d*1e4)},function(){window.location.reload(!0)})}return a.popupbox.close(),!1}),l.on("mousedown",".cover_show_mask",function(b){var c=parseInt(l.find("img").css("top")),d=l.find("img").outerHeight(),e=b.pageY;return a(document).bind("mousemove",function(a){var b=parseInt(l.find("img").css("top")),f=a.pageY,g=c-e+f;if(l.children(".cover_show_mask").find("p, div").hide(),200>=d)return!1;if(b>=0){var h=0>e-f?0:g;l.find("img").css("top",h)}else if(200-d>=b){var h=e-f>0?200-d:g;l.find("img").css("top",h)}else l.find("img").css("top",g);return!1}),!1}),a(document).mouseup(function(){l.children(".cover_show_mask").find("p, div").show(),a(document).unbind("mousemove")}),k.on("mouseover","li",function(){var b=a(this).find("div");b.hasClass("select")||b.addClass("hover")}).on("mouseout","li",function(){a(this).find("div").removeClass("hover")}).on("click","li",function(){a(this).siblings("li").find("div").removeClass("select"),a(this).find("div").removeClass("hover").addClass("select");var b=a(this).find("img").attr("data-src");return l.find("img").attr("src",b).css("top",0),!1}),i.on("click",function(){return a(this).hasClass("disable")||c(1),!1}),j.on("click",function(){return a(this).hasClass("disable")||c(0),!1})}(jQuery);var doTime={debug:!1,time:null,s:"",e:"",begin:function(){var a=new Date;this.s=x=a.getTime(),this.log("开始 : "+a.toLocaleTimeString())},end:function(){var a=new Date;this.e=x=a.getTime(),this.log("结束 : "+a.toLocaleTimeString())},cal:function(){var a=this.e-this.s;this.log("运行时间:"+a+"毫秒")},log:function(a){this.debug&&console.log(a)}};!function(a){function b(a){var b=document.createElement("div"),c=document.createTextNode(a);return b.appendChild(c),b.innerHTML}a.editTagArr=function(){var b=[];return a(".edit_tag .current").each(function(){b.push(a(this).find("a").text())}),b=b.join(",")},a.fn.extend({inlineEdit:function(c){return c=a.extend({type:"textarea",maxlen:10,btnYes:{text:"确认",classname:"gsn-btn-2"},btnNo:{text:"取消",classname:"gsn-btn-6"},callback:"",beginFN:"",endFN:""},c),this.each(function(){var d=this,e=(a(this).attr("id"),a.trim(a(d).find("div[data-text]").html())),f=!1,g=function(){if(!f){var b=[];null==e&&b.push('<div data-text="1"></div>'),b.push('<div class="textareaframe" style="display:none">'),b.push("textarea"==c.type?'<textarea class="textarea"></textarea>':'<input type="text" class="textarea" />'),b.push('<a href="javascript:;" data-id="yes" class="'+c.btnYes.classname+'">'+c.btnYes.text+"</a>"),b.push('<a href="javascript:;" data-id="no" class="'+c.btnNo.classname+'">'+c.btnNo.text+"</a>"),c.maxlen>0&&b.push('<div class="msg">还可以输入<span>'+c.maxlen+"</span>字</div>"),b.push("</div>"),a(d).prepend(a(b.join(""))),f=!0}};g();var h=a(this).find("a[data-edit]"),i=a(this).find(".textareaframe"),j=(i.find(".msg"),i.find(".textarea")),k=a(this).find("div[data-text]");if(c.maxlen>0){var l=i.find(".msg").find("span"),m=l.text();j.gsInputLen(function(b){var c=m-b;if(-1>=c){var d=j.val(),e=a.gsSubstring(d,m,1);j.val(e),l.html(0)}else l.html(c)})}h.on("click",function(){return e=a.trim(a(d).find("div[data-text]").html()),j.val(e),doTime.begin(),a(this).hide(),k.hide(),i.show(),"function"==typeof c.beginFN&&c.beginFN(d),doTime.end(),doTime.cal(),j.triggerHandler("focus"),!1});var n=function(a){h.show(),i.hide(),k.show(),"function"==typeof c.endFN&&c.endFN(d,j.val(),e,a)};btnYN=i.find("a"),btnYN.on("click",function(){var b=a(this).attr("data-id");switch(b){case"yes":o();break;case"no":j.val(k.text())}return"function"==typeof c.callback&&c.callback(b),n(b),!1});var o=function(){var a=j.val();a=b(a),k.html(a)}})}})}(jQuery),$(function(){function a(a){return re=/(.*\/)/gi,r=a.match(re),r[0]+"images/swfupload_fp9.swf"}{var b=$("#gs_static_resource").val(),c=$("#gs_uploadurl").val();$("#gs_imgRootPath").val()}window.UEDITOR_CONFIG={UEDITOR_HOME_URL:1==$("#gs_edit_istest").val()?"/js/app/member/ueditor_utf8/":"/j/member/ueditor/",initialContent:$("#addText").val(),initialFrameWidth:"auto",elementPathEnabled:!1,contextMenu:[],zIndex:100,wordCount:0,sourceEditor:"textarea",toolbars:[["bold","horizontal"]],labelMap:{anchor:"",undo:""},lang:"zh-cn-utf8"};var d=UE.getEditor("editor-wrap");d.addListener("ready",function(){var a=$("#addText").val();window.setTimeout(function(){d.setContent(a),iframe_edit_event()},500),JournalAction.init("editor-wrap")}),$.browser.msie&&"10.0"==$.browser.version&&d.ready(function(){window.setTimeout(function(){iframe_edit_event()},500),JournalAction.init("editor-wrap")}),d.addListener("beforePaste",function(a,b){b.html=filterBaiduEdit(b.html),iframe_edit_event()});var e=null,f=function(){e=$("<div>").attr("class","photo-mask").html('<div class="mask-bg"></div>'),titlePagecon=$("<em>").attr("class","mask-name").html("设为封面"),e.append(titlePagecon).appendTo("body")};f(),iframe_edit_event=function(){window.iframe_init=1;var a=$(document.getElementById("baidu_editor_0").contentWindow.document.body),b=$("#baidu_editor_0");a.find("img").live("mouseover",function(){e.css({width:$(this).css("width")}),void 0==$(this).attr("data-id")&&$(this).attr("data-id",(new Date).getTime().toString());var a=$(this).offset().left+b.offset().left,c=$(this).offset().top+b.offset().top,d=$(this).width(),f=($(this).height(),{top:c+12,left:a+2});d>180&&(e.find("em").attr("data-id",$(this).attr("data-id")),e.css(f).show().hover(function(){$(this).show()})),$(this).hasClass("cover")?e.find("em").addClass("ok").html("已设为封面"):e.find("em").removeClass("ok").html("设为封面")}).live("mouseout",function(){e.hide()}),a.live("mouseout",function(){e.hide()}),e.click(function(){var b=$(this).find("em").attr("data-id");return $(this).find("em").addClass("ok").html("已设为封面"),a.find("img").each(function(){b==$(this).attr("data-id")?$(this).attr("cover","selected").addClass("cover"):$(this).removeAttr("cover").removeClass("cover")}),!1})},$(".sideCon").setfixed(),$("#tags-avilable").find("em").click(function(){var a=$("#tag").val()+",",b=$(this).text();if(-1==a.indexOf(b)){var c=$(this).text().trim(),d=$("#tag").val();""!=d&&(d+=","),$("#tag").val(d+c)}return!1});var g={};if(gs_ua.pv[0]){var h,g,i=function(){var a=$("#photolist").find("li").length;"1"==a&&$(".uplpad_info_pic_1").show()},j=(new Date).getTime(),k={debug:!1,flash_url:a(c),upload_url:c,post_params:{type:"journals",typeID:13,token:"78A566F2-AA8A-4C4C-8EE8-F99FB3D4A1D8",randomKey:j},file_size_limit:"10 MB",file_types:"*.jpg;*.jpeg;*.png",file_types_description:"JPG Images",file_upload_limit:0,file_queue_limit:50,button_image_url:b+"/img/member/editor/bg-swfuploadimg.png?"+j,button_width:74,button_height:24,button_placeholder_id:"spanButtonPlaceholder",button_text:'<span class="theFont">&nbsp;</span>',button_text_style:".theFont { font-size: 16; }",button_cursor:SWFUpload.CURSOR.HAND,button_text_left_padding:0,button_text_top_padding:0,file_queued_handler:function(a){this.uploadNumber=this.getStats().files_queued,this.isOverMaxcount=!1,g=this;var b=$('<li class="item" id="'+a.id+'"><span></span><i class="close"></i><a style="display:none" class="btn_cancel" href="javascript:;">取消上传</a></li>');b.hover(function(){$(this).find(".close").show().click(function(){return $(this).parent().remove(),i(),!1})},function(){$(this).find(".close").hide()}),b.bind("click",function(){var a=(d.getContent(),$(this).find("img")),b=a.attr("imgid"),c=$(a).attr("width");if(!isNaN(b)){c>560&&(c=560);var e=a.attr("data-pic"),f='<p><img width="'+c+'" data-id="'+b+'" phsid="'+b+'" src="'+e+'" alt=""></p>';d.execCommand("insertHtml",f),$(this).remove(),iframe_edit_event()}return i(),!1}),b.find("a.btn_cancel").bind("click",function(){try{return this.stopUpload(),this.cancelUpload(),$(this).parent().remove(),!1}catch(a){}}),"none"!==$(".uplpad_info_pic_1").css("display")&&$(".uplpad_info_pic_1").hide(),$("#photolist ul").append(b)},file_queue_error_handler:function(a,b){try{switch(b){case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:try{$("#tipOverMaxcount,.bgbox").show(),g.isOverMaxcount=!0,g.stopUpload()}catch(c){}break;case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:$(".uplpad_info_pic_1").hide();var d='<span class="filename">'+a.name.lastsubCHStr(10)+'</span><span class="errorMsg">文件超过10M</span>';$('<li class="ui-widget-content failed">').append('<span id="'+a.id+'"><strong class="failed"></strong></span>'+d+'<i class="close"></i>').appendTo($("#photolist ul")).hover(function(){$(this).find("i").show()},function(){$(this).find("i").hide()}).find("i").click(function(){return $(this).parent().remove(),i(),!1});break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert("您选择的文件含有其他格式文件");break;default:$(".uplpad_info_pic_1").hide();var d='<span class="filename">'+a.name.lastsubCHStr(10)+'</span><span class="errorMsg">上传失败</span>';$('<li class="ui-widget-content failed">').append('<span id="'+a.id+'"><strong class="failed"></strong></span>'+d+'<i class="close"></i>').appendTo($("#photolist ul")).hover(function(){$(this).find("i").show()},function(){$(this).find("i").hide()}).find("i").click(function(){return $(this).parent().remove(),!1})}}catch(c){this.debug(c)}},file_dialog_complete_handler:function(a,b){try{b>0&&(this.startUpload(),doTime.begin())}catch(c){}},upload_start_handler:function(){},upload_progress_handler:function(a,b,c){var d=Math.ceil(b/c*100);$("#"+a.id+" span").html(d+"%")},upload_error_handler:function(a,b){SWFUpload.UPLOAD_ERROR.FILE_CANCELLED==b&&g.isOverMaxcount&&$("#"+a.id).remove()},upload_success_handler:function(a,b){doTime.end(),doTime.cal(),doTime.begin();var c=new Function("return "+b.replace(/(<script)+[^<>]*>[^\0]*(<\/script>)+/gm,""))();if("undefined"!=typeof c.error&&""==c.error){var d=c.data[0],e='<img data-pic="'+d.metalUrl+'" imgid="'+d.data+'" src="'+d.thumbUrl+'" width="'+d.width+'" alt="">';$("#"+a.id+" span").html($(e)),doTime.end()}else alert("无效的数据");doTime.cal()},upload_complete_handler:function(a){$("#"+a.id).find("a").hide()},queue_complete_handler:function(){}};h=new SWFUpload(k)}else $(".btn-upload").html('请安装或启用<a href="http://www.adobe.com/go/getflashplayer/" target="_blank">Flash组件</a>');var l=null;$('.addtagbox[data-id="addTagBox"]').inlineEdit({maxlen:0,type:"input",btnYes:{text:"保存",classname:"gsn-btn-2"},btnNo:{text:"取消",classname:"editcancel"},beginFN:function(a){$(a).find(".textundis").text(""),$(a).find(".textarea").val("").focus();var b=$(a).find(".textarea");b.bind("keyup change mousedown blur focus",function(){function c(){$(a).siblings(".tag-tip").hide()}var d=b.val().replace(/\,*/g,""),e=d.replace(/\s/gi,"x").replace(/[^x00-xff]/g,"xx"),f=Math.ceil(e.length/2);if(f>10){clearTimeout(l),$(a).siblings(".tag-tip").text("标签请控制在10个字以内").show();var g=$.gsSubstring(d,10,1);b.val(g),l=setTimeout(c,3e3)}else b.val(d)})},endFN:function(a){clearTimeout(l);var b=$(a),c=!0,d=null;$(a).siblings(".tag-tip").hide(),b.find(".textundis").css("display","none");var e=$(a).find(" .textundis").text();e=$.trim(e);var f=$(a).siblings("ul");if(f.find("li").each(function(){var a=$(this).find("a").text();e==a&&($(this).hasClass("current")?c=!1:($(this).addClass("current"),d=$(this)))}),""!==e&&c){var g=null;d?g=d:(g=$('<li class="current"><a href="javascript:;" data-tagqouteid="0" data-tagid="0">'+e+"</a></li>"),$(".edit_tag ul").append(g))}}}),$(document).on("click",".edit_tag li",function(){return $(this).hasClass("current")?$(this).removeClass("current"):$(this).addClass("current"),!1})});