/*! test 2014-05-20 15:46:54 */
$(function(){function a(){"0"==privateObject.CurrentUserId&&$.cookiedb({name:"gs_link_like",value:INTERFACE.TravelId})}function b(){if("0"==privateObject.CurrentUserId){var a=$.cookiedb({name:"gs_link_like",value:INTERFACE.TravelId,isfind:1});if("repeat"==a){$(".top_inbox .btn_like").addClass("click_like").text("已喜欢").attr("title","已喜欢");var b=$(".titlebox .titleright .link_like");b.addClass("click_like").attr("title","已喜欢")}}}function c(a){var b=$(".top_article .des-area");if(b.find("a.first").length||b.append('<a href="/" target="_blank" class="first">攻略社区</a>'),a){var c=a.des,d=a.desLink,e=a.poi,f=a.poiLink,g="";b.find(".first").nextAll().remove(),c&&(g+="<i>/</i>",g+=d?'<a target="_blank" href="'+d+'">'+c+"</a>":"<span>"+c+"</span>"),e&&(g+="<i>/</i>",g+=f?'<a target="_blank" href="'+f+'">'+e+"</a>":"<span>"+e+"</span>"),b.find(".first").after(g)}else 1!==b.find("a").length&&b.find(".first").nextAll().remove()}function d(){function a(a){return p>=a}function b(){o=$(window).scrollTop(),0==s&&(j.each(function(){r.push($(this).offset().top)}),u=r.length-1,maxLastPos=r[u]+j.eq(u).height()-n,s++),o>maxLastPos?GS.throttle(f(),500):GS.throttle(g(o),500)}function d(b){var c=b.index(),d=poiList[c].title,e=poiList[c].name,f=poiList[c].top,g=poiList[c].len,h=0;if(g){l.find(".name-area").empty();for(var i='<div class="mask"></div>';g>h;h++){var j=e[h],k=d[h];i+='<a href="javascript:;" title="'+k+'">'+j+"</a>",h!=g-1&&(i+='<i class="arrow">&gt;</i>')}l.find(".name-area").append(i);var o=m+b.offset().top-t.offset().top,p=b.width(),q=b.offset().left+p;if(l.css({top:o,left:q}),l.show(),l.data("show",1),l.data("dayNum",c),b.hasClass("current")){var r=f.filter(a),s=r.length;if(s>0){var u=f.indexOf(r[s-1]);l.find("a").removeClass("current"),l.find("a").eq(u).addClass("current")}}else l.find("a").removeClass("current");l.find("a").unbind().bind("click",function(){var a=l.find("a").index($(this)),b=f[a]-n+50;$("body,html").animate({scrollTop:b},800)})}}function e(){l.data("show")?clearTimeout(v):l.hide()}function f(){t.hide(),l.data("show",0),l.hide();var a={};c(a)}function g(b){t.show(),p=b+n;var d=r.filter(a),e=d.length;if(e>0){var f=r.indexOf(d[e-1]),g=j.length,o=showNum-1;if(f>-1){if(o>=f?-f>=h&&(h=-f):f>o&&g-o>f?-f>h?h=-f:h>o-f&&(h=o-f):f>=g-o&&h>o-f&&(h=o-f),0>=h){var s=h*i;k.css({top:s})}var u=showNum-g,v=q.eq(f);v.addClass("current").siblings().removeClass("current"),g>showNum&&(0===h?($upbtn.fadeOut(200),"none"==$downbtn.css("display")&&$downbtn.fadeIn(200)):h===u?($downbtn.fadeOut(200),"none"==$upbtn.css("display")&&$upbtn.fadeIn(200)):("none"==$downbtn.css("display")&&$downbtn.fadeIn(200),"none"==$upbtn.css("display")&&$upbtn.fadeIn(200)));var w=poiList[f],x=w.len,y=l.data("show"),z=l.data("dayNum"),A=w.top,B=A.filter(a),e=B.length,C=A.indexOf(B[e-1]),D={};if(C>=0&&(D.des=w.destination[C],D.desLink=w.desLink[C],D.poi=w.name[C],D.poiLink=w.link[C]),c(D),x&&y&&f===z&&e){l.find("a").removeClass("current"),l.find("a").eq(C).addClass("current");var E=m+v.offset().top-t.offset().top,F=parseInt(l.css("top"),10);E!==F&&l.css({top:E})}else l.find("a").removeClass("current")}}}var h=0,i=0,j=$(".daybox .dayframe"),k=$(".daylinkbox ul");showNum=5,$upbtn=$(".daylink .upbtn"),$downbtn=$(".daylink .downbtn"),poiList=[];var l=$("#showPoi"),m=$(".titlebox ").offset().top+$(".titlebox ").outerHeight()+10;$(".daylink").css({top:m,display:"block"});var n=m+50;!function(){function a(){$(".daylink li.current").index();b>showNum&&0!==h&&$upbtn.show(),b>showNum&&h!==u&&$downbtn.show()}var b=j.length,c=null,d=0;for($upbtn.hide(),$downbtn.hide();b>d;d++){var e=j.eq(d),f=e.attr("id");f=f.substring(1,f.length),id=parseInt(f,10);var g="";g=d>0?'<li><a href="javascript:;" data-id="#d'+id+'">'+id+"</a></li>":'<li class="current"><a href="javascript:;" data-id="#d'+id+'">'+id+"</a></li>";var m=$(g);f.length>3?m.find("a").css({"font-size":"16px"}):f.length>2&&m.find("a").css({"font-size":"20px"}),k.append(m);var n=e.find(".singledes"),o=[],p=[],q=[],r=[],s=[],t=[];n.each(function(){var a=$(this),b=$.trim(a.find("h3").text()),c=a.offset().top-40,d=a.find("h3").attr("data-destination")||"",e=$.trim(a.find("h3").attr("data-destination-href")),f=$.trim(a.find("h3 a").attr("href"));d=$.trim(d),b=b.replace(/\'|\"/g,""),o.push(b);var g=b.replace(/\s/gi,"x").replace(/[^x00-xff]/g,"xx");g.length>50&&(b=$.gsSubstring(b,25,1)+"..."),p.push(b),q.push(c),r.push(d),s.push(e),t.push(f)}),poiList.push({name:p,top:q,len:n.length,destination:r,link:t,desLink:s,title:o})}i=k.find("li").outerHeight();var u=showNum-b;0===l.length&&(l=$('<div id="showPoi" class="show-poi"><div class="join-side"></div><div class="name-area"></div></div>'),l.appendTo(document.body)),$upbtn.click(function(){if(clearTimeout(c),b>showNum&&0>h){h+=1;var a=h*i;k.animate({top:a},150)}0===h&&$upbtn.fadeOut(200),"none"==$downbtn.css("display")&&$downbtn.fadeIn(200)}),$downbtn.click(function(){if(clearTimeout(c),b>showNum&&h>u){h-=1;var a=h*i;k.animate({top:a},150)}h===u&&$downbtn.fadeOut(200),"none"==$upbtn.css("display")&&$upbtn.fadeIn(200)}),c=setTimeout(a,10)}();var o,p=0,q=$(".daylink li"),r=[],s=0,t=$(".daylink"),u=maxLastPos=0;"filter"in Array.prototype||(Array.prototype.filter=function(a,b){for(var c,d=[],e=0,f=this.length;f>e;e++)e in this&&a.call(b,c=this[e],e,this)&&d.push(c);return d}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(a,b){void 0===b&&(b=0),0>b&&(b+=this.length),0>b&&(b=0);for(var c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1}),b(),q.click(function(){var a=$(this).index(),b=parseInt(t.css("top"),10),c=r[a]-b+55;$("body,html").animate({scrollTop:c},800)});var v=null;$(".daylink li").hover(function(){d($(this))},function(){var a=$(this).index();poiList[a].len&&($("#showPoi").data("show",0),v=setTimeout(e,50))}),l.hover(function(){l.data("show",1)},function(){l.data("show",0),v=setTimeout(e,50)}),$(window).scroll(function(){b()})}b(),$(".link_like").gsbaselike({api:INTERFACE.likeUrl,callback:function(b){if($(b).parents(".titleright").length>0){var c=$(".top_inbox .btn_like");c.addClass("click_like"),c.text("已喜欢"),c.attr("title","已喜欢")}a()}}),$(".top_inbox .btn_like").gsbaselike({api:INTERFACE.likeUrl,callback:function(b){$(b).text("已喜欢");var c=$(".titlebox .titleright .link_like"),d=c.find("span"),e=parseInt(d.text(),10);e=isNaN(e)?0:e,e++,c.addClass("click_like"),c.attr("title","已喜欢"),d.text(e),a()}}),$(".btn_share").gsbaseshare({api:INTERFACE.shareUrl,fixed:!0,top:35,hasCount:!0,callback:function(){var a=$(".titlebox .link_share span"),b=parseInt(a.text(),10);b=isNaN(b)?0:b,b++,a.text(b)}}),$(".singleimg .link_share").gsbaseshare({api:INTERFACE.shareUrl}),$(".titlebox .link_share").gsbaseshare({api:INTERFACE.shareUrl,hasCount:!0}),$(".img_box .link_share").gsbaseshare({api:INTERFACE.shareUrl}),$(".img_block").hover(function(){$(this).addClass("over").find(".img_text div").css({height:$(this).find(".img_text").height()+"px"}).end().siblings(".img_block.over").removeClass("over");var a=$(this).find("img").width();290>a?$(this).find(".describe").hide():$(this).find(".describe").show()},function(){function a(){"none"!=$("#bdshare").css("display")?b.find(".img_text div").css({height:b.find(".img_text").height()+"px"}):b.removeClass("over").find(".img_text div").css({height:"30px"})}var b=$(this);setTimeout(a,50)}),$(".link_collect").add(".top_inbox .btn_collect").gsbasecollect({api:INTERFACE.collectUrl,callback:function(a){var b=$(a);if($(a).hasClass("btn_collect")){b.text("已收藏");var c=$(".link_collect");c.addClass("click_collect"),c.attr("title","已收藏");var d=c.find("span"),e=parseInt(d.text(),10);e=isNaN(e)?0:e,e++,d.text(e)}else $(".top_inbox .btn_collect").addClass("click_collect"),$(".top_inbox .btn_collect").attr("title","已收藏"),$(".top_inbox .btn_collect").text("已收藏")}}),d();var e=$.browser.msie&&"6.0"==$.browser.version;if(!e){var f=$(".titleright ul").offset().top,g=$(".top_article");$(window).scroll(function(){st=$(window).scrollTop(),st>f?g.show():g.hide()})}$(".imglink img").lazyload({threshold:500,failurelimit:5}),$("#strategy_info").gsnoderoll()});