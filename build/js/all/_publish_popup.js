/*! test 2014-05-20 17:53:46 */
!function(a){function b(){e.find("input").focus().val("");var b=f.find(".over");if(b.length>0){for(var g=b.find(".search_city").text()+"，"+b.find(".search_country").text(),h=b.attr("data-id"),i=c.find(".dest"),j=0;j<i.length;j++)if(h==i.eq(j).attr("data-id"))return f.html("<em>您已添加过该城市</em>").show(),!1;d.find(".add_dest").before(a('<a class="dest selected" data-id="'+h+'" href="javascript:;"><i></i>'+g+"</a>").fadeIn()),f.html("").hide();var k=c.outerHeight();c.css("margin-top",0-k/2),d.find(".dest").length>=12&&(d.find(".add_dest, .search_dest").hide(),d.find(".error_tip").text("您已经添加了足够的目的地").show())}}var c=a("#publish_popup"),d=c.find(".ttd");a(".submit_pop").click(function(){var b=this;1!=c.data("hasClick")&&(c.data("hasClick",1),INTERFACE.classified_info(function(c){var e="";if("1"==a(b).attr("data-release")){d.data("rel",1);for(var f=0;f<c.DistrictList.length;f++){var g=c.DistrictList[f].IsSelected?' selected"><i></i>':'">';e+='<a href="javascript:;" data-id="'+c.DistrictList[f].DistrictId+'" class="dest'+g+c.DistrictList[f].DistrictName+"</a>"}}else{d.data("rel",0);for(var f=0;f<c.TagList.length;f++){var g=c.TagList[f].IsSelected?' selected"><i></i>':'">';e+='<a href="javascript:;" class="dest'+g+c.TagList[f].TagName+"</a>"}}d.prepend(e);var h=0==c.PracticalInfo.TravelDays?"":c.PracticalInfo.TravelDays,i=a("#tpi_who_select").find("a[data-id="+c.PracticalInfo.CompanionType+"]").text(),j=0==c.PracticalInfo.Consume?"":c.PracticalInfo.Consume,k=c.PracticalInfo.DepartureDate;a("#tpi_day").val(h).data("val",h),a("#tpi_who").val(i).data("val",c.PracticalInfo.CompanionType),a("#tpi_cost").val(j).data("val",j),a("#tpi_time").val(k).data("val",k),"1"==a(b).attr("data-release")?d.find(".dest").length>=12?(d.find(".add_dest, .search_dest").hide(),d.find(".error_tip").text("您已经添加了足够的目的地").show()):(d.find(".add_dest").show(),d.find(".search_dest, .error_tip").hide()):d.find(".selected").length>=10?d.find(".error_tip").text("最多可以添加10个分类标签").show():d.find(".error_tip").hide()})),a.popupbox.show({id:"publish_popup",callback:function(){a(".search_dest").find("input").add("#tpi_who, #tpi_time").placeholder(),1==c.data("hasClick")&&d.find(".search_dest, .error_tip").hide()}})}),c.on("click",".close, .cancel",function(){a.popupbox.close()}),c.on("click",".dest",function(){a(this).hasClass("selected")?a(this).removeClass("selected").find("i").remove():a(this).addClass("selected").prepend("<i></i>")});var e=a(".search_dest"),f=a("#search_select"),g=a("#gs_search").val();d.find(".add_dest").click(function(){d.find(".error_tip").hide(),a(this).add(f).hide(),e.show().find("input").focus().val("")}),d.find(".cancel_dest").click(function(){d.find(".add_dest").show(),e.hide()}),f.on("mouseover","a",function(){a(this).addClass("over").siblings().removeClass("over")}).on("click","a",function(){return b(),!1}),e.find("input").blur(function(){1!=f.data("isHover")&&f.html("").hide()}),f.hover(function(){f.data("isHover",1)},function(){f.data("isHover",0)}),e.on("keyup beforepaste ","input",function(b){if(40==b.keyCode||38==b.keyCode||13==b.keyCode)return!1;var c=GS.xssFilter(e.find("input").val());return/\S/g.test(c)?void a.getJSON(g,{para:escape(a.trim(c))},function(a){if(0==a.success){var b=a.destinations,c=[];if(0==a.destinations.length)return f.html("<em>请输入正确的城市名</em>").show(),!1;for(i in b){var d=b[i].name.split("，")[0],e=b[i].name.split("，")[1];c.push('<a data-id="'+b[i].id+'" href="javascript:;"><span class="search_city" title="'+d+'">'+d+'</span>，<span class="search_country" title="'+e+'">'+e+"</span></a>")}f.html(c.join("")).show().find("a:first").addClass("over")}else window.console&&console.log("搜索接口无数据返回，请检查接口配置！")}):(f.html("").hide(),!1)}),e.on("keydown","input",function(a){if(40==a.keyCode||38==a.keyCode){var c=f.find("a");if(0==c.length)return!1;if(c.hasClass("over")){var d=f.find(".over");d.prev("a").is(":first")&&38==a.keyCode?c.last().addClass("over"):d.next("a").is(":last")&&40==a.keyCode?c.first().addClass("over"):38==a.keyCode?d.prev("a").addClass("over"):d.next("a").addClass("over"),d.removeClass("over")}else 38==a.keyCode?c.last().addClass("over"):c.first().addClass("over");return!1}return 13==a.keyCode?(b(),!1):void 0}),a("#tpi_day, #tpi_cost").keyup(function(){/\D|^0+/g.test(a(this).val())&&a(this).val(""),a(this).data("val",a(this).val())});var h=a("#tpi_who"),j=a("#tpi_who_select");h.focus(function(){j.show()}).blur(function(){1!=j.data("isHover")&&j.hide()}),j.find("a").click(function(){h.val(a(this).text()).css("color","#666").data("val",a(this).attr("data-id")),j.hide()}),j.hover(function(){j.data("isHover",1)},function(){j.data("isHover",0)});var k=a("#tpi_time");k.click(function(){k.calendar({foretime:"no",callback:function(){var a=k.val(),b=a.match(/-[\d]{1}\b/g);if(null!=b)for(var c=0;c<b.length;c++){var d=b[c].replace("-","-0");a=a.replace(/-[\d]{1}\b/,d)}k.val(a).css("color","#666").data("val",a)}}).focus()}),a("#publish_submit").click(function(){var b=0==d.find(".selected").length&&1==d.data("rel"),e=new Date(k.val().replace(/-/g,"/"))>new Date;if(b||e)return b?d.find(".error_tip").text("请至少选择1个目的地").show():d.find(".error_tip").hide(),e?a(".tpi_time").find(".error_tip").text("不能选择当天之后日期").show():a(".tpi_time").find(".error_tip").hide(),!1;c.find(".error_tip").hide();var f=a(this),g=[],h=[];if(1==d.data("rel"))d.find(".selected").each(function(){g.push({DistrictId:a(this).attr("data-id"),DistrictName:a(this).text(),IsSelected:!0})});else{var i=d.find(".selected").length;if(i>10)return d.find(".error_tip").text("最多可以添加10个分类标签").show(),!1;d.find(".selected").each(function(){h.push({TagName:a(this).text(),IsSelected:!0})})}var j=""==a("#tpi_day").data("val")?0:a("#tpi_day").data("val"),l=a("#tpi_who").data("val"),m=""==a("#tpi_cost").data("val")?0:a("#tpi_cost").data("val"),n=a("#tpi_time").data("val"),o={TravelDays:j,CompanionType:l,Consume:m,DepartureDate:n};INTERFACE.UpdateTravelExtraInfo({DistrictList:g,TagList:h,PracticalInfo:o},function(){1==d.data("rel")&&a.post(INTERFACE.ReleaseTravel,{travelId:INTERFACE.TravelId,stepNo:100},function(b){b&&b.RetCode&&1==b.RetCode?window.location.href=INTERFACE.GoToNextStep+"&score="+b.Html:a.gs_alert({text:"发表游记失败，请重试！"})}),f.gsdisable({disable:"gs_btn_v4 gsn-btn-20-load",time:2e4,text:'<img class="btn_ajax" src="http://youresource.c-ctrip.com/img/load.gif" alt="...">正在提交',callback:function(){}})})})}(jQuery);