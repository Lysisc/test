/*! test 2014-05-20 17:53:46 */
$(function(){function a(a){if($.browser.msie)return a=a.replace(/&/gim,"&amp;"),a=a.replace(/\</gim,"&lt;"),a=a.replace(/\>/gim,"&gt;");var b=document.createElement("div"),c=document.createTextNode(a);return b.appendChild(c),b.innerHTML}function b(a){if($.browser.msie)return a=a.replace(/&lt;/gim,"<"),a=a.replace(/&gt;/gim,">"),a=a.replace(/&amp;/gim,"&");var b=document.createElement("div");b.innerHTML=a;var c=b.innerText||b.textContent;return b=null,c}function c(a){$.popupbox.show({id:"poi_pingjia",callback:function(){}});var c=$("#poi_pingjia"),d=c.find("#reviewContent"),e=c.find(".input_tips .tips span"),g=c.find(".input_tips .warning"),h=1e3,i=c.find(".fr .gsn-btn-2"),j=c.find(".fr .gsn-btn-6");a=$.extend({isViewpoint:!0,zongtiPoint:0,kouweiPoint:0,fengweiPoint:0,fuwuPoint:0,xiaofei:"",pinglun:"",callback:function(){}},a),c.find(".fr span").hide();var k=function(){c.find(".fr span").fadeOut(200)},l=null;$("#zongtiPointVerify").hide(),$("#kouweiPointVerify").hide(),$("#fengweiPointVerify").hide(),$("#fuwuPointVerify").hide(),$("#fraction-avgVerify").hide(),g.hide(),e.text(1e3),a.isViewpoint?(c.find("h3").text("景点点评"),$(".restaurant").hide()):(c.find("h3").text("餐馆点评"),$(".restaurant").show(),c.find(".for-piont").each(function(b,c){var d=$(c),e=d.find(".cls-set"),f=0,g=d.find(".fraction-num");switch(b){case 0:f=parseInt(a.kouweiPoint,10);break;case 1:f=parseInt(a.fengweiPoint,10);break;case 2:f=parseInt(a.fuwuPoint,10)}e.val(f),g.find("i").removeClass("selected"),g.find("i:lt("+f+")").addClass("selected"),g.find("i").unbind(),g.find("i").bind("click",function(){g.find("i").removeClass("selected");var a=$(this).index()+1;g.find("i:lt("+a+")").addClass("selected"),e.val(a),g.siblings("em").hide()})})),c.find(".fraction-star").find("i").removeClass("selected"),$("#zongtiPoint").val(parseInt(a.zongtiPoint,10)),c.find(".fraction-star").find("i:lt("+parseInt(a.zongtiPoint,10)+")").addClass("selected"),$("#xiaofei").val(""==a.xiaofei||isNaN(a.xiaofei)?"":a.xiaofei);var m=["差","一般","好","很好","推荐"];c.find(".fraction-star i").unbind();var n=c.find(".star-hover-tip");c.find(".fraction-star i").bind("mousedown",function(){$(this).parent().find("i").removeClass("selected");var a=$(this).index()+1;$(this).parent().find("i:lt("+a+")").addClass("selected"),$(this).parent().parent().find(".cls-set").val(a),$("#zongtiPointVerify").hide()}).hover(function(){$("#zongtiPointVerify").hide();var a=$(this);a.addClass("hovered"),a.prevAll().addClass("hovered"),n.show(),n.text(m[a.index()])},function(){var a=$(this);a.removeClass("hovered"),a.siblings().removeClass("hovered"),n.hide()}),d.unbind(),d.gsInputLen(function(a){a>=10&&g.hide();var b=h-a;if(-1>=b){var c=d.val(),f=$.gsSubstring(c,h,1);d.val(f),e.html(0)}else e.html(b)});var o=f(a.pinglun,1);o?(d.focus(),o=b(o),d.val(o),d.trigger("focus")):(d.val(""),d.placeholder()),j.unbind("click"),i.unbind("click"),j.bind("click",function(){$.popupbox.close(),a=null}),i.bind("click",function(){var b=1;0==c.find("#zongtiPoint").val()&&($("#zongtiPointVerify").show(),b=0),a.isViewpoint||(0==c.find("#kouweiPoint").val()&&($("#kouweiPointVerify").show(),b=0),0==c.find("#fengweiPoint").val()&&($("#fengweiPointVerify").show(),b=0),0==c.find("#fuwuPoint").val()&&($("#fuwuPointVerify").show(),b=0),""==c.find("#xiaofei").val()&&($("#fraction-avgVerify").show(),b=0));var e=d.val();if((""==e||"你的点评会帮助到千万网友哦～"==e||e.length<10)&&(g.show(),b=0),b){obj={},obj.zongtiPoint=c.find("#zongtiPoint").val()||0,obj.kouweiPoint=c.find("#kouweiPoint").val()||0,obj.fuwuPoint=c.find("#fuwuPoint").val()||0,obj.fengweiPoint=c.find("#fengweiPoint").val()||0,obj.xiaofei=c.find("#xiaofei").val()||0,obj.pinglun=d.val()||0,$.popupbox.close();var f=encodeURIComponent(obj.pinglun);$.post(INTERFACE.POICommentAddOrEdit,{travelId:INTERFACE.TravelId,contentId:a.contentId,commentId:a.commentId,travelPOIId:a.travelPOIId,businessType:a.businessType,isCustom:a.isCustom,allRating:obj.zongtiPoint,foodRating:obj.kouweiPoint,serviceRating:obj.fuwuPoint,atmosphereRating:obj.fengweiPoint,avgPrice:obj.xiaofei,data:f},function(b){b&&b.RetCode&&1==b.RetCode?(obj.commentId=b.Html,a.callback(obj),clearTimeout(l),a=null):(c.find(".fr span").fadeIn(200),l=setTimeout(k,3e3))})}})}function d(){var a=$(".edit_botfixed"),b=$(".t_step_4"),c=parseInt(b.offset().top,10),d=c+b.height();botfixedHiehgt=a.height(),st=$(window).scrollTop(),maxLastPos=d-($(window).height()-botfixedHiehgt),a.css(st>maxLastPos?{position:"absolute",bottom:"auto",top:d}:{position:"fixed",bottom:"0",top:"auto"})}var e=function(a,b,c){return a.replace(new RegExp(b,"igm"),c)},f=function(a,b){var c=["<BR>","\r\n"],d=["<BR>","\n"],f=["&nbsp;"," "],g=0===b?1:0,h=e(a,c[g],c[b]),i=e(h,d[g],d[b]),j=e(i,f[g],f[b]);return j},g=function(){{var a=$(".edit_botfixed p span.time"),b=new Date,c=(b.getMonth()+1,b.getDate()+""),d=b.getHours()+"",e=b.getMinutes()+"";b.getSeconds()+""}c=1==c.length?"0"+c:c,d=1==d.length?"0"+d:d,e=1==e.length?"0"+e:e;var f="自动保存于&nbsp;"+d+":"+e;a.html(f)};$(".edit_botfixed .save_drafts").click(function(){$(this);g();var a=$(".edit_botfixed").find(".time").text();_str=a.replace(/^自动保存于/g,"保存于"),$(".edit_botfixed").find(".time").text(_str),$.gs_alert({text:'草稿保存成功，可到<a href="'+INTERFACE.MemberUrl+'" target="_blank">个人主页</a>中查看。',time:3e3,hasCloseBtn:!0,hasDetermineBtn:!1,width:"auto"})}),$(".edit_botfixed dl").width(1==$(".submit_go").length?470:600);var h=null;$(".edit_botfixed .submit_go").click(function(){function a(){for(var a=f.length,b=0;a>b;b++){var c=f[b],e=c.parent();if(c.removeClass("red-border"),c.parents(".addtagbox").length){var g=c.parents(".addtagbox").siblings(".tag-tip");g.hide(),d(),g.text("标签请控制在10个字以内")}else e.find("div[data-id='save-tip']").hide(),e.find(".msg").show()}}clearTimeout(j),clearTimeout(h);var b=!0,c=$(".daybox.editbox").find(".textarea"),e=null,f=[];if(c.each(function(){var a=$(this);if(a.is(":visible"))if(b=!1,f.push(a),e=e?e:a,a.addClass("red-border"),a.parents(".addtagbox").length){var c=a.parents(".addtagbox").siblings(".tag-tip");c.text("请保存内容"),c.show(),d()}else{var g=$('<div data-id="save-tip" style="margin-left:20px;line-height:30px;color:#B94A48;float:right;font-size: 12px;">请保存内容</div>'),h=a.parent();h.find(".msg").hide();var i=h.find("div[data-id='save-tip']");0===i.length?g.appendTo(h):(i.show(),g=i)}}),e){var g=e.offset().top;$("body,html").animate({scrollTop:g-60},800)}if(h=setTimeout(a,3e3),b){var i=$(this);$.post(INTERFACE.ReleaseTravel,{travelId:INTERFACE.TravelId,stepNo:100},function(a){a&&a.RetCode&&1==a.RetCode?window.location.href=INTERFACE.GoToNextStep+"&score="+a.Html:$.gs_alert({text:"发表游记失败，请重试！"})}),i.gsdisable({disable:"submit_go gsn-btn-20-load",time:2e4,text:'<img class="btn_ajax" src="http://youresource.c-ctrip.com/img/load.gif" alt="...">正在提交',callback:function(){}})}}),$('.singledes[data-id="chanGuanAssess"] a').on("click",function(){var b={},d=$(this).parent(),e=d.siblings("ul").find("li"),h=$(this).parents(".singledes").attr("data-contentId")||0,i=$(this).parents(".singledes").attr("data-commentId")||0;travelPOIId=$(this).parents(".singledes").attr("data-travelPOIId")||0,businessType=$(this).parents(".singledes").attr("data-businessType")||0,isCustom=$(this).parents(".singledes").attr("data-isCustom")||0,b.isViewpoint=!1,b.contentId=h,b.commentId=i,b.travelPOIId=travelPOIId,b.businessType=businessType,b.isCustom=isCustom,$(this).hasClass("edit_comment")&&(b.zongtiPoint=parseInt(e.find("span[data-name='gs_zongtiPoint']").css("width"),10)/14,b.kouweiPoint=e.find("span[data-name='gs_kouweiPoint']").text(),b.fengweiPoint=e.find("span[data-name='gs_fengweiPoint']").text(),b.fuwuPoint=e.find("span[data-name='gs_fuwuPoint']").text(),b.xiaofei=e.find("span[data-name='gs_xiaofei']").text(),b.pinglun=d.siblings("p[data-name='gs_pinglun']").html()),b.callback=function(b){e.find("span[data-name='gs_zongtiPoint']").css({width:14*b.zongtiPoint}),e.find("span[data-name='gs_kouweiPoint']").text(b.kouweiPoint),e.find("span[data-name='gs_fengweiPoint']").text(b.fengweiPoint),e.find("span[data-name='gs_fuwuPoint']").text(b.fuwuPoint),e.find("span[data-name='gs_xiaofei']").text(b.xiaofei);var c=b.pinglun.replace(/[\s\n\r\t]*$/,"");c=a(c),c=f(c,0),d.siblings("p[data-name='gs_pinglun']").html(c),d.parents(".singledes").attr("data-commentId",b.commentId),d.siblings("ul").show(),d.parent().find("h3 a").hide(),d.parent().find("p").show(),g()},c(b)}),$('.singledes[data-id="jingDianAssess"] a').click(function(){var b={},d=$(this).parent(),e=d.siblings("ul").find("li");contentId=$(this).parents(".singledes").attr("data-contentId")||0,commentId=$(this).parents(".singledes").attr("data-commentId")||0,travelPOIId=$(this).parents(".singledes").attr("data-travelPOIId")||0,businessType=$(this).parents(".singledes").attr("data-businessType")||0,isCustom=$(this).parents(".singledes").attr("data-isCustom")||0,b.contentId=contentId,b.commentId=commentId,b.travelPOIId=travelPOIId,b.businessType=businessType,b.isCustom=isCustom,$(this).hasClass("edit_comment")&&(b.zongtiPoint=parseInt(e.find("span[data-name='gs_zongtiPoint']").css("width"),10)/14,b.kouweiPoint=0,b.fengweiPoint=0,b.fuwuPoint=0,b.xiaofei=0,b.pinglun=d.siblings("p[data-name='gs_pinglun']").html()),b.callback=function(b){d.siblings("ul").show(),d.parent().find("h3 a").hide(),d.parent().find("p").show(),e.find("span[data-name='gs_zongtiPoint']").css({width:14*b.zongtiPoint});var c=b.pinglun.replace(/[\s\n\r\t]*$/,"");c=a(c),c=f(c,0),d.siblings("p[data-name='gs_pinglun']").html(c),d.parents(".singledes").attr("data-commentId",b.commentId),g()},c(b)});var i=null;$("#xiaofei").unbind(),$("#xiaofei").change(function(){clearTimeout(i),$("#fraction-avgVerify").hide()}),$("#xiaofei").bind("paste",function(){var a=$(this);i=setTimeout(function(){var b=a.val();b=b.replace(/^0+|[^\d]/g,""),a.val(b)},100)});var j=null;$('.addtagbox[data-id="addTagBox"]').inlineEdit({maxlen:0,type:"input",btnYes:{text:"保存",classname:"gsn-btn-2"},btnNo:{text:"取消",classname:"editcancel"},beginFN:function(a){$(a).find(".textundis").text(""),$(a).find(".textarea").val(""),d();var b=$(a).find(".textarea");b.bind("keyup change mousedown blur focus",function(){function c(){$(a).siblings(".tag-tip").hide(),d()}var e=b.val(),f=e.replace(/\s/gi,"x").replace(/[^x00-xff]/g,"xx"),g=Math.ceil(f.length/2);if(g>10){clearTimeout(j),$(a).siblings(".tag-tip").text("标签请控制在10个字以内"),$(a).siblings(".tag-tip").show(),d();var h=$.gsSubstring(e,10,1);b.val(h),j=setTimeout(c,3e3)}})},endFN:function(a){clearTimeout(j);var b=$(a),c=!0,e=null;$(a).siblings(".tag-tip").hide(),d(),b.find(".textundis").css("display","none");var f=$(a).find(" .textundis").text();f=$.trim(f);var h=$(a).siblings("ul");if(h.find("li").each(function(){var a=$(this).find("a").text();f==a&&($(this).hasClass("current")?c=!1:($(this).addClass("current"),e=$(this)))}),""!==f&&c){var i=null;e?i=e:(i=$('<li class="current"><a href="javascript:;" data-tagqouteid="0" data-tagid="0">'+f+"</a></li>"),$(".edit_tag ul").append(i));var k=encodeURIComponent(f),l=i.find("a").attr("data-tagId")||0;$.post(INTERFACE.AddTravelTag,{travelId:INTERFACE.TravelId,tagId:l,data:k},function(a){if(a&&a.RetCode&&1==a.RetCode){var b=a.Html;i.find("a").attr("data-tagQuoteId",b),g()}else e?e.removeClass("current"):i.remove(),$.gs_alert({text:"添加标签失败！"})})}d()}}),$(".addpictext").inlineEdit({maxlen:140,btnYes:{text:"保存",classname:"gsn-btn-2"},btnNo:{text:"取消",classname:"editcancel"},beginFN:function(a){d();var c=$.trim($(a).find("div[data-text]").html()),e=f(c,1);e=b(e),$(a).find(".textarea").val(e)},endFN:function(b,c,e,h){d();var i=$(b);if(""!=c?$(b).find(" .link_addpictxt span").hide():i.find(" .link_addpictxt span").show(),"yes"==h){var j=i.attr("data-nextId")||0,k=i.attr("data-contentId")||0,l=i.attr("data-scheduleId")||0,m=encodeURIComponent(c);$.post(INTERFACE.EditImageDesc,{travelId:INTERFACE.TravelId,nextId:j,contentId:k,scheduleId:l,data:m},function(a){if(a&&a.RetCode&&1==a.RetCode)g(),$(b).find("a[data-edit]").attr("title","编辑照片描述");else{var c=i.find("div[data-text]"),d=i.find(".textareaframe .textarea");c.html(e),d.val(e),""!=e?$(b).find(" .link_addpictxt span").hide():i.find(" .link_addpictxt span").show(),$.gs_alert({text:"文字保存失败！"})}});var n=c.replace(/[\s\n\r\t]*$/,"");n=a(n),n=f(n,0),$(b).find("div[data-text]").html(n)}else $(b).find("div[data-text]").html(e)}}),$('.edittitle[data-id="journalTitle"]').inlineEdit({maxlen:50,type:"input",btnYes:{text:"保存",classname:"gsn-btn-2"},btnNo:{text:"取消",classname:"editcancel"},beginFN:function(a){var c=$.trim($(a).find("div[data-text]").html()),e=f(c,1);e=b(e);var g=$(a).find(".textarea");g.val(e),d()},endFN:function(b,c,e,h){d();var i=$(b);if("yes"==h){var j=i.attr("data-nextId")||0,k=i.attr("data-contentId")||0,l=i.attr("data-scheduleId")||0;if(c=$.trim(c),""==c)return $.gs_alert({text:"标题不能为空！"}),void $(b).find("div[data-text]").html(e);var m=encodeURIComponent(c);$.post(INTERFACE.UpdateTravelTitleAPI,{travelId:INTERFACE.TravelId,nextId:j,contentId:k,scheduleId:l,data:m},function(a){if(a&&a.RetCode&&1==a.RetCode){var c=a.Html;i.attr("data-contentId",c),g(),$(b).find("a[data-edit]").attr("title","编辑游记标题")}else{var d=i.find("div[data-text]"),f=i.find(".textareaframe .textarea");d.html(e),f.val(e),$.gs_alert({text:"标题保存失败！"})}}),htmlData=a(c),htmlData=f(htmlData,0),$(b).find("div[data-text]").html(htmlData)}else $(b).find("div[data-text]").html(e)}}),$(".addtxtline").add(".daytext").inlineEdit({maxlen:1e3,beginFN:function(a){$(a).removeClass().addClass("addtext"),d();var c=$.trim($(a).find("div[data-text]").html()),e=f(c,1);e=b(e);var g=$(a).find(".textarea");g.val(e),g.attr("placeholder")||g.attr("placeholder","记录旅途中的点点滴滴…"),g.placeholder()},endFN:function(b,c,e,h){var i=$(b);if(""==c||"记录旅途中的点点滴滴…"==c?(i.removeClass().addClass("addtxtline"),i.find("a.normaltext").removeClass("edit_title").html("<strong></strong>添加游记正文")):i.removeClass().addClass("daytext").find(" .normaltext").addClass("edit_title").text(""),d(),"yes"==h){var j=i.attr("data-nextId")||0,k=i.attr("data-contentId")||0,l=i.attr("data-scheduleId")||0;"记录旅途中的点点滴滴…"==c&&(c="");var m=c,n=encodeURIComponent(c);$.post(INTERFACE.TextAddOrEdit,{travelId:INTERFACE.TravelId,nextId:j,contentId:k,scheduleId:l,data:n},function(a){if(a&&a.RetCode&&1==a.RetCode){var c=a.Html;if(i.attr("data-contentId",c),g(),$(b).find("a[data-edit]").attr("title","编辑游记正文"),""==m){var d=i.prev(),f=i.next();(d.hasClass("daytext")||d.hasClass("addtxtline")||f.hasClass("daytext")||f.hasClass("addtxtline"))&&i.remove()}}else{var h=i.find("div[data-text]"),j=i.find(".textareaframe .textarea");h.html(e),j.val(e),""!=e?i.removeClass().addClass("daytext").find(" .normaltext").addClass("edit_title").text(""):(i.removeClass().addClass("addtxtline"),i.find("a.normaltext").removeClass("edit_title").html("<strong></strong>添加游记正文")),$.gs_alert({text:"文字保存失败！"})}});var o=c.replace(/[\s\n\r\t]*$/,"");o=a(o),o=f(o,0),$(b).find("div[data-text]").html(o)}else $(b).find("div[data-text]").html(e)},btnYes:{text:"保存",classname:"gsn-btn-2"},btnNo:{text:"取消",classname:"editcancel"}}),$(".singleimg .toggleimgbox").toggle(function(){$(this).find(".bottomline").children("span").addClass("packup").html("收起"),$(this).css({height:"auto"}),d()},function(){$(this).find(".bottomline").children("span").removeClass("packup").addClass("develop").html("展开"),$(this).css({height:"200px"}),d()}),$(".singleimg .edit_optips .close").click(function(){$(this).parent().fadeOut(300),$.post(INTERFACE.CloseTravelTips,{type:1})}),$(".singleimg .edit_optips").click(function(a){a&&a.stopPropagation?a.stopPropagation():window.event.cancelBubble=!0}),function(){var a=$(window).scrollTop(),b=$(".t_step_4"),c=$(".edit_botfixed"),d=parseInt(b.offset().top,10),e=c.height(),f=d+b.height(),g=f-($(window).height()-e),h=function(){c.css({position:"fixed",bottom:"0",top:"auto"})},i=function(a){c.css({position:"absolute",bottom:"auto",top:a})};a>g&&i(f),$(window).scroll(function(){a=$(window).scrollTop(),f=d+b.height(),g=f-($(window).height()-e),a>g?GS.throttle(i(f),500):GS.throttle(h(),500)})}(),$(document).on("click",".edit_tag li",function(){function a(){b.data("stop",!1)}var b=$(this),c=null;if(!b.data("stop")){var d=b.find("a");if(b.hasClass("current")){var e=d.attr("data-tagQuoteId")||0;$.post(INTERFACE.RemoveTravelTag,{travelId:INTERFACE.TravelId,tagQuoteId:e},function(a){a&&a.RetCode&&1==a.RetCode?(g(),b.removeClass("current")):$.gs_alert({text:"标签设置失败！"})})}else{var f=$("#editTag").find(".current").length;if(f>=10)return $("#editTag").find(".gsn-formerr").show(),!1;var h=encodeURIComponent(d.text()),i=d.attr("data-tagId")||0;$.post(INTERFACE.AddTravelTag,{travelId:INTERFACE.TravelId,tagId:i,data:h},function(a){if(a&&a.RetCode&&1==a.RetCode){var c=a.Html;d.attr("data-tagQuoteId",c),g(),b.addClass("current")}else $.gs_alert({text:"标签设置失败！"})})}b.data("stop",!0),clearTimeout(c),c=setTimeout(a,2e3)}}),function(){for(var a=$(".edit_botfixed dl"),b=$(".dayframe").length,c=0,d=1;b>c;c++){d=c+1;var e=$(".dayframe").eq(c).attr("id");if(e=parseInt(e.substring(3,e.length),10),0!=e){var f='<dd><a data-id="day'+e+'" href="javascript:;">第'+e+"天</a>";f+=c!=b-1?"&gt;</dd>":"</dd>",a.append(f)}}a.find("dd a").click(function(){var a=$(this),b=a.attr("data-id"),c=$("#"+b),d=c.offset().top;$("body,html").animate({scrollTop:d},800)})}(),$(".singleimg .setcover").click(function(){var a=$(this),b=a.parents(".singleimg").attr("data-contentId")||"";b=""==b?0:b,$.post(INTERFACE.SetTravelCoverImageId,{travelId:INTERFACE.TravelId,contentId:b,isOn:!0},function(b){b&&b.RetCode&&1==b.RetCode&&($(".singleimg .coverpic").hide(),a.siblings(".coverpic").show(),a.hide(),g())})}),$(".singleimg").hover(function(){var a=$(this);"none"==a.find(".coverpic").css("display")&&a.find(".setcover").show()},function(){var a=$(this);a.find(".setcover").hide()}),$(".imglink img").lazyload()});