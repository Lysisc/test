/*! test 2014-05-20 17:53:46 */
function getreallen(a){return a.replace(/&nbsp;|\s|\t|\n|<(?!img).*?>/gi,"").length}String.prototype.strLength=function(){if(this.charCodeAt){for(var a=0,b=0;b<this.length;b++)this.charCodeAt(b)>255||this.charCodeAt(b)<0?a+=2:a++;return a}},String.prototype.strToChars=function(){for(var a=new Array,b=0;b<this.length;b++)a[b]=[this.substr(b,1),this.isCHS(b)];return String.prototype.charsArray=a,a},String.prototype.isCHS=function(a){return this.charCodeAt?this.charCodeAt(a)>255||this.charCodeAt(a)<0?!0:!1:void 0},String.prototype.subCHString=function(a,b){var c=0,d="";this.strToChars();for(var e=0;e<this.length;e++){if(this.charsArray[e][1]?c+=2:c++,c>b)return d;c>a&&(d+=this.charsArray[e][0])}return d},String.prototype.subCHStr=function(a,b){return this.subCHString(a,a+b)},String.prototype.lastsubCHStr=function(a){return this.strLength?!a||a>=this.strLength()?this.toString():"..."+this.subCHStr(this.strLength()-a+1,a):void 0},function(){this.JournalAction={editor:null,travel:{OperateCategory:"2",TravelId:"1728238",AppendId:"0",TravelTitle:"厦门",TravelContent:"",TagList:"",DistrictList:[],ImageList:[],CoverImageId:"11733758",OperateUserId:"4880792"},init:function(a){var b=this;this.draftTimeoutID=setTimeout(function(){b.draft(!1),b.draftTimeoutID=setTimeout(arguments.callee,1e4)},1e4),$("#draft").bind("click",function(){return b.beforeSubmit()?void b.draft(!0):(b.closePopup(),!1)}),$("#btn_submit").bind("click",function(){var a=b.travel.OperateCategory;("1"==a||"2"==a)&&b.submit(),("3"==a||"4"==a)&&b.append()}),$("#btnSubmit").bind("click",function(){b.save()}),$("#btnSkip").bind("click",function(){b.skip()}),this.addEventListener(window,"beforeunload",function(a){var a=a?a:event,c=window.google||window.chrome;if(!b.leavePage()){if(c)return"您的游记未正式发表，确定要离开此页吗？";a.returnValue="您的游记未正式发表，确定要离开此页吗？"}}),this.editor=UE.getEditor(a),this.GetTravel()},leavePage:function(){return this.editor.getContent()&&this.travel.TravelContent!=this.editor.getContent()?!1:$("#title").val().trim()&&this.travel.TravelTitle!=$("#title").val().trim()?!1:$.editTagArr()&&this.travel.TagList!=$.editTagArr()?!1:!0},addTags:function(a,b){var c=b.val();-1==$.inArray($(a).html(),c.split(/\s*[,|，]\s*/))&&(c+=""!=c&&","!=c.split("").pop()?",":"",b.val(c+$(a).html()))},warn:function(a,b){var c=document.getElementById(a);b?(c.innerHTML=b,c.style.display=""):(c.innerHTML="",c.style.display="none")},addEventListener:function(a,b,c){a&&(a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener?a.addEventListener(b,c,!1):a[b]=c)},closePopup:function(){$("#popup_win_bg").remove(),$("#popup_win").remove()},submit:function(){if(!this.beforeSubmit())return this.closePopup(),!1;var a=this;$.popupbox.show({id:"gsn_frame_nocontent",zIndex:1001}),a.draft(!1),this.GetDistrictList()},append:function(){if(!this.beforeSubmit())return this.closePopup(),!1;if($("#submitsec").hide(),$.popupbox.show({id:"gsn_frame_submiting",zIndex:1001}),this.webPhoto.length)return $.popupbox.close(),$.popupbox.show({id:"gsn_frame_uploadimg",zIndex:10001}),this.uploadWebPhoto(),!1;var a=this;return a.draft(!1),0!=this.draftTimeoutID&&clearTimeout(this.draftTimeoutID),a.doPost(),!0},save:function(){if(0!=this.draftTimeoutID&&clearTimeout(this.draftTimeoutID),this.destCombine(),$.popupbox.close(),this.webPhoto.length)return $.popupbox.show({id:"gsn_frame_uploadimg",zIndex:10001}),this.uploadWebPhoto(),!1;var a=this;return $.popupbox.show({id:"gsn_frame_submiting",zIndex:1001}),a.doPost(),!0},skip:function(){if(0!=this.draftTimeoutID&&clearTimeout(this.draftTimeoutID),$.popupbox.close(),$.popupbox.show({id:"gsn_frame_submiting",zIndex:1001}),$(".gsn-form .deslist").html(""),this.webPhoto.length)return $.popupbox.show({id:"gsn_frame_uploadimg",zIndex:10001}),this.uploadWebPhoto(),!1;var a=this;return a.doPost(),!0},doPost:function(){var a=this.GetTravel();$.ajax({type:"post",url:"/TravelSite/Member/OperateClassicTravel",dataType:"json",contentType:"application/x-www-form-urlencoded; charset=utf-8",data:$.toJSON(a),success:function(a){a.RetCode>0?location.href="/TravelSite/Member/ClassicTravelMessage?"+a.Html:alert(a.ErrorMessage)}})},uploadWebPhoto:function(){if(this.webPhoto.length){for(var a=this,b=[],c=[],d=[],e=0;this.webPhoto[e];e++)b[b.length]=this.webPhoto[e].src,c[c.length]=this.webPhoto[e],(e==this.webPhoto.length-1||0==(e+1)%3)&&(d[d.length]={urls:b,ps:c,uploaded:!1},b=[],c=[]);!function f(b){$.ajax({type:"Post",url:"/TravelSite/Member/AjaxUploadWebPhoto",dateType:"text",contentType:"application/x-www-form-urlencoded; charset=utf-8",data:{urls:d[b].urls.join(",")},async:!0,success:function(c){if(c)for(var e=c,g=0;d[b].ps[g];g++)e[g]&&/^[1-9]\d*|0$/.test(e[g].RetCode)?(d[b].ps[g].setAttribute("phsid",e[g].RetCode),"selected"==$(d[b].ps[g]).attr("cover")&&(a.travel.CoverImageId=e[g].RetCode)):d[b].ps[g].setAttribute("phsid",0);d[b].uploaded=!0,b<d.length-1?f(b+1):(a.draft(!1),0!=this.draftTimeoutID&&clearTimeout(this.draftTimeoutID),a.doPost())}})}(0)}},beforeSubmit:function(){var a,b=this.GetTravel(),c=b.TagList,d=!0;return 0==getreallen(this.editor.getContent())?(this.warn("contentwarn","请填写正文"),a="#wcontent",d=!1):this.warn("contentwarn"),(1==b.OperateCategory||2==b.OperateCategory)&&(c&&c.length>0&&(10<c.length?($(".mainCon .gsn-inputbox").show(),$(".mainCon .gsn-tiptext").text("最多可以添加10个分类标签"),a="#wtag",d=!1):$(".mainCon .gsn-inputbox").hide()),this.travel.TravelTitle.isNullOrEmpty()?(this.warn("titlewarn","请填写标题"),a="#wtitle",d=!1):this.travel.TravelTitle.length>50?(this.warn("titlewarn","标题不能大于50个字"),a="#wtitle",d=!1):this.warn("titlewarn")),d||(location.href=a),d},destCombine:function(){var a=this,b=[];$(".deslist span").each(function(c,d){if("tag-btn-selected"==d.className){var e=!1;for(c in a.travel.DistrictList)a.travel.DistrictList[c]==$(d).attr("data")&&(e=!0);if(!e){var f={RetCode:$(d).attr("data"),Html:$(d).html()};b[b.length]=f}}}),this.travel.DistrictList=b},highLine:function(a,b){var c=0;clearTimeout(c),a.addClass(b),c=setTimeout(function(){a.removeClass(b)},2e3)},htmlEncode:function(a){var b=document.createElement("div"),c=document.createTextNode(a);b.appendChild(c);var d=b.innerHTML;return d},draftTimeoutID:0,draft:function(a){var b=this,c=this.editor.getContent().replace(/&[a-z0-9]+;/gim," ").replace(/\r?\n/gm,"").replace(/\s+/gm," ").replace(/<[^>]*>/gim,function(){return/img/gim.test(arguments[0])?arguments[0]:""});if(""!=c){$(".savedCon").html("正在保存...");var d=this.GetTravel();d.OperateCategory=parseInt(d.OperateCategory)+4,$.ajax({type:"POST",url:"/TravelSite/Member/SaveClassicTravelDraft",dateType:"json",data:$.toJSON(d),contentType:"application/x-www-form-urlencoded; charset=utf-8",async:!0,success:function(){1==a&&($.popupbox.show({id:"gsn_frame_draft",zIndex:10001}),setTimeout(function(){$.popupbox.close()},3e3));var c=new Date;$(".savedCon").html("已保存，"+c.toLocaleDateString()+" "+c.toLocaleTimeString()),$(".savedCon").show(),b.highLine($(".savedCon"),"highline")}})}},setImageInfo:function(){var a=this.getImagesFromContent();this.travel.ImageList=a},webPhoto:[],getImagesFromContent:function(){var a=this.editor.document.getElementsByTagName("img"),b=[];if(this.webPhoto=[],a&&a.length)for(var c=0;c<a.length;c++){var d=a[c].getAttribute("phsid");"selected"==$(a[c]).attr("cover")&&/^[1-9]\d*|0$/.test(d)&&(this.travel.CoverImageId=d),d&&"0"!=d?d&&/^[1-9]\d*|0$/.test(d)&&(b[b.length]={RetCode:d,Html:a[c].src}):(this.webPhoto[this.webPhoto.length]=a[c],b[b.length]={RetCode:0,Html:a[c].src})}return b},GetTravel:function(){var a=$("#title").val();void 0!=a&&(this.travel.TravelTitle=a.trim());var b=$.editTagArr();void 0!=b&&(this.travel.TagList=b.trim()),this.travel.TravelContent=this.editor.getContent(),this.destCombine(),this.setImageInfo();var c={OperateCategory:this.travel.OperateCategory,TravelId:this.travel.TravelId,AppendId:this.travel.AppendId,TravelTitle:encodeURIComponent(this.travel.TravelTitle),TravelContent:encodeURIComponent(this.htmlEncode(filterBaiduEdit(this.travel.TravelContent))),TagList:[],DistrictList:this.travel.DistrictList,ImageList:this.travel.ImageList,CoverImageId:this.travel.CoverImageId,OperateUserId:this.travel.OperateUserId},d=[];if(""!=this.travel.TagList.trim()){var e=this.travel.TagList.split(",");if(e&&e.length>0)for(var f=0;e[f];f++)d[f]=e[f]}return c.TagList=d,c},GetDistrictList:function(){window.setUserDesValue();var a="",b=this.GetTravel();if(b.DistrictList&&b.DistrictList.length>0)for(var c=b.DistrictList,d=0;c[d];d++)"10000"!=c[d].RetCode&&(a+='<span data="'+c[d].RetCode+'" class="tag-btn-selected" style="cursor:pointer" onclick="javascript:void(0); return false;">'+c[d].Html+"</span>");var e=b;return $.ajax({type:"Post",url:"/TravelSite/Member/GetDistrictByContent",dateType:"text",contentType:"application/x-www-form-urlencoded; charset=utf-8",data:{title:e.TravelTitle,content:e.TravelContent},async:!0,success:function(c){var d="";if(c.length>0)for(var e=0;c[e];e++)if(-1==a.indexOf('data="'+c[e].RetCode+'"'))d+=0==e&&""==a?'<span data="'+c[e].RetCode+'" class="tag-btn-selected" style="cursor:pointer" onclick="javascript:void(0); return false;">'+c[e].Html+"</span>":'<span data="'+c[e].RetCode+'" class="tag-btn-normal" style="cursor:pointer" onclick="javascript:void(0); return false;">'+c[e].Html+"</span>";else{for(var f="",g=0;b.DistrictList[g];g++)if(b.DistrictList[g].RetCode==c[e].RetCode){f=b.DistrictList[g].Html;break}if(""!=f){var f='<span data="'+c[e].RetCode+'" class="tag-btn-selected" style="cursor:pointer" onclick="javascript:void(0); return false;">'+f+"</span>",h='<span data="'+c[e].RetCode+'" class="tag-btn-selected" style="cursor:pointer" onclick="javascript:void(0); return false;">'+c[e].Html+"</span>";a=a.replace(f,h)}}$(".gsn-form .deslist").html(a+d),$.popupbox.close(),$.popupbox.show({id:"gsn_frame_selectdes",layerContainer:"gs_pop_01",zIndex:"500",callback:null})}}),!1}}}(),String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")},String.prototype.isNullOrEmpty=function(){return null==this||""==this};