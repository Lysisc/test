/*! test 2014-05-20 17:53:46 */
!function(a){function b(b){INTERFACE.custom_img({imgId:b},function(b){k.css("left",0).find(".select").removeClass("select"),k.prepend('<li><img data-id="'+b.Id+'" data-src="'+b.DataSrc+'" src="'+b.Src+'" /><div class="select"></div></li>'),g.removeClass("gs_btn_v3").text("上传图片").parent(f).siblings(".upLoad_box").hide(),l.find("img").attr("src",b.DataSrc).end().find("p").addClass("move").html("上下拖动可调整封面图位置").siblings("div").show().parents(".set_cover_box").show(),k.find("li").length>7&&j.removeClass("disable"),a("#set_cover").css("margin-top","-258px")})}function c(a){if(1==k.data("moveAble")){var b=parseInt(k.css("left")),c=a?b+490:b-490;k.data("moveAble",0).animate({left:c},300,d)}}function d(){var a=parseInt(k.css("left"))+70;if(a>0?i.addClass("disable"):i.removeClass("disable"),k.find("li").length>7){var b=0-70*(k.find("li").length-9);b>a?j.addClass("disable"):j.removeClass("disable")}k.data("moveAble",1)}document.domain=a("#domainUrl").val();var e=a("#upLoadUrl").val(),f=a(".upLoad_data"),g=a("#upLoadBtn"),h=a("#set_cover_popup"),i=a(".cover_pic_l"),j=a(".cover_pic_r"),k=a(".cover_pic_cont ul").data("moveAble",1),l=a(".cover_show");new AjaxUpload(g[0],{action:e,data:{journalid:INTERFACE.TravelId,typeid:INTERFACE.TypeId,title:INTERFACE.Title,userid:INTERFACE.UserId,"new":1,source:1,type:"journals",token:"78A566F2-AA8A-4C4C-8EE8-F99FB3D4A1D8",randomKey:+new Date},onSubmit:function(a,b){return b&&/^(jpg|jpeg|png)$/.test(b)?(f.find("span").html("图片上传中，请耐心等待 ...").css("color","#999").siblings("img").show(),g.text("重新上传"),g[0].disabled="disabled",void 0):(f.find("span").html("不支持非图片格式！且图片格式必须为jpg，jpeg，png。").css("color","red").siblings("img").hide(),!1)},onComplete:function(a,c){g[0].disabled="";var d=new Function("return "+c.replace(/(<script)+[^<>]*>[^\0]*(<\/script>)+/gm,""))();if("undefined"!=typeof d.error&&""==d.error){var e=d.data[0];if("0"==e.data)return f.find("span").html("Oops, 服务器好像出了点问题 ...").css("color","#cc4200").siblings("img").hide(),g.text("重新上传"),window.console&&console.log("图片服务端无数据返回！请确认服务器端口是否正确！"),!1;var h=e.data;e.width<600?(f.find("span").html("请上传宽度1000px以上的图片来设置封面。").css("color","#cc4200").siblings("img").hide(),g.removeClass("gs_btn_v3").text("重新上传")):e.width>=600&&e.width<1e3?(f.find("span").html("上传宽度1000px以上的图片，封面效果为佳。").css("color","#333").siblings("img").hide(),b(h)):(f.find("span").html("图片上传成功！您也可以重选一张图片。").css("color","#333").siblings("img").hide(),b(h))}else window.console&&console.log("无效的数据")}}),h.on("click",function(){1!=h.data("hasClick")?(h.data("hasClick",1),INTERFACE.img_list(function(b){if(!b.HasImage)return a.popupbox.show({id:"set_cover"}),!1;for(var c="",d="",e=0;e<b.List.length;e++)c+='<li><img data-id="'+b.List[e].Id+'" data-src="'+b.List[e].DataSrc+'" src="'+b.List[e].Src+'" /><div></div></li>';if(a(".set_cover_box").show().find(k).html("").append(c),f.find("span").html("建议封面上传1000px宽度以上的图片。"),g.removeClass("gs_btn_v3").text("上传图片").parent(f).siblings(".upLoad_box").hide(),b.SelectId>0){var h=k.find("img[data-id="+b.SelectId+"]"),m=h.parent("li").index(),n=k.find("li").length%7!=0?parseInt(k.find("li").length/7)+1:k.find("li").length/7;_index=(m+1)%7!=0?parseInt((m+1)/7)+1:(m+1)/7,h.siblings("div").addClass("select"),_index>1&&n>_index&&i.add(j).removeClass("disable"),_index>1&&_index==n&&i.removeClass("disable"),1==_index&&n>1&&j.removeClass("disable"),k.css("left",490*(1-_index)),d=h.attr("data-src")}else k.find("li").length>7&&j.removeClass("disable"),k.find("li:first div").addClass("select"),d=k.find("li:first img").attr("data-src");l.find("img").attr("src",d),l.find("p").addClass("move").html("上下拖动可调整封面图位置").siblings("div").show(),a.popupbox.show({id:"set_cover",callback:function(){a("#set_cover").css("margin-top","-258px")}})})):a.popupbox.show({id:"set_cover"})}),a("#set_cover").on("click",".close, .confirm, .color_white",function(){if(a(this).hasClass("confirm")){var b=k.find(".select").siblings("img").attr("data-id"),c=a(".cover_show").find("img"),d=c.height(),e=parseInt(c.css("top").replace("px",""));INTERFACE.set_cover({imageId:b,coverLocationY:parseInt(e/d*1e4)},function(){window.location.reload(!0)})}return a.popupbox.close(),!1}),l.on("mousedown",".cover_show_mask",function(b){var c=parseInt(l.find("img").css("top")),d=l.find("img").outerHeight(),e=b.pageY;return a(document).bind("mousemove",function(a){var b=parseInt(l.find("img").css("top")),f=a.pageY,g=c-e+f;if(l.children(".cover_show_mask").find("p, div").hide(),200>=d)return!1;if(b>=0){var h=0>e-f?0:g;l.find("img").css("top",h)}else if(200-d>=b){var h=e-f>0?200-d:g;l.find("img").css("top",h)}else l.find("img").css("top",g);return!1}),!1}),a(document).mouseup(function(){l.children(".cover_show_mask").find("p, div").show(),a(document).unbind("mousemove")}),k.on("mouseover","li",function(){var b=a(this).find("div");b.hasClass("select")||b.addClass("hover")}).on("mouseout","li",function(){a(this).find("div").removeClass("hover")}).on("click","li",function(){a(this).siblings("li").find("div").removeClass("select"),a(this).find("div").removeClass("hover").addClass("select");var b=a(this).find("img").attr("data-src");return l.find("img").attr("src",b).css("top",0),!1}),i.on("click",function(){return a(this).hasClass("disable")||c(1),!1}),j.on("click",function(){return a(this).hasClass("disable")||c(0),!1})}(jQuery);