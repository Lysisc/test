/*! test 2014-05-20 15:46:54 */
$(function(){var a,b,c,d,e=function(a){return a.parents(".edit_trip").attr("id")};window.sortable_opt={tolerance:"pointer",items:"> .sort_ui",cursor:"move",delay:100,opacity:.7,placeholder:"poi_highlight",helper:function(a,b){var c=$(b).hasClass("on")?"on":"",d=$(b).find("i").attr("class"),e=$(b).find("p").text(),f=$(b).find("b").text();return $('<div id="drag-poi" class="'+c+'"><i class="'+d+'"></i><p>'+e+"</p><b>"+f+'</b><div class="arr_r"></div><div class="arr_t"></div></div>')},start:function(a,c){b=$(c.item).attr("id"),d=$(c.item).index()},stop:function(a,e){d!=$("#"+b).index()&&(c=void 0==$(e.item).next(".sort_ui").attr("id")?0:$(e.item).next(".sort_ui").attr("id"),INTERFACE.poi_sort_api($.toJSON({CurrentPoiContentId:$("#"+b).attr("data-travelcontentid"),PrePoiContentId:$("#"+c).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId})))}},$(".poi_box").sortable(window.sortable_opt).disableSelection(),window.sortable_p_opt={tolerance:"pointer",items:"> .t_photos",cursor:"move",placeholder:"img_highlight",helper:function(a,b){var c=$(b).siblings(".t_photos:hidden").removeClass("ui-selected").end().siblings(".ui-selected").add($(b));return $('<div id="drag-img"><div class="num">'+c.length+' å¼ </div><div class="mask"></div><img src="'+$(b).find("img").attr("src")+'" /></div>')},start:function(b,c){a=e($(c.item).addClass("ui-selected").data("one","one"));for(var d=$("#"+a).find(".ui-selected").attr("data-poi"),f=$("#"+a).find(".t_photos[data-poi="+d+"]"),g=[],h=0;h<f.length;h++)g.push(f.eq(h).attr("data-travelcontentid"));$("#"+a).data("imgAtt",d),$("#"+a).data("temp",g),$("#"+a).find(".ui-selected").each(function(){$(c.item).index()<$(this).index()?$(this).data("index",$(this).index()-1):$(this).data("index",$(this).index())}).find(".t_p_border").addClass("border_ccc")},sort:function(a,b){"one"==$(b.item).data("one")&&$(b.item).removeData("one").siblings(".ui-selected").each(function(){var a=$(this).find("img").hide().clone().addClass("clone_img").show().appendTo("#drag-img");a.css({top:$(this).offset().top-b.offset.top,left:$(this).offset().left-b.offset.left})}),$("#drag-img").find(".clone_img").each(function(){$(this).animate({top:0,left:0},300)})},stop:function(b,c){var d=$("#"+a);if(d.find(".t_photos img").show().end().find(".t_p_border").removeClass("border_ccc"),f)$(c.item).hide(),$.poi_state(f),f=!1;else{var e=$(c.item);$(c.item).siblings(".ui-selected").each(function(){var a=$(c.item).data("index"),b=$(this).data("index"),d=$(this).clone(!0).fadeIn(300);a>b?$(c.item).before(d):(e.after(d),e=e.next()),$(this).remove()}),d.find(".ui-selected").removeClass("ui-selected");for(var g=[],h=0,i=d.data("imgAtt"),j=d.find(".t_photos[data-poi="+i+"]"),k=d.data("temp"),l=0;l<j.length;l++){var m=j.eq(l).attr("data-travelcontentid");g.push(m),m!=k[l]&&(h=1)}h&&INTERFACE.img_addto_poi($.toJSON({ImageContentId:g,POIContentId:$("#"+i).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId}))}}},$(".photo_content").sortable(window.sortable_p_opt).disableSelection(),window.selectable_opt={filter:".t_photos",cancel:".breadbar, .gs-header, .cui_nav_single, .cui_hd, .footblue, .t_edit, .t_delete, .poi_dot, .photo_null, .add_photo, .t_process, .side_fixed, #add_day, #step3_button, #base_ft, #d_prompt, #poi_popup, .step_tips, .step_tips_box, #gs_operate_right_fix"},$("body").selectable(window.selectable_opt);var f;window.imgDrop=function(b,c){{var d=[],g=$(c.draggable),h=$(c.draggable).siblings(".ui-selected"),i=$(this).attr("id"),j=e($(this));$("#"+j).find(".poi_dot.on").attr("id")}if(f=g.attr("data-poi"),f==i)return f=!1,!1;var k=g.index();if(0==h.length)d.push(g);else for(var l=0;l<h.length;l++){var m=h.eq(l).index();m>k&&k>=0&&(d.push(g),k=-1),d.push(h.eq(l)),l==h.length-1&&g.index()>h.eq(h.length-1).index()&&d.push(g)}for(var n=[],l=0;l<d.length;l++){1==$(this).attr("data-unknown")?d[l].attr("data-unknown",1):d[l].removeAttr("data-unknown"),d[l].attr("data-poi",i).removeClass("ui-selected").hide().find(".t_p_show").hide();var o=d[l].attr("data-travelcontentid");n.push(o)}INTERFACE.img_addto_poi($.toJSON({ImageContentId:n,POIContentId:$("#"+i).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId})),$("#"+i).attr("data-text","+"+n.length).gspoptext({top:20,time:1500,css:{font:"bold 16px Arial",color:"red"}});var p=$("#"+f).find("b");p.text(parseInt(p.text())-d.length);var q=$("#"+i).find("b");if(q.text(parseInt(q.text())+d.length),0==q.text()&&$.poi_state(i),a!=j){for(var l=0;l<d.length;l++)$("#"+a).find(".t_photos img").show().end().find(".t_p_border").removeClass("border_ccc"),$("#"+j).find(".photo_null").before(d[l].clone(!0).fadeIn(300));$("#"+i).hasClass("on")?$("#"+j).find(".photo_null").hide():$("#"+i).trigger("click")}$.unknown_photo_num($(".t_step_3"))},window.droppable_opt={accept:".t_photos",hoverClass:"over",drop:window.imgDrop},$(".sort_ui").droppable(droppable_opt),$("img").lazyload({threshold:300}),$(".step_tips").click(function(){$(".step_tips_box").toggle().find(".step_tips_cont:first").show().siblings(".step_tips_cont").hide(),$.post(INTERFACE.CloseTravelTips,{},function(){})}),$(".step_tips_cont").find("input").click(function(){var a=$(this).parent();0==a.nextUntil().length?a.hide().siblings(".step_tips_cont:first").show():a.hide().next(".step_tips_cont").show()})});