/*! test 2014-05-20 15:20:49 */
!function($){function deleteObj(a,b){a.animate({opacity:0,width:0},600,function(){INTERFACE.del_img_poi_api($.toJSON({TravelContentId:a.attr("data-travelcontentid")})),b(a),$.unknown_photo_num(el)})}function poiChange(a){var b=a.attr("data-poi"),c=$("#imagesCount").text();$("#imagesCount").text(c-1),a.remove(),$.poi_state(b)}function imgChange(a){var b=a.attr("id"),c=parentObj(a),d=c.find(".t_photos[data-poi="+b+"]"),e=$("#imagesCount").text(),f=c.find(".day_date input").val();if($("#imagesCount").text(e-d.length),a.add(d).remove(),c.find(".sort_ui:first").trigger("click"),0==c.find(".t_photos").length&&c.find(".photo_null").html(_alert.phot_02).show(),c.find(".photo_null").children().is("a"))if(0==c.find(".sort_ui").length)c.find(".photo_null a").attr("href",writetravelajax.AddPotoUrl+f+"&dayid="+c.attr("id"));else{var g=c.find(".sort_ui:first").attr("id"),h=c.find(".sort_ui:first").attr("data-travelcontentid");c.find(".photo_null a").attr("href",writetravelajax.AddPotoUrl+f+"&poicontentid="+h+"&poiid="+g+"&dayid="+c.attr("id"))}}function btnReset(){$("#alert_popup").find(".gsn-btn-2").unbind("click").val("删除"),$("#alert_popup").find("p").show().end().find(".gsn-btn-6").show().add("#alert_popup .close").on("click",function(){$.popupbox.close()})}var _alert={a:"是否删除这一天？",at:"删除行程的同时，这一天内的照片也会被删除。",b:"是否删除该地点？",bt:"删除后，该地点内的照片也会被删除。",c:"是否删除该照片？",d:"对不起，无法删除",dt:"游记至少需要保留一天行程哦。",phot_01:'<i></i><span>请拖动照片进行关联，或</span><a href="#">添加照片</a>',phot_02:'<i></i><span>这一天没有照片，请</span><a href="#">添加照片</a>',phot_03:"<b>太棒了，照片已全部关联，请点击拍摄地点查看照片</b>",data_change_01:'<i class="t_prompt_arrow"></i><a class="close" href="javascript:void(0);">×</a>这个日期已经存在啦！',data_change_02:'<i class="t_prompt_arrow"></i><a class="close" href="javascript:void(0);">×</a>如日期排序被打乱，可<a class="refresh" href="#">刷新</a>页面，系统<br />将自动排序。（内容不会遗失）',data_change_03:'<i class="t_prompt_arrow"></i><a class="close" href="javascript:void(0);">×</a>日期穿越啦！'},el=$(".t_step_3"),parentObj=function(a){return a.parents(".edit_trip")};el.on("mouseover",".poi_dot",function(){$(this).removeClass("new").addClass("over"),$(this).find(".t_edit, .t_delete").show().siblings("b").hide()}).on("mouseout",".poi_dot",function(){$(this).removeClass("over"),$(this).find(".t_edit, .t_delete").hide().siblings("b").show()}).on("click",".poi_dot:not(.add_poi)",function(){if(!$(this).hasClass("on")){parentObj($(this)).find(".poi_dot").removeClass("on").find(".arr_t").remove(),$(this).addClass("on").append('<div class="arr_t"></div>');var a=$(this).attr("id"),b=parentObj($(this)).find(".t_photos[data-poi="+a+"]");parentObj($(this)).find(".t_photos").hide().end().find(b).fadeIn(300),$(".ui-draggable").not(".ui-draggable[data-poi="+a+"]").removeClass("on"),$.poi_state(a)}return $.unknown_photo_num(el),!1}),el.on("mouseover",".t_photos",function(){$(this).find(".t_p_show").show()}).on("mouseout",".t_photos",function(){$(this).find(".t_p_show").hide()}).on("click",".t_photos",function(){$(this).toggleClass("ui-selected")}),el.on("click",".t_day .t_edit",function(){$("body").selectable("destroy");var a=parentObj($(this)),b=a.find(".day_date input"),c=b.index(".day_date input"),d=b.val();return b.calendar({foretime:"no",callback:function(){for(var e=b.val(),f=$(".day_date input"),g=b.parent().siblings(".day_num").offset(),h=new Date(e.replace(/-/g,"/")),i=0,j=0;j<f.length;j++){var k=new Date($(f[j]).val().replace(/-/g,"/"));c==j||h.toString()!==k.toString()||(i=1)}if(i)b.val(d),$("#d_prompt").css({width:120,top:g.top-43,left:g.left-14}).html(_alert.data_change_01).fadeIn(300),setTimeout(function(){$("#d_prompt").fadeOut(300)},3e3);else if(h>new Date)$("#d_prompt").css({width:75,top:g.top-43,left:g.left-14}).html(_alert.data_change_03).fadeIn(300),b.val(d),setTimeout(function(){$("#d_prompt").fadeOut(300)},3e3);else{INTERFACE.edit_day($.toJSON({ArgType:"1",ScheduleId:b.parents(".edit_trip").attr("id").replace("day",""),TravelId:INTERFACE.TravelId,ScheduleDate:b.val()}));var l=a.find(".poi_dot.on").attr("id"),m=void 0==l?"":"&poiid="+l,n=$("#"+l).attr("data-travelcontentid"),o=b.val(),p=o.match(/-[\d]{1}\b/g);if(null!=p)for(var j=0;j<p.length;j++){var q=p[j].replace("-","-0");o=o.replace(/-[\d]{1}\b/,q)}b.val(o),a.find(".photo_null a").attr("href",writetravelajax.AddPotoUrl+o+"&poicontentid="+n+m+"&dayid="+a.attr("id"));var r=["星期天","星期一","星期二","星期三","星期四","星期五","星期六"],s=new Date(o.replace(/-/g,"/"));b.attr("title",r[s.getDay()]),"0"==INTERFACE.IsCloseDateUpdateTips&&$("#d_prompt").css({width:210,top:g.top-60,left:g.left-14}).html(_alert.data_change_02).fadeIn(300).find(".refresh").attr("href",writetravelajax.LocUrl)}}}).focus(),b.off("focus"),!1}),el.on("blur",".day_date input",function(){$("body").selectable(window.selectable_opt)}),$("#d_prompt").on("click",".close",function(){$(this).parent().fadeOut(300)}),el.on("click",".t_day .t_delete",function(){btnReset(),$("#d_prompt").hide();var a=parentObj($(this));$(".edit_trip").length>1?($("#alert_popup").find("h3").html(_alert.a).end().find("p").html(_alert.at),$("#alert_popup").find(".gsn-btn-2").on("click",function(){INTERFACE.edit_day($.toJSON({ArgType:"2",ScheduleId:a.attr("id").replace("day",""),TravelId:INTERFACE.TravelId})),a.fadeOut(600,function(){a.remove();var b=el.find(".t_photos").length;$("#imagesCount").text(b),$.unknown_photo_num(el)}),$.popupbox.close()})):($("#alert_popup").find("h3").html(_alert.d).end().find("p").html(_alert.dt),$("#alert_popup").find(".gsn-btn-2").val("确定").on("click",function(){$.popupbox.close()}),$("#alert_popup").find(".gsn-btn-6").hide()),$.popupbox.show({id:"alert_popup"})}),el.find(".t_photos .t_delete").on("click",function(){btnReset();var a=$(this).parents(".t_photos");return $("#alert_popup").find("h3").html(_alert.c).end().find("p").hide(),$("#alert_popup").find(".gsn-btn-2").on("click",function(){deleteObj(a,poiChange),$.popupbox.close()}),$.popupbox.show({id:"alert_popup"}),!1}),el.on("click",".poi_dot .t_delete",function(){btnReset();var a=$(this).parent(".poi_dot");return $("#alert_popup").find("h3").html(_alert.b).end().find("p").html(_alert.bt),$("#alert_popup").find(".gsn-btn-2").on("click",function(){deleteObj(a,imgChange),$.popupbox.close()}),$.popupbox.show({id:"alert_popup"}),!1}),el.on("click",".poi_dot .t_edit",function(){return $("#poi_popup").data("edit_day_id",parentObj($(this)).attr("id")),$("#poi_popup").data("poi_id",$(this).parent(".poi_dot").attr("id")).find("h3").html("修改拍摄地点"),$.reset_poi_popup(),$.popupbox.show({id:"poi_popup"}),$("#btnAddPoi").width(450).focus().siblings("span").text($(this).siblings("p").text()).show(),$(".guess_address").find("h4").hide(),!1}),el.on("click",".add_poi",function(){var dayId=parentObj($(this)).attr("id");INTERFACE.guess_new_poi({TravelId:INTERFACE.TravelId,ScheduleId:dayId.replace("day","")},function(data){var dom=[],data=eval(data.Html);if(data){for(var i=0;i<data.length;i++){var title=data[i].name+(null==data[i].districtname?"":" ,"+data[i].districtname),typeName="";switch(data[i].type){case 3:typeName="jingdian";break;case 5:typeName="gouwu";break;case 1:typeName="zhusu";break;case 2:typeName="canyin";break;default:continue}dom.push('<a href="javascript:;" class="'+typeName+'" title="'+title+'" data-id="'+data[i].id+'" data-name="'+data[i].name+'" data-districtid="'+data[i].districtid+'" data-districtname="'+data[i].districtname+'">'+data[i].shortname+"</a>")}$("#poi_popup").find(".guess_address_inner").css("overflow","hidden").append($(dom.join("")))}0==$(".guess_address").find(".jingdian").length&&$(".guess_address").find("h4").hide(),$("#poi_popup").find(".guess_address").css($(".guess_address_inner").height()>120?{"overflow-y":"scroll","overflow-x":"hidden"}:{"overflow-y":"hidden","overflow-x":"hidden"})}),$("#poi_popup").data("edit_day_id",dayId),$("#poi_popup").data("poi_id",!1).find("h3").html("添加拍摄地点"),$.reset_poi_popup(),$.popupbox.show({id:"poi_popup"}),$("#btnAddPoi").width(130).focus()}),$("#add_day").on("click",function(){for(var a=$("#add_day").offset(),b=el.find(".day_date input"),c=0,d=0;d<b.length;d++){var e=new Date($(b[d]).val().replace(/-/g,"/"));e.getFullYear()!=(new Date).getFullYear()||e.getMonth()!=(new Date).getMonth()||e.getDate()!=(new Date).getDate()||(c=1)}return c?($("#d_prompt").css({width:75,top:a.top-48,left:a.left-10}).html(_alert.data_change_03).fadeIn(300),setTimeout(function(){$("#d_prompt").fadeOut(300)},3e3),!1):"0"==$(this).attr("data-submit")?!1:($(this).attr("data-submit","0"),void INTERFACE.date_api($.toJSON({ArgType:"0",TravelId:INTERFACE.TravelId}),function(a){if(null!=a){var b=$(".edit_trip").last().clone();$(".btn_center").before(b.fadeIn(600)),b.attr("id","day"+a.ScheduleId),b.find(".day_num span").html(a.Day),b.find(".day_date input").val(a.DateString).attr("title",a.Week),b.find(".t_photos,.sort_ui").remove(),b.find(".photo_null").html(_alert.phot_02).show(),b.find(".photo_null a").attr("href",writetravelajax.AddPotoUrl+b.find(".day_date input").val()+"&dayid=day"+a.ScheduleId),$("#add_day").attr("data-submit","1")}}))}),$.poi_state=function(a){var b=$("#"+a),c=b.attr("data-travelcontentid"),d=parentObj(b),e=d.find(".photo_null"),f=d.find(".t_photos[data-poi="+a+"]"),g=d.find(".day_date input").val();b.find("b").text(f.length),"1"==b.attr("data-unknown")&&0==f.length&&deleteObj(b,imgChange),0==d.find(".t_photos").length?e.html(_alert.phot_02).show():0==f.length?e.html("1"==b.attr("data-unknown")?_alert.phot_03:_alert.phot_01).show():e.hide(),e.children().is("a")&&e.find("a").attr("href",writetravelajax.AddPotoUrl+g+"&poicontentid="+c+"&poiid="+a+"&dayid="+d.attr("id"))},$.unknown_photo_num=function(a){var b=a.find('.t_photos[data-unknown="1"]').length;$("#unknown_photo").text(b),0==b?$(".det_alert").hide():$(".det_alert").show()};var _poiid=window.location.href.match(/(poiid=){1}\w+/g),poiid=null==_poiid?"":_poiid[0].replace("poiid=","");poiid&&$("#"+poiid).trigger("click")}(jQuery),$(function(){var a=$("#travel_name"),b=($("#len_span span").html(),$(".travel_template"));a.gsInputLen(function(c){var d=c;if(d>=51){var e=$.gsSubstring(a.val(),50,1);a.val(e)}else $("#len_span span").html(d);/\S/g.test(a.val())&&"好名字会让你的游记脱颖而出引人注目"!==a.val()?(b.removeClass("disable"),b.find("a").each(function(){var a=$(this).attr("data-href");$(this).attr("href",a)})):(b.addClass("disable"),b.find("a").removeAttr("href"))}),a.placeholder()});