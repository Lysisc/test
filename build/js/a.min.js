/*! test 2014-05-20 14:33:52 */
/**
 * 图片与poi拖动行为
 */
/* 四舍五入 */
function toFixed(number,fractionDigits){with(Math)return round(number*pow(10,fractionDigits))/pow(10,fractionDigits)}function addCommentTotal(total){var isHost=INTERFACE.isHost,total=total||0;if(isHost){var $span=$(".ctd_data .ctd_georgia.color_05"),text=$span.text();text=total,text>1e5&&(text=toFixed(text/1e5,0)+"<em>万+</em>"),$span.text(text),$span.attr("title",total)}else{var $linkCollect=$(".ctd_controls .link_comment"),$span=$linkCollect.find("span");$span.text(total)}$(".ctd_comments .ctd_comments_title span").html("("+total+")")}/* 评论加1 */
function addCommentNum(){var isHost=INTERFACE.isHost,count=0;if(isHost){var $span=$(".ctd_data .ctd_georgia.color_05"),text=$span.text();count=parseInt($span.attr("title"),10),count=isNaN(count)?0:count,count++,text=count,text>1e5&&(text=toFixed(text/1e5,0)+"<em>万+</em>"),$span.text(text),$span.attr("title",count)}else{var $linkCollect=$(".ctd_controls .link_comment"),$span=$linkCollect.find("span");count=parseInt($span.text(),10),count=isNaN(count)?0:count,count++,$span.text(count)}$(".ctd_comments .ctd_comments_title span").html("("+count+")")}function con_focus(areaObj){var $areaObj=$(areaObj),str=$areaObj.val(),len=str.length;if($areaObj.focus(),document.selection)if($areaObj[0].createTextRange){var textRange=$areaObj[0].createTextRange();textRange.moveStart("character",len),textRange.collapse(),textRange.select()}else $areaObj.focus();else"number"==typeof areaObj.selectionStart&&"number"==typeof areaObj.selectionEnd&&(areaObj.selectionStart=areaObj.selectionEnd=len)}$(function(){//取 day容器id
var curDayid,curPoiId,prePoiId,curPoiIndex,get_day_id=function(obj){return obj.parents(".edit_trip").attr("id")};window.sortable_opt={tolerance:"pointer",items:"> .sort_ui",cursor:"move",delay:100,opacity:.7,placeholder:"poi_highlight",helper:function(event,ui){var on=$(ui).hasClass("on")?"on":"",i_class=$(ui).find("i").attr("class"),p_text=$(ui).find("p").text(),b_text=$(ui).find("b").text();return $('<div id="drag-poi" class="'+on+'"><i class="'+i_class+'"></i><p>'+p_text+"</p><b>"+b_text+'</b><div class="arr_r"></div><div class="arr_t"></div></div>')},start:function(event,ui){curPoiId=$(ui.item).attr("id"),curPoiIndex=$(ui.item).index()},stop:function(event,ui){curPoiIndex!=$("#"+curPoiId).index()&&(//poi排序变动后与后台交互
prePoiId=void 0==$(ui.item).next(".sort_ui").attr("id")?0:$(ui.item).next(".sort_ui").attr("id"),INTERFACE.poi_sort_api($.toJSON({CurrentPoiContentId:$("#"+curPoiId).attr("data-travelcontentid"),PrePoiContentId:$("#"+prePoiId).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId})))}},$(".poi_box").sortable(window.sortable_opt).disableSelection(),//img排序
window.sortable_p_opt={tolerance:"pointer",items:"> .t_photos",cursor:"move",placeholder:"img_highlight",helper:function(event,ui){var num=$(ui).siblings(".t_photos:hidden").removeClass("ui-selected").end().siblings(".ui-selected").add($(ui));return $('<div id="drag-img"><div class="num">'+num.length+' 张</div><div class="mask"></div><img src="'+$(ui).find("img").attr("src")+'" /></div>')},start:function(event,ui){curDayid=get_day_id($(ui.item).addClass("ui-selected").data("one","one"));for(var imgAtt=$("#"+curDayid).find(".ui-selected").attr("data-poi"),imgObj=$("#"+curDayid).find(".t_photos[data-poi="+imgAtt+"]"),temp=[],i=0;i<imgObj.length;i++)temp.push(imgObj.eq(i).attr("data-travelcontentid"));$("#"+curDayid).data("imgAtt",imgAtt),$("#"+curDayid).data("temp",temp),$("#"+curDayid).find(".ui-selected").each(function(){$(ui.item).index()<$(this).index()?$(this).data("index",$(this).index()-1):$(this).data("index",$(this).index())}).find(".t_p_border").addClass("border_ccc")},sort:function(event,ui){"one"==$(ui.item).data("one")&&$(ui.item).removeData("one").siblings(".ui-selected").each(function(){var el=$(this).find("img").hide().clone().addClass("clone_img").show().appendTo("#drag-img");el.css({top:$(this).offset().top-ui.offset.top,left:$(this).offset().left-ui.offset.left})}),$("#drag-img").find(".clone_img").each(function(){$(this).animate({top:0,left:0},300)})},stop:function(event,ui){var curPoiObj=$("#"+curDayid);if(curPoiObj.find(".t_photos img").show().end().find(".t_p_border").removeClass("border_ccc"),fromPoiid)$(ui.item).hide(),$.poi_state(fromPoiid),fromPoiid=!1;else{var after_item=$(ui.item);$(ui.item).siblings(".ui-selected").each(function(){var index_item=$(ui.item).data("index"),index_el=$(this).data("index"),clone_el=$(this).clone(!0).fadeIn(300);index_item>index_el?$(ui.item).before(clone_el):(after_item.after(clone_el),after_item=after_item.next()),$(this).remove()}),curPoiObj.find(".ui-selected").removeClass("ui-selected");for(var imgContentIdArr=[],canInteract=0,imgAtt=curPoiObj.data("imgAtt"),imgObj=curPoiObj.find(".t_photos[data-poi="+imgAtt+"]"),temp=curPoiObj.data("temp"),i=0;i<imgObj.length;i++){var imgObjAttr=imgObj.eq(i).attr("data-travelcontentid");imgContentIdArr.push(imgObjAttr),imgObjAttr!=temp[i]&&(canInteract=1)}canInteract&&INTERFACE.img_addto_poi($.toJSON({//和后台交互
ImageContentId:imgContentIdArr,POIContentId:$("#"+imgAtt).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId}))}}},$(".photo_content").sortable(window.sortable_p_opt).disableSelection(),//图片拖动
// $('.t_photos').draggable({
// 	appendTo: "body",
// 	cursor: 'move',
// 	zIndex: 1000,
// 	helper: function(event, ui) {
// 		var num = $(this).siblings('.t_photos:hidden').removeClass('ui-selected').end().siblings('.ui-selected').add($(this));
// 		return $('<div id="drag-img"><div class="num">' + num.length + ' 张</div><div class="mask"></div><img src="' + $(this).find('img').attr('src') + '" /></div>')
// 	},
// 	start: function(event, ui) {
// 		var that = $(this);
// 		that.css('cursor', 'move');
// 		curDayid = that.parents('.edit_trip').attr('id'); //拖动时记录下父级 dayid
// 		that.addClass('ui-selected').siblings('.ui-selected').each(function() {
// 			var el = $(this).find('img').clone().addClass('clone_img').appendTo('#drag-img');
// 			el.css({
// 				top: $(this).offset().top - that.offset().top,
// 				left: $(this).offset().left - that.offset().left
// 			})
// 		});
// 	},
// 	drag: function(event, ui) {
// 		$('#drag-img').find('.clone_img').each(function() {
// 			$(this).animate({
// 				top: 0,
// 				left: 0
// 			}, 300)
// 		});
// 	},
// 	stop: function(event, ui) {
// 		$('.t_photos').css('cursor', 'pointer');
// 		if (fromPoiid) {
// 			$.poi_state(fromPoiid);
// 			fromPoiid = false;
// 		}
// 	}
// })
//图片选择
window.selectable_opt={filter:".t_photos",cancel:".breadbar, .gs-header, .cui_nav_single, .cui_hd, .footblue, .t_edit, .t_delete, .poi_dot, .photo_null, .add_photo, .t_process, .side_fixed, #add_day, #step3_button, #base_ft, #d_prompt, #poi_popup, .step_tips, .step_tips_box, #gs_operate_right_fix"},$("body").selectable(window.selectable_opt);//需要处理两种情况，一种是拖到POI点，一种拖到page
var fromPoiid;window.imgDrop=function(event,ui){{var imgArr=[],imgObj=$(ui.draggable),imgSib=$(ui.draggable).siblings(".ui-selected"),toPoiid=$(this).attr("id"),//到哪个poi的id
dayid=get_day_id($(this));$("#"+dayid).find(".poi_dot.on").attr("id")}//来源poi的id
//如果 新旧poi 没有变化，不作动作
if(//当前天数下选中的poi点
fromPoiid=imgObj.attr("data-poi"),fromPoiid==toPoiid)return fromPoiid=!1,!1;//批量拖动的数组对象
var img_index=imgObj.index();if(0==imgSib.length)imgArr.push(imgObj);else for(var i=0;i<imgSib.length;i++){var sib_index=imgSib.eq(i).index();sib_index>img_index&&img_index>=0&&(imgArr.push(imgObj),img_index=-1),imgArr.push(imgSib.eq(i)),i==imgSib.length-1&&imgObj.index()>imgSib.eq(imgSib.length-1).index()&&imgArr.push(imgObj)}for(var imgIdAtt=[],i=0;i<imgArr.length;i++){1==$(this).attr("data-unknown")?imgArr[i].attr("data-unknown",1):imgArr[i].removeAttr("data-unknown"),imgArr[i].attr("data-poi",toPoiid).removeClass("ui-selected").hide().find(".t_p_show").hide();var att=imgArr[i].attr("data-travelcontentid");imgIdAtt.push(att)}INTERFACE.img_addto_poi($.toJSON({ImageContentId:imgIdAtt,POIContentId:$("#"+toPoiid).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId})),//显示数字+N
$("#"+toPoiid).attr("data-text","+"+imgIdAtt.length).gspoptext({top:20,time:1500,css:{font:"bold 16px Arial",color:"red"}});//加减数据_需批定天数
var numO=$("#"+fromPoiid).find("b");numO.text(parseInt(numO.text())-imgArr.length);var numN=$("#"+toPoiid).find("b");//跨天POI拖动，需要把图片移到对应的dom节点下
if(numN.text(parseInt(numN.text())+imgArr.length),0==numN.text()&&$.poi_state(toPoiid),curDayid!=dayid){for(var i=0;i<imgArr.length;i++)// $('#' + dayid).find('.photo_null').before(imgArr[i].fadeIn(300))
$("#"+curDayid).find(".t_photos img").show().end().find(".t_p_border").removeClass("border_ccc"),$("#"+dayid).find(".photo_null").before(imgArr[i].clone(!0).fadeIn(300));$("#"+toPoiid).hasClass("on")?$("#"+dayid).find(".photo_null").hide():$("#"+toPoiid).trigger("click")}$.unknown_photo_num($(".t_step_3"))},//移动配置
window.droppable_opt={accept:".t_photos",hoverClass:"over",drop:window.imgDrop},//接收图片的poi点
$(".sort_ui").droppable(droppable_opt),//图片异步加载处理
$("img").lazyload({threshold:300}),$(".step_tips").click(function(){$(".step_tips_box").toggle().find(".step_tips_cont:first").show().siblings(".step_tips_cont").hide(),$.post(INTERFACE.CloseTravelTips,{},function(){})}),$(".step_tips_cont").find("input").click(function(){var parObj=$(this).parent();0==parObj.nextUntil().length?parObj.hide().siblings(".step_tips_cont:first").show():parObj.hide().next(".step_tips_cont").show()})});//回复
var doReply=function(){$(".ctd_comments_box").hover(function(){$(this).find(".ctd_comments_contrl .contrl_01").css("color","#999")},function(){$(this).find(".ctd_comments_contrl .contrl_01").css("color","#f2f2f2")}),$("[data-onsubmit]").each(function(){$(this).data("isOne",0)});var total=1e3;$(".ctd_comments .link_reply").click(function(){if(!$(this).hasClass("a_popup_login")){var $reply=$(this).parent().siblings(".ctd_comments_reply");if($reply.is(":visible"))$reply.slideUp(200);else{$reply.slideDown(200),$reply.find("textarea").val("");var name=$(this).parents(".ctd_comments_box").find(".ctd_comments_username").text();name="@"+$.trim(name)+"\n",$reply.find("textarea").val(name),$reply.find("textarea").data("name",name),con_focus($reply.find("textarea")[0])}}}),$(".ctd_comments .ctd_comments_reply .contrl_01").click(function(){return $(this).parent().slideUp(200),!1}),$(".ctd_comments_reply textarea").each(function(){var $that=$(this);$that.gsInputLen(function(len){var $parent=$that.parents(".ctd_comments_reply"),$len=$parent.find(".word_length"),lastLen=total-len;if(-1>=lastLen){var text=$that.val(),newText=$.gsSubstring(text,total,1);$that.val(newText)}else $len.html(lastLen);$parent.find(".error_tip").hide()})}),$(".ctd_comments_reply .gs_btn_v2").click(function(){var $textArea=$(this).siblings(".textarea").find("textarea"),$errorTip=$(this).siblings(".error_tip");areaVal=$.trim($textArea.val());var name=$.trim($textArea.data("name")),val=areaVal.replace(name,""),type=$textArea.attr("data-referenceCategory")||"",referenceid=$textArea.attr("data-referenceids")||"";val?$(this).gsdisable({callback:function(){INTERFACE.add_comment({TravelId:INTERFACE.TravelId,ReferenceIds:referenceid,ReferenceCategory:type,RemarkContent:encodeURIComponent(areaVal)},function(){addCommentNum()})}}):$errorTip.show()})};$(function(){/*  用cookie保存用户喜欢的状态  */
function save_usernotlogin_like(){"0"==privateObject.CurrentUserId&&$.cookiedb({name:"gs_link_like",value:INTERFACE.TravelId})}/*  判断未登录是否喜欢  */
function find_usernotlogin_like(){if("0"==privateObject.CurrentUserId){var isFind=$.cookiedb({name:"gs_link_like",value:INTERFACE.TravelId,isfind:1});"repeat"==isFind&&($(".float_div .btn_like").addClass("click_like"),$(".ctd_controls .link_like").addClass("click_like"))}}//判断未登录是否喜欢
//抽取公用代码(喜欢)
function linkLikeFN(that){var $that=$(that),$span=$(".ctd_data .color_03"),text=$span.text(),count=parseInt($span.attr("title"),10);count=isNaN(count)?0:count,count++,text=count,text>1e5&&(text=toFixed(text/1e5,0)),$span.text(text),$span.attr("title",count),$that.html("<i></i>已自恋"),$that.attr("title","已自恋")}var isHost=INTERFACE.isHost;//收藏
$(".ctd_controls .link_collect").gsbasecollect({requestFn:function(that){$(".float_div .btn_collect").addClass("click_collect"),INTERFACE.collectRequestFn($(that))}}),//定头部的 收藏
$(".float_div .btn_collect").gsbasecollect({requestFn:function(that){var $linkCollect=$(".ctd_controls .link_collect"),$span=$linkCollect.find("span"),count=parseInt($span.text(),10),count=isNaN(count)?0:count;count++,$span.text(count),$linkCollect.addClass("click_collect"),INTERFACE.collectRequestFn($(that))}}),find_usernotlogin_like(),//喜欢按钮
$(".ctd_controls .link_like").gsbaselike({requestFn:INTERFACE.likeRequestFn,callback:function(that){isHost?(linkLikeFN(that),$(".float_div .btn_like").addClass("click_like_host")):($(".float_div .btn_like").addClass("click_like"),save_usernotlogin_like())}}),//固定头部的 喜欢按钮
$(".float_div .btn_like").gsbaselike({requestFn:INTERFACE.likeRequestFn,callback:function(){var $linkCollect=$(".ctd_controls .link_like");if(isHost)linkLikeFN($linkCollect),$(".float_div .btn_like").addClass("click_like_host");else{var $span=$linkCollect.find("span"),count=parseInt($span.text(),10);count=isNaN(count)?0:count,count++,$linkCollect.html("<i></i>已喜欢<span>"+count+"</span>"),$(".float_div .btn_like").addClass("click_like"),save_usernotlogin_like()}$linkCollect.addClass("click_like")}}),//图片中的喜欢按钮
$(".img_controls .link_like").gsbaselike({requestFn:INTERFACE.likeRequestFn,callback:function(that){var $that=$(that);if(isHost){var $span=$that.find("span"),count=($span.text(),parseInt($span.attr("title"),10));count=isNaN(count)?0:count,count++,$that.html("<i></i>已自恋<span>"+count+"</span>"),$that.attr("title","已自恋")}}}),//分享处理
$(".ctd_controls .link_share").gsbaseshare({api:INTERFACE.ShareUrl,hasCount:!0,callback:function(){if(isHost){var $span=$(".ctd_data .color_04"),text=$span.text(),count=parseInt($span.attr("title"),10);count=isNaN(count)?0:count,count++,text=count,text>1e5&&(text=toFixed(text/1e5,0)),$span.text(text),$span.attr("title",count)}}}),//固定头部的 分享处理
$(".float_div .btn_share").gsbaseshare({api:INTERFACE.ShareUrl,//分享请求连接
fixed:!0,top:50,hasCount:!1,callback:function(){if(isHost){var $span=$(".ctd_data .color_04"),text=$span.text(),count=parseInt($span.attr("title"),10);count=isNaN(count)?0:count,count++,text=count,text>1e5&&(text=toFixed(text/1e5,0)),$span.text(text),$span.attr("title",count)}else{var $count=$(".ctd_controls .link_share span"),count=parseInt($count.text(),10);count=isNaN(count)?0:count,count++,$count.text(count)}}}),$(".img_controls .link_share").gsbaseshare({api:INTERFACE.ShareUrl});//hover图片显示
var fateOutTimer=null;$(".ctd_main").on("mouseenter",".img",function(){var $this=$(this).data("isOver",1),ch=$this.find(".img_controls"),widthSub=($this.outerWidth()-$this.find("img").outerWidth())/2;widthSub>267?ch.css("visibility","hidden"):ch.css("visibility","visible").fadeIn("fast"),//获取图片宽度
ch.fadeIn("fast"),$("#bdshare").hover(function(){$this.data("isOver",0)},function(){$this.data("isOver",1)})}),$(".ctd_main").on("mouseleave",".img",function(){function fadeOut(){1==$this.data("isOver")&&$this.children(".img_controls").fadeOut("fast")}clearTimeout(fateOutTimer);var $this=$(this);fateOutTimer=setTimeout(fadeOut,50)})}),//评论代码
$(function(){//发表点评
!function(){var $publishTextArea=$("#report_area"),$errorTip=$publishTextArea.parents(".textarea_box").find(".error_tip");total=1e3,//初始化时置为空	
$publishTextArea.val(""),$publishTextArea.placeholder(),$publishTextArea.focus(function(){$errorTip.hide()});var $wordLength=$publishTextArea.next(".ctd_comments_tip").find("em.word_length");$publishTextArea.gsInputLen(function(len){//复制状态态的倒计时会不准
var lastLen=total-len;if(-1>=lastLen){var text=$publishTextArea.val(),newText=$.gsSubstring(text,total,1);$publishTextArea.val(newText),$wordLength.text(total)}else $wordLength.text(len);$(".reportmain").find(".gsn-tiptext").show(),$(".reportmain").find(".journal-comment-tip").hide()}),$(".float_div .btn_comment").add(".ctd_controls .link_comment").click(function(){var top=$(".ctd_comments").offset().top-55;$("body,html").animate({scrollTop:top},500,function(){con_focus($publishTextArea[0])})}),$(".ctd_comments_box .btn_publish").click(function(){if(!$(this).hasClass("a_popup_login")){var val=$publishTextArea.val();if(val=$.trim(val),val=val.replace("Hi，楼主等你的回复呢~","")){var type=$publishTextArea.attr("data-referencecategory")||"",referenceid=$publishTextArea.attr("data-referenceids")||"";$(this).gsdisable({disable:"gs_btn_v2_gray",text:'<img class="btn_ajax" src="http://youresource.c-ctrip.com/img/load.gif" />提交中...',callback:function(){INTERFACE.add_comment({TravelId:INTERFACE.TravelId,ReferenceIds:referenceid,ReferenceCategory:type,RemarkContent:encodeURIComponent(val)},function(){addCommentNum(),$publishTextArea.val(""),$wordLength.text("0")})}})}else $errorTip.show()}})}(),//图片上的引用到评论
function(){var $picComment=$("#picComment"),$pic_content=$("#pic_content"),type="",referenceid="",$total=$picComment.find(".count"),total=parseInt($total.text(),10);$(".img_controls .link_comment").click(function(){if($picComment.find(".gsn-tiptext").show(),$picComment.find(".journal-comment-tip").hide(),$pic_content.click(),!$(this).hasClass("a_popup_login")){$.popupbox.show({id:"picComment"}),type=$(this).attr("data-referenceCategory")||"",referenceid=$(this).attr("data-referenceids")||"";var replyName=$("#authorDisplayName").html();replyName=$.trim(replyName);var strFormat="引用 @"+replyName+" 的照片\n";$pic_content.val(strFormat)}con_focus($pic_content[0])}),$pic_content.gsInputLen(function(len){//复制状态态的倒计时会不准
var lastLen=total-len;if(-1>=lastLen){var text=$pic_content.val(),newText=$.gsSubstring(text,total,1);$pic_content.val(newText)}else $total.html(lastLen);$picComment.find(".gsn-tiptext").show(),$picComment.find(".journal-comment-tip").hide()}),$picComment.on("click",".close, .gsn-btn-6",function(){$total.text(total),$pic_content.val(""),$.popupbox.close()}),$picComment.on("click",".gsn-btn-2",function(){var areaVal=$pic_content.val();areaVal=$.trim(areaVal),areaVal?($picComment.find(".gsn-tiptext").show(),$picComment.find(".journal-comment-tip").hide(),$(this).gsdisable({callback:function(){INTERFACE.add_comment({TravelId:INTERFACE.TravelId,ReferenceIds:referenceid,ReferenceCategory:type,RemarkContent:encodeURIComponent(areaVal)},function(){addCommentNum(),$total.text(total),$pic_content.val(""),$.popupbox.close()})}})):($picComment.find(".gsn-tiptext").hide(),$picComment.find(".journal-comment-tip").show())})}()}),/**
 * 增加POI弹出层相关js
 * @type {Object}
 */
function($){function getjson(key){//拿搜索数据
var key=GS.xssFilter(key);$.getJSON(searchAPI,{para:escape($.trim(key))},function(d){if(0==d.success){var data=d.list,html=[];for(i in data){var _data=null==data[i].districtname?"":" ,"+data[i].districtname,_addr=null==data[i].Address?"":data[i].Address;html.push('<a href="javascript:;" data-id="'+data[i].id+'" poi-type="'+data[i].type+'" data-name="'+data[i].name+'" data-districtid="'+data[i].districtid+'" data-districtname="'+data[i].districtname+'">'+data[i].name.replace(key,"<b>"+key+"</b>")+_data+'<span class="addr">'+_addr+"</span></a>")}$(".select_address_inner").html("").append($(html.join(""))),$(".select_address_inner").find("a:first").addClass("on"),$(".select_address_inner").on("mouseover","a",function(){return $(this).addClass("on").siblings("a").removeClass("on"),!1}),selectPOI(),selectPOI_nodata(key)}poi_popup.find(".select_address").css($(".select_address_inner").height()>120?{//滚动条判断
"overflow-y":"scroll","overflow-x":"hidden"}:{"overflow-y":"hidden","overflow-x":"hidden"})})}function selectPOI_nodata(text){//无数据时显示创建新地址
poi_popup.find(".c_address").show();var html='<a class="c_address" href="javascript:;">+ 没有可选的地点，点击创建“<span>'+text+"</span>”</a>",me=poi_popup.find(".select_address");"one"!=me.data("one")?me.append($(html)).data("one","one"):me.find(".c_address").show().find("span").html(text)}function selectPOI(){//建立搜索的POI点
poi_popup.find(".select_address_inner a[data-id]").on("click",function(){var dataName=$.trim($(this).attr("data-name")),districtid=$(this).attr("data-districtid"),districtname="null"==$(this).attr("data-districtname")?null:$(this).attr("data-districtname"),caseNum=$(this).attr("poi-type");if("1"!=caseNum&&"2"!=caseNum&&"3"!=caseNum&&"5"!=caseNum&&"4"!=caseNum)$.ajax({url:INTERFACE.custom_tags_url,type:"POST",async:!1,dataType:"json",data:$.toJSON({TravelId:INTERFACE.TravelId,POIName:encodeURIComponent(dataName),POIType:poiType(),POITypeId:99}),success:function(responseText){var dataId=responseText.Data;setPOI(dataId,poiType(),dataName,!0,districtid,districtname)}});else{var dataId=$(this).attr("data-id"),_poiType="4"==caseNum?"destination":poiType();setPOI(dataId,_poiType,dataName,!1,districtid,districtname)}$(this).remove(),poi_popup.find(".select_address").hide().siblings(".guess_address").show()})}function poiType(obj){//获取当前拍摄地type
var type=obj?obj.attr("class"):poi_popup.find(".over i").attr("class");return poi_popup.data("type",searchType[type]),poi_popup.data("type")}function setPOI(dataId,dataType,dataName,customDefinition,districtid,districtname){if(//生成poi标签
poi_popup.find(".fr span").hide(),$("#poi_popup").data("poi_id"))//修改poi
$("#btnAddPoi").val(dataName).data("data",{dataId:dataId,dataType:dataType,dataName:dataName,customDefinition:customDefinition,districtid:districtid,districtname:districtname});else{var html=$('<div class="poi" poi-id="'+dataId+'" poi-type="'+dataType+'" poi-name="'+dataName+'" poi-custom="'+customDefinition+'" data-districtid="'+districtid+'" data-districtname="'+districtname+'"><a href="javascript:void(0);"></a>'+dataName+"</div>\r\n");$(".btnAddPoi").before(html.fadeIn(600)),$("#btnAddPoi").val("").focus().siblings("span").show()}}var poi_popup=$("#poi_popup"),searchAPI=$("#gs_search").val(),searchType={//搜索接口类型
jingdian:"sight",//景点
gouwu:"shopping",//购物
zhusu:"hotel",//酒店
canyin:"restuarant"};poi_popup.on("click","a.close",function(){//关闭弹出层
$.popupbox.close(),searchAPI=searchAPI.replace(/sight|shopping|hotel|restuarant$/,"sight"),poi_popup.find(".poi").remove(),poi_popup.find(".select_address_inner").html(""),poi_popup.find(".fr span").hide(),$("#btnAddPoi").val("")}),poi_popup.on("click",".tab a",function(){//tab切换
searchAPI=searchAPI.replace(/sight|shopping|hotel|restuarant$/,poiType($(this).find("i"))),$(this).addClass("over").siblings().removeClass("over"),poi_popup.find(".guess_address_inner a").hide();var guess_poi=poi_popup.find(".guess_address_inner a."+$(this).find("i").attr("class"));0==guess_poi.length?poi_popup.find("h4").hide():(poi_popup.find("h4").show(),guess_poi.show()),poi_popup.find(".tab_arr").animate({left:125*$(this).index()},600),poi_popup.find(".select_address").hide().siblings(".guess_address").show(),poi_popup.find(".c_address").hide(),poi_popup.find(".btnAddPoi span").show(),$("#btnAddPoi").removeData("data").val("").focus()}),poi_popup.on("click",".guess_address a",function(){for(var oldPoi=poi_popup.find(".poi_address .poi"),i=0;i<oldPoi.length;i++)if(oldPoi.eq(i).attr("poi-id")==$(this).attr("data-id"))return $("#btnAddPoi").focus(),!1;var dataId=$(this).attr("data-id"),dataType=poiType($(this)),dataName=$.trim($(this).attr("data-name")),districtid=$(this).attr("data-districtid"),districtname="null"==$(this).attr("data-districtname")?null:$(this).attr("data-districtname");setPOI(dataId,dataType,dataName,!1,districtid,districtname),$(this).addClass("on")}),poi_popup.on("keyup paste","#btnAddPoi",function(e){//快搜
var eventObj=function(){var key=$("#btnAddPoi").removeData("data").val();""!=key?(getjson(key),$("#btnAddPoi").siblings("span").hide(),poi_popup.find(".select_address").show().siblings(".guess_address").hide()):($("#btnAddPoi").siblings("span").show(),poi_popup.find(".select_address").hide().siblings(".guess_address").show())};"keyup"==e.type?eventObj():setTimeout(eventObj,100)}),poi_popup.on("click",".c_address",function(){//建立自定义POI点
var v=$(this).hide().find("span").text();INTERFACE.custom_tags($.toJSON({TravelId:INTERFACE.TravelId,POIName:encodeURIComponent(v),POIType:poiType()}),function(data){var dataName=$(".c_address").find("span").text().replace(/"/g,"&quot;");setPOI(data.Data,poiType(),dataName,!0,null,null)}),poi_popup.find(".select_address").hide().siblings(".guess_address").show()}),poi_popup.on("click",".poi a",function(){for(var poi_id=$(this).parent().attr("poi-id"),guess_poi=poi_popup.find(".guess_address_inner a"),i=0;i<guess_poi.length;i++)guess_poi.eq(i).attr("data-id")==poi_id&&guess_poi.eq(i).removeClass("on");$(this).parent().remove(),$("#btnAddPoi").focus()}),poi_popup.on("click",".gsn-btn-2",function(){//完成按钮
var edit_day_id=$("#poi_popup").data("edit_day_id"),poi_id=$("#poi_popup").data("poi_id");//修改poi
if(poi_id){if(""!=$("#btnAddPoi").val()){var poiData=$("#btnAddPoi").data("data");if(void 0==poiData)return poi_popup.find(".fr span").html("请从下拉提示中选中拍摄地点").show(),$("#btnAddPoi").focus(),!1;$.popupbox.close();var POIInfo={POIId:poiData.dataId,POIType:poiData.dataType,POIName:encodeURIComponent(poiData.dataName),IsCustomDefinition:poiData.customDefinition,DistrictId:poiData.districtid,DistrictName:encodeURIComponent(poiData.districtname)};INTERFACE.editor_poi($.toJSON({POIInfo:POIInfo,ContentId:$("#"+poi_id).attr("data-travelcontentid"),TravelId:INTERFACE.TravelId}));var title=poiData.dataName+(null==poiData.districtname?"":" ,"+poiData.districtname),type="";switch(poiData.dataType){case"sight":type="jingdian";break;case"destination":type="jingdian";break;case"shopping":type="gouwu";break;case"hotel":type="zhusu";break;case"restuarant":type="canyin"}poi_popup.find(".fr span").hide(),$("#"+poi_id).removeAttr("data-unknown").attr("title",title).find("p").text(poiData.dataName).siblings("i").attr("class",type);var poi_img=$("#"+edit_day_id).find('.t_photos[data-poi="'+poi_id+'"][data-unknown="1"]'),inputVal=$("#"+edit_day_id).find(".day_date input").val(),poicontentid=$("#"+poi_id).attr("data-travelcontentid");0!=poi_img.length?(poi_img.removeAttr("data-unknown"),$.unknown_photo_num($(".t_step_3"))):($("#"+edit_day_id).find(".photo_null").html(0!=$("#"+edit_day_id).find(".t_photos").length?'<i></i><span>请拖动照片进行关联，或</span><a href="#">添加照片</a>':'<i></i><span>这一天没有照片，请</span><a href="#">添加照片</a>'),$("#"+edit_day_id).find(".photo_null a").attr("href",writetravelajax.AddPotoUrl+inputVal+"&poicontentid="+poicontentid+"&poiid="+poi_id+"&dayid="+edit_day_id))}else poi_popup.find(".fr span").html("拍摄地点不能为空").show(),$("#btnAddPoi").focus();return $("#btnAddPoi").removeData("data")}//添加poi
var PoiList=[];poi_popup.find(".poi").each(function(){var poiArg={POIId:$(this).attr("poi-id"),POIType:$(this).attr("poi-type"),POIName:encodeURIComponent($(this).attr("poi-name")),IsCustomDefinition:$(this).attr("poi-custom"),DistrictId:$(this).attr("data-districtid"),DistrictName:encodeURIComponent($(this).attr("data-districtname"))};PoiList.push(poiArg)}),PoiList[0]?($.popupbox.close(),searchAPI=searchAPI.replace(/sight|shopping|hotel|restuarant$/,"sight"),INTERFACE.add_new_poi($.toJSON({PoiList:PoiList,ScheduleId:edit_day_id.replace("day",""),TravelId:INTERFACE.TravelId}),function(data){var data=eval(data),dom=[];if(data){for(var i=0;i<data.length;i++){var typeName="";switch(data[i].PoiInfo.POIType){case 3:typeName="jingdian";break;case 4:typeName="jingdian";break;case 5:typeName="gouwu";break;case 1:typeName="zhusu";break;case 2:typeName="canyin"}dom.push('<div id="'+data[i].PoiInfo.TravelPOIId+'" class="poi_dot sort_ui" data-text="+1" data-travelcontentid="'+data[i].TravelContentId+'" title="'+data[i].PoiInfo.POIName+(null==data[i].PoiInfo.DistrictName?"":" ,"+data[i].PoiInfo.DistrictName)+'">'),dom.push('<i class="'+typeName+'"></i>'),dom.push("<p>"+data[i].PoiInfo.POIName+"</p>"),dom.push("<b>0</b>"),dom.push('<a class="t_edit" title="修改拍摄地点" href="javascript:void(0);"></a>'),dom.push('<a class="t_delete" title="删除" href="javascript:void(0);"></a>'),dom.push('<div class="arr_r"></div>'),dom.push("</div>")}var edit_day_id=$("#poi_popup").data("edit_day_id"),dayFrame=$("#"+edit_day_id);dayFrame.find(".add_poi").before($(dom.join("")).fadeIn(600)),dayFrame.find(".sort_ui").droppable(window.droppable_opt),dayFrame.find(".poi_box").sortable(window.sortable_opt).disableSelection()}else alert("错误异常")})):poi_popup.find(".fr span").html(""!=$("#btnAddPoi").focus().val()?"请从下拉提示中选中拍摄地点":"请先添加拍摄地点").show()}),$.reset_poi_popup=function(){//重置弹出层
poi_popup.find(".select_address").hide().siblings(".guess_address").show().find("h4").show(),poi_popup.find(".tab a").eq(0).addClass("over").siblings().removeClass("over"),poi_popup.find(".select_address_inner,.guess_address_inner").html(""),poi_popup.find(".tab_arr").css("left",0),poi_popup.find(".c_address").hide(),poi_popup.find(".poi").remove(),$("#btnAddPoi").removeData("data").val("").siblings("span").text("可添加多个拍摄地点").show()}}(jQuery);
/*! test 最后修改于： 2014-05-20 14:33:52 */